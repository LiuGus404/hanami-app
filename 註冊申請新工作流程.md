# 註冊申請新工作流程

## 🎯 **新的處理流程**

### 📋 **工作流程概述**

1. **用戶提交註冊申請** → 存儲在 `registration_requests` 表
2. **管理員審核** → 在權限管理系統的「用戶申請」標籤中查看
3. **批准流程** → 創建用戶權限 → 刪除註冊申請
4. **拒絕流程** → 直接刪除註冊申請

---

## 🔄 **詳細流程**

### ✅ **批准申請流程**

```
用戶申請 → 管理員點擊「批准並創建權限」 → 
1. 創建用戶權限記錄 (hanami_user_permissions_v2)
2. 刪除註冊申請記錄 (registration_requests)
3. 用戶出現在「🔐用戶權限」標籤中
```

**操作步驟**:
1. 管理員在「用戶申請」標籤中查看待審核的註冊申請
2. 點擊「批准並創建權限」按鈕
3. 系統自動：
   - 獲取或創建對應的角色
   - 在 `hanami_user_permissions_v2` 表中創建新的用戶權限記錄
   - 從 `registration_requests` 表中刪除該申請
   - 刷新申請列表

### ❌ **拒絕申請流程**

```
用戶申請 → 管理員點擊「拒絕並刪除」 → 
1. 輸入拒絕原因
2. 直接刪除註冊申請記錄 (registration_requests)
3. 申請從列表中消失
```

**操作步驟**:
1. 管理員在「用戶申請」標籤中查看待審核的註冊申請
2. 點擊「拒絕並刪除」按鈕
3. 系統彈出提示框要求輸入拒絕原因
4. 系統自動：
   - 從 `registration_requests` 表中刪除該申請
   - 刷新申請列表

---

## 🗂️ **數據流向**

### 📊 **表結構關係**

```
registration_requests (註冊申請表)
├── 用戶提交的原始申請數據
├── 包含：email, full_name, phone, role, additional_info
└── 狀態：pending (待審核)

hanami_user_permissions_v2 (用戶權限表)
├── 批准後的用戶權限記錄
├── 包含：user_email, role_id, status, permissions
└── 狀態：approved (已批准)

hanami_roles (角色表)
├── 系統角色定義
├── 包含：role_name, display_name, permissions
└── 預設：admin, teacher, parent
```

### 🔄 **數據轉換**

**批准時的數據轉換**:
```typescript
// 從註冊申請到用戶權限
registration_requests → hanami_user_permissions_v2
{
  email: "user@example.com",
  full_name: "用戶姓名",
  phone: "12345678",
  role: "teacher",
  additional_info: {...}
}
↓
{
  user_email: "user@example.com",
  user_phone: "12345678",
  role_id: "teacher-role-uuid",
  status: "approved",
  is_active: true
}
```

---

## 🎨 **用戶界面更新**

### 📱 **按鈕文字更新**

- **舊按鈕**: "批准" / "拒絕"
- **新按鈕**: "批准並創建權限" / "拒絕並刪除"

### 📋 **界面流程**

1. **用戶申請標籤**:
   - 顯示所有待審核的註冊申請
   - 每個申請顯示：姓名、郵箱、電話、申請角色、附加信息
   - 操作按鈕：批准並創建權限 / 拒絕並刪除

2. **用戶權限標籤**:
   - 顯示所有已批准的用戶權限
   - 包含：郵箱、角色、狀態、批准時間
   - 操作按鈕：編輯權限

---

## 🔧 **技術實現**

### 🛠️ **API 端點**

```typescript
// 刪除註冊申請
DELETE /api/registration-requests?id={requestId}

// 創建用戶權限
POST /api/permissions
{
  action: "create_user_permission",
  data: {
    user_email: string,
    user_phone: string,
    role_id: string,
    status: "approved",
    is_active: true
  }
}
```

### 🔄 **前端邏輯**

```typescript
// 批准流程
if (status === 'approved') {
  // 1. 創建用戶權限
  await createUserPermissionsFromRequest(request);
  // 2. 刪除註冊申請
  await deleteRegistrationRequest(requestId);
}

// 拒絕流程
if (status === 'rejected') {
  // 直接刪除註冊申請
  await deleteRegistrationRequest(requestId);
}
```

---

## ✅ **優勢**

### 🎯 **流程優化**
1. **簡化操作**: 一次點擊完成整個審核流程
2. **數據清理**: 自動清理已處理的申請，保持列表整潔
3. **權限管理**: 批准的用戶直接出現在權限管理系統中

### 📊 **數據管理**
1. **避免重複**: 不會在兩個表中保留相同數據
2. **狀態清晰**: 申請處理後立即從待審核列表移除
3. **權限統一**: 所有用戶權限統一在一個表中管理

### 🎨 **用戶體驗**
1. **操作明確**: 按鈕文字清楚說明操作結果
2. **即時反饋**: 操作完成後立即更新界面
3. **流程順暢**: 從申請到權限的完整流程

---

## 🚨 **注意事項**

### ⚠️ **重要提醒**
1. **刪除操作不可逆**: 拒絕後申請會被永久刪除
2. **權限創建**: 批准後會自動創建對應角色的權限
3. **數據備份**: 建議定期備份 `registration_requests` 表

### 🔒 **安全考慮**
1. **權限驗證**: 只有管理員可以執行審核操作
2. **日誌記錄**: 所有操作都有詳細的日誌記錄
3. **錯誤處理**: 完善的錯誤處理和用戶提示

---

## 📈 **後續改進**

### 🔮 **未來功能**
1. **批量操作**: 支持批量批准/拒絕多個申請
2. **郵件通知**: 自動發送審核結果郵件給申請者
3. **審核歷史**: 保留審核歷史記錄
4. **自定義權限**: 允許管理員自定義用戶權限

---

**最後更新**: 2024-12-19  
**版本**: 2.0.0 
 