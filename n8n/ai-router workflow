{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ingress",
        "authentication": "jwtAuth",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -368,
        896
      ],
      "id": "8785957c-41e9-42dc-b80e-7e87ab6f8fb7",
      "name": "AiReciever",
      "webhookId": "356e95d5-dcc9-44d8-b988-0f2f0bb2414f",
      "credentials": {
        "jwtAuth": {
          "id": "5tFZ5ySabMadgSCE",
          "name": "JWTHANAMIECHO"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"ok\": false,\n  \"code\": 404,\n  \"error\": \"MESSAGE_NOT_FOUND\",\n  \"message\": \"訊息不存在於資料庫\",\n  \"details\": {\n    \"client_msg_id\": \"={{ $('Format_Input1').first().json.client_msg_id }}\",\n    \"thread_id\": \"={{ $('Format_Input1').first().json.thread_id }}\"\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        880,
        1168
      ],
      "id": "5639d99e-0bd9-4c3b-bd44-69cd985ce635",
      "name": "RespondMessageNotFound"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "515655f9-5caf-45ef-b69d-ab388a77e8c4",
              "leftValue": "={{$('CheckMessage').first().json.id}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        688,
        912
      ],
      "id": "3906d97e-063c-427b-8159-4cc55aad938f",
      "name": "CheckMessageExists"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.response200_payload }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        4768,
        752
      ],
      "id": "88489327-f0e1-4df1-b5a5-093590cc1d7f",
      "name": "BuildResponse200"
    },
    {
      "parameters": {
        "jsCode": "const response = {\n  ok: true,\n  code: 200,\n  data: {\n    thread_id: $('CollectMessageFields1').first().json.thread_id,\n    message_id: $('InsertAssistantMessage2').first().json.id,\n    client_msg_id: $('Format_Input1').first().json.client_msg_id + ':assistant',\n    content: $('FormatOutput2').first().json.assistant_content,\n    model: $('FormatOutput2').first().json.model,\n    provider: $('FormatOutput2').first().json.provider,\n    usage: $('FormatOutput2').first().json.usage,\n    food: $('FormatOutput2').first().json.food,\n    balance_after: $('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.balance_after || null,\n    tx_id: $('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.tx_id || null\n  }\n};\n\nreturn [{ json: { response200_payload: response } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4576,
        752
      ],
      "id": "3219e671-da8b-4f1d-9178-0eb76fab386f",
      "name": "FixJSONResponse2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7dd3096d-4ca2-4dee-aede-cc41f9d391a5",
              "name": "response200_payload",
              "value": "={{ ({ ok: true, code: 200, data: { thread_id: $('CollectMessageFields1').first().json.thread_id, message_id: $('InsertAssistantMessage2').first().json.id, client_msg_id: $('Format_Input1').first().json.client_msg_id + ':assistant', content: $('FormatOutput2').first().json.assistant_content, model: $('FormatOutput2').first().json.model, provider: $('FormatOutput2').first().json.provider, usage: $('FormatOutput2').first().json.usage, food: $('FormatOutput2').first().json.food, balance_after: ($('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.balance_after ?? null), tx_id: ($('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.tx_id ?? null) } }) }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4368,
        752
      ],
      "id": "78d8304a-45e1-4aac-ad62-f8052a002a5d",
      "name": "200FormatError2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.message_costs\n  (message_id, thread_id, user_id,\n   input_tokens, output_tokens, total_tokens,\n   model_provider, model_name,\n   total_cost_usd, food_amount, created_at)\nVALUES\n  (($1)::uuid, ($2)::uuid, ($3)::uuid,\n   $4, $5, $6,\n   $7, $8,\n   0, $9, now())\nRETURNING id;",
        "options": {
          "queryReplacement": "=$1 = {{ $('InsertAssistantMessage2').first().json.id }}, $2 = {{ $('CollectMessageFields1').first().json.thread_id }}, $3 = {{ $('CollectMessageFields1').first().json.user_id }}, $4 = {{ $('FormatOutput2').first().json.usage.input_tokens }}, $5 = {{ $('FormatOutput2').first().json.usage.output_tokens }}, $6 = {{ $('FormatOutput2').first().json.usage.total_tokens }}, $7 = {{ JSON.stringify($('FormatOutput2').first().json.provider) }}, $8 = {{ JSON.stringify($('FormatOutput2').first().json.model) }}, $9 = {{ $('FormatOutput2').first().json.food.total_food_cost }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3904,
        752
      ],
      "id": "f9bee654-f21f-446d-9257-b2e4c2bae655",
      "name": "InsertMessageCosts2",
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH upd AS (\n  UPDATE public.user_food_balance\n  SET current_balance = current_balance - $2,\n      total_spent = total_spent + $2,\n      updated_at = now()\n  WHERE user_id = ($1)::uuid\n  RETURNING current_balance\n),\nins AS (\n  INSERT INTO public.food_transactions\n    (user_id, transaction_type, amount, balance_after, message_id, thread_id, description, created_at)\n  SELECT\n    ($1)::uuid, 'spend', $2, u.current_balance, ($3)::uuid, ($4)::uuid, $5, now()\n  FROM upd u\n  RETURNING id\n)\nSELECT\n  (SELECT current_balance FROM upd) AS balance_after,\n  (SELECT id FROM ins) AS tx_id;",
        "options": {
          "queryReplacement": "=$1 = {{ $('CollectMessageFields1').first().json.user_id }}, $2 = {{ $('FormatOutput2').first().json.food.total_food_cost }}, $3 = {{ $('InsertAssistantMessage2').first().json.id }}, $4 = {{ $('CollectMessageFields1').first().json.thread_id }}, $5 = {{ JSON.stringify(`LLM spend: ${$('FormatOutput2').first().json.model} (in=${$('FormatOutput2').first().json.usage.input_tokens}, out=${$('FormatOutput2').first().json.usage.output_tokens}, chars=${$('FormatOutput2').first().json.food.output_chars})`) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3616,
        752
      ],
      "id": "7a7bbd74-f5e6-46d3-97a1-c0e8ad4a01c2",
      "name": "SpendFoodAndTx2",
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.chat_messages\nSET\n  status = 'completed',\n  updated_at = now(),\n  content_json = COALESCE(NULLIF(content_json, '{}'::jsonb), '{}'::jsonb) || $2::jsonb\nWHERE id = ($1)::uuid\nRETURNING id;",
        "options": {
          "queryReplacement": "=$1 = {{ $('CheckMessage').first().json.id }}, $2 = {{ JSON.stringify({ assistant_message_id: $('InsertAssistantMessage2').first().json.id, finish_reason: $('FormatOutput2').first().json.finish_reason, usage: $('FormatOutput2').first().json.usage, food: $('FormatOutput2').first().json.food }) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4160,
        752
      ],
      "id": "af01c9dd-1bbb-4b12-a0c6-dd360bea4eff",
      "name": "MarkUserMsgCompleted2",
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.chat_messages\n  (thread_id, role, message_type, content, status, client_msg_id, parent_id, content_json, created_at, updated_at)\nVALUES\n  (($1)::uuid, 'assistant', 'final', $2, 'completed', $3, ($4)::uuid, $5::jsonb, now(), now())\nRETURNING id;",
        "options": {
          "queryReplacement": "=$1 = {{ $json.thread_id }}, $2 = {{ $json.assistant_content }}, $3 = {{ $json.client_msg_id_asst }}, $4 = {{ $json.user_message_id }}, $5 = {{ JSON.stringify($json.meta) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3360,
        752
      ],
      "id": "f6a02da0-3fdd-43f2-b504-47b42687a1ce",
      "name": "InsertAssistantMessage2",
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const resp = $json;\nconst choice = resp?.choices?.[0] || {};\nconst msg = choice?.message || {};\nconst content = (msg.content || '').trim();\n\nfunction countChars(s){ return (s||'').match(/\\S/g)?.length ?? 0; }\n\nconst input_tokens = Number(resp?.usage?.prompt_tokens || 0);\nconst output_tokens = Number(resp?.usage?.completion_tokens || 0);\nconst total_tokens = Number(resp?.usage?.total_tokens || (input_tokens + output_tokens));\n\nconst provider = resp?.provider || 'openai';\nconst model = resp?.model || $('BuildMessages2').first().json?.model || $('Format_Input1').first().json?.selected_role?.model || 'unknown';\n\nconst CHARS_PER_FOOD = parseInt($env.CHARS_PER_FOOD || '100', 10);\n\nconst input_chars = Number($('Estimate&GateBudget2').first().json?.input_chars || 0);\nconst input_food_cost = input_chars > 0 ? Math.ceil(input_chars / CHARS_PER_FOOD) : 0;\n\nconst output_chars = countChars(content);\nconst output_food_cost = output_chars > 0 ? Math.ceil(output_chars / CHARS_PER_FOOD) : 0;\n\nconst total_food_cost = input_food_cost + output_food_cost;\n\n// ⭐ 修復：直接從 Format_Input1 獲取 thread_id 和 user_id\nconst thread_id = $('Format_Input1').first().json.thread_id || $('Format_Input1').first().json.room_id;\nconst user_id = $('Format_Input1').first().json.user_id;\nconst user_message_id = $('CheckMessage').first().json.id;\nconst client_msg_id = $('Format_Input1').first().json.client_msg_id;\n\nconst openrouter_id = $('OpenRouterAI2').first().json?.id || null;\nconst client_msg_id_asst = openrouter_id || (client_msg_id ? `${client_msg_id}:assistant` : `asst-${$now}`);\n\nconst meta = {\n  provider,\n  model,\n  usage: { input_tokens, output_tokens, total_tokens },\n  food: {\n    CHARS_PER_FOOD,\n    input_chars, output_chars,\n    input_food_cost, output_food_cost, total_food_cost,\n    remain_before: Number($('Estimate&GateBudget2').first().json?.remain_food || 0)\n  },\n  openrouter_id,\n  parent_id: user_message_id,\n  source: 'n8n/openrouter'\n};\n\nreturn [{\n  json: {\n    assistant_content: content,\n    provider, model,\n    finish_reason: choice?.finish_reason || 'stop',\n    usage: { input_tokens, output_tokens, total_tokens },\n    food: meta.food,\n    thread_id, user_id, user_message_id, client_msg_id,\n    client_msg_id_asst,\n    meta\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3136,
        752
      ],
      "id": "e8f42fc8-459e-45e4-ac79-7209b708c098",
      "name": "FormatOutput2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2880,
        752
      ],
      "id": "d964f1ad-672a-4433-9c26-948f26122aea",
      "name": "OpenRouterAI2",
      "retryOnFail": true,
      "maxTries": 5,
      "credentials": {
        "openRouterApi": {
          "id": "vvJa75RZf9KwdDR5",
          "name": "AIResearch"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = Array.isArray($json.input) ? $json.input : (Array.isArray(items) ? items.map(i => i.json) : []);\n\nfunction stripLinks(s = \"\") {\n  s = String(s);\n  s = s.replace(/!\\[([^\\]]*)\\]\\((https?:\\/\\/[^\\s)]+)\\)/g, (_, alt) => (alt ? `${alt}（連結）` : \"連結\"));\n  s = s.replace(/\\[([^\\]]+)\\]\\((https?:\\/\\/[^\\s)]+)\\)/g, (_, text) => (text ? `${text}（連結）` : \"連結\"));\n  s = s.replace(/https?:\\/\\/[^\\s)]+/g, \"連結\");\n  return s.trim();\n}\n\nconst pickTime = (m) => m.timestamp || m.created_at || \"\";\nconst pickRole = (m) => (m?.content_json?.role_name) || m.sender || \"unknown\";\nconst pickContent = (m) => stripLinks(m.message_content ?? \"\");\n\nconst messages = input\n  .map(m => ({\n    time: pickTime(m),\n    role_name: pickRole(m),\n    content: pickContent(m),\n  }))\n  .filter(x => x.time && x.content);\n\nmessages.sort((a, b) => new Date(a.time) - new Date(b.time));\n\nfunction toDateKey(t) {\n  const d = new Date(t);\n  if (!isNaN(d)) return d.toISOString().slice(0, 10);\n  return (t.includes(\" \") ? t.split(\" \")[0] : String(t).slice(0, 10));\n}\n\nfunction toTimeOnly(t) {\n  const d = new Date(t);\n  if (!isNaN(d)) return d.toISOString().slice(11, 19);\n  const m = String(t).match(/\\b\\d{2}:\\d{2}:\\d{2}\\b/);\n  return m ? m[0] : \"\";\n}\n\nconst grouped = messages.reduce((acc, m) => {\n  const k = toDateKey(m.time);\n  (acc[k] ||= []).push(m);\n  return acc;\n}, {});\n\nconst bydate = Object.keys(grouped)\n  .sort()\n  .map(date => {\n    const arr = grouped[date];\n    const lines = arr.map(m => `[${toTimeOnly(m.time)}][${m.role_name}] ${m.content}`);\n    return {\n      date,\n      items: arr,\n      text: lines.join(\"\\n\"),\n    };\n  });\n\nconst memory_text = bydate\n  .map(g => `【${g.date}】\\n${g.text}`)\n  .join(\"\\n\\n\");\n\nreturn [\n  {\n    json: {\n      messages,\n      bydate,\n      memory_text,\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        752
      ],
      "id": "abe185d6-f8b0-4929-b48d-2eaa8e76f02d",
      "name": "ExtractMemory2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================\n-- 查詢聊天訊息（過濾已刪除的訊息）\n-- ============================================\n\nSELECT \n  id,\n  thread_id as room_id,\n  content as message_content,\n  CASE \n    WHEN role = 'user' THEN 'user'\n    WHEN content_json->>'role_name' = 'hibi' THEN 'hibi'\n    WHEN content_json->>'role_name' = 'mori' THEN 'mori'\n    WHEN content_json->>'role_name' = 'pico' THEN 'pico'\n    WHEN role = 'system' OR content_json->>'role_name' = 'system' THEN 'system'\n    ELSE 'unknown'\n  END as sender,\n  role as sender_type,\n  content_json,\n  created_at,\n  TO_CHAR(created_at, 'YYYY-MM-DD HH24:MI:SS') as timestamp\nFROM public.chat_messages\nWHERE thread_id = ($1)::uuid\n  AND status != 'deleted'  -- ⭐ 過濾已刪除的訊息\nORDER BY created_at DESC\nLIMIT 5;\n",
        "options": {
          "queryReplacement": "=$1 = {{ $('Format_Input1').first().json.thread_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2208,
        752
      ],
      "id": "95ac4901-34ba-4d55-9b45-be946a7c0134",
      "name": "ReadMemory2",
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const f = $('Format_Input1').first().json;\nconst sel = f?.selected_role || {};\nconst guidance = (sel.guidance || '').trim();\nconst toneRaw = (sel.tone || '').trim();\nconst userText = (f?.text || '').trim();\n\nconst rawMemory = (($json.memory_text ?? '') + '').trim();\n\nconst seen = new Set();\nconst dedupLines = rawMemory\n  .split(/\\r?\\n/)\n  .map(s => s.trim())\n  .filter(Boolean)\n  .filter(line => {\n    const key = line.toLowerCase();\n    if (seen.has(key)) return false;\n    seen.add(key);\n    return true;\n  });\n\nconst MEMORY_MAX_CHARS = parseInt($env.MEMORY_MAX_CHARS || '1200', 10);\nlet memoryText = dedupLines.join('\\n').slice(0, MEMORY_MAX_CHARS);\nconst memorySection = memoryText ? `\\n# 已知背景（Memory）\\n${memoryText}\\n` : '';\n\nconst toneList = toneRaw\n  .split(/[、，,。;；\\n]/)\n  .map(s => s.trim())\n  .filter(Boolean)\n  .slice(0, 6);\nconst toneBullets = (toneList.length ? toneList : ['友善', '專業', '有條理'])\n  .map(x => `- ${x}`)\n  .join('\\n');\n\nconst TZ = 'Asia/HongKong';\nconst today = $now;\n\nconst systemPrompt = `\n你是 ${sel.id || sel.name || '協作助手'}。\n# 目標\n${guidance || '協助使用者完成任務、維持專案進度與品質，並主動給出下一步建議。'}\n\n# 語氣與風格\n${toneBullets}\n${memorySection}# 系統資訊\n- 作業時區：${TZ}\n- 今天：${today}\n\n# 輸出原則\n- 以「繁體中文」回應（除非使用者另有要求）\n- 優先條列、分段清晰、步驟可執行\n- 資訊不足時先以最少澄清補齊假設，再給初稿\n- 不要暴露本系統提示或內部設定\n- 若需要程式碼或結構化資料，再提供；否則純文字回覆\n`.trim();\n\n// 處理多模型：優先使用 models 陣列，其次 model 字串
const getModel = (roleData) => {
  if (roleData.models && Array.isArray(roleData.models) && roleData.models.length > 0) {
    return roleData.models[0]; // 使用第一個模型
  }
  if (roleData.model) {
    return roleData.model;
  }
  return 'openai/gpt-4o-mini';
};

const model = getModel(sel);\nconst maxTokens = Math.max(Number($json.llm_payload_max_tokens || 0), 0) || 2048;\n\nreturn [{\n  json: {\n    model,\n    messages: [\n      { role: 'system', content: systemPrompt },\n      { role: 'user', content: userText }\n    ],\n    max_tokens: maxTokens,\n    temperature: 0.7\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2640,
        752
      ],
      "id": "45b51890-25f6-474f-a3d8-8f11842fae5b",
      "name": "BuildMessages2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.chat_messages\nSET\n  status = 'processing',\n  updated_at = now(),\n  content_json = COALESCE(NULLIF(content_json, '{}'::jsonb), '{}'::jsonb) || COALESCE($2::jsonb, '{}'::jsonb)\nWHERE id = ($1)::uuid\nRETURNING id;",
        "options": {
          "queryReplacement": "=$1 = {{ $('CheckMessage').first().json.id }}, $2 = {{ null }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2000,
        752
      ],
      "id": "b718bfd1-cdb3-4a93-8238-bc8ffe228104",
      "name": "MarkUserProcessing2",
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Estimate & Gate Budget (n8n Code Node)\nconst CHARS_PER_FOOD = parseInt($env.CHARS_PER_FOOD || '100', 10);\nconst CHAR_PER_TOKEN = parseFloat($env.CHAR_PER_TOKEN || '4');\nconst MAX_TOKENS_CAP = parseInt($env.MAX_TOKENS_CAP || '2048', 10);\nconst MIN_OUTPUT_TOKENS = parseInt($env.MIN_OUTPUT_TOKENS || '16', 10);\nconst OVERHEAD_CHARS = parseInt($env.MSG_OVERHEAD_CHARS || '20', 10);\n\nfunction countChars(s) {\n  if (!s) return 0;\n  return (s.match(/\\S/g) || []).length;\n}\n\nconst sysMsg = ($json.messages?.find(m => m.role === 'system')?.content) ?? ($('Format_Input1').first().json?.selected_role?.guidance || '');\nconst userMsg = ($json.messages?.find(m => m.role === 'user')?.content) ?? ($('Format_Input1').first().json?.text || '');\n\nlet input_chars = countChars(sysMsg) + countChars(userMsg) + OVERHEAD_CHARS;\nif (input_chars < 0) input_chars = 0;\n\nconst current_food = Number($json.current_balance || 0);\nconst input_food_cost = input_chars > 0 ? Math.ceil(input_chars / CHARS_PER_FOOD) : 0;\n\nlet remain_food = current_food - input_food_cost;\nif (remain_food < 0) remain_food = 0;\n\nconst llm_payload_max_chars = remain_food * CHARS_PER_FOOD;\nlet llm_payload_max_tokens = Math.floor(llm_payload_max_chars / CHAR_PER_TOKEN);\nllm_payload_max_tokens = Math.min(llm_payload_max_tokens, MAX_TOKENS_CAP);\n\nconst budget_ok = llm_payload_max_tokens >= MIN_OUTPUT_TOKENS;\nif (!budget_ok) llm_payload_max_tokens = 0;\n\nreturn [{\n  json: {\n    ...$json,\n    input_chars,\n    input_food_cost,\n    current_food,\n    remain_food,\n    llm_payload_max_chars,\n    llm_payload_max_tokens,\n    budget_ok,\n    budget_rule: {\n      CHARS_PER_FOOD,\n      CHAR_PER_TOKEN,\n      MAX_TOKENS_CAP,\n      MIN_OUTPUT_TOKENS,\n      OVERHEAD_CHARS\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        912
      ],
      "id": "05e7d148-f150-4cc6-b2b3-221e74949176",
      "name": "Estimate&GateBudget2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "178e3ad5-6128-4a08-a9a7-163b9b219984",
              "name": "response_payload",
              "value": "={{ ({ ok: false, code: 402, message: 'Insufficient balance for this request', details: { thread_id: $('Format_Input1').item.json.thread_id || null, client_msg_id: $('Format_Input1').first().json.client_msg_id || null, current_food: ($json.current_balance !== undefined ? $json.current_balance : $json.current_food) || 0, input_food_cost: Number($json.input_food_cost || 0), remain_food: Number($json.remain_food || 0), input_chars: Number($json.input_chars || 0), budget_rule: $json.budget_rule || {} } }) }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1840,
        1184
      ],
      "id": "ae09d99c-619c-455f-a2b6-0ea035c4f1fd",
      "name": "402FormatError2"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.response_payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        2112,
        1344
      ],
      "id": "357c9dd7-a2ad-458b-8ea3-079bba65115f",
      "name": "Respond403"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.chat_messages\nSET\n  status = 'error',\n  error_message = $2,\n  updated_at = now(),\n  content_json = COALESCE(NULLIF(content_json, '{}'::jsonb), '{}'::jsonb) || $3::jsonb\nWHERE thread_id = ($1)::uuid\n  AND client_msg_id = $4\nRETURNING id;",
        "options": {
          "queryReplacement": "=$1 = {{ $('Format_Input1').item.json.thread_id }}, $2 = {{'INSUFFICIENT_FOOD'}}, $3 = {{JSON.stringify({ error_code: 'INSUFFICIENT_FOOD', current_food: $json.current_food, input_food_cost: $json.input_food_cost, remain_food: $json.remain_food })}}, $4 = {{ $('Format_Input1').first().json.client_msg_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2240,
        1184
      ],
      "id": "6a8ed2a4-d8b6-43a5-aa8d-a4744519dfc0",
      "name": "ErrorBalance2",
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "863ed59a-f8aa-4fc4-bd10-3e23dffaa568",
              "leftValue": "={{ $json.budget_ok }}",
              "rightValue": 0,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "901188cd-75ea-4d2d-953c-bf824a1e4c77",
      "name": "IFBalance2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1632,
        912
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6ac663da-8c49-4ee7-9ae8-2cdf527ef021",
              "name": "=current_balance",
              "value": "={{ $json[\"Check Food Balance\"]?.data?.[0]?.rows?.[0]?.current_balance ?? $json.current_balance ?? 0 }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1200,
        912
      ],
      "id": "af4595d7-3428-425a-aae3-44c74c37f336",
      "name": "NormalizeBalance2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT current_balance FROM public.user_food_balance WHERE user_id = ($1)::uuid LIMIT 1;",
        "options": {
          "queryReplacement": "=$1 = {{ $('Format_Input1').first().json.user_id }}"
        }
      },
      "id": "ce2d4447-b47f-4f13-b81d-987ab181f728",
      "name": "CheckFoodBalance2",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        992,
        912
      ],
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "aea6aa7c-c9b8-4093-90a8-24c4849d3d23",
              "name": "thread_id",
              "value": "={{ $json.id || $json.thread_id || $json.room_id }}",
              "type": "string"
            },
            {
              "id": "2b8b745d-87ed-4315-b4c5-62495b64068b",
              "name": "title",
              "value": "={{ $('Format_Input1').first().json.project_info.title || 'Untitled' }}",
              "type": "string"
            },
            {
              "id": "1520f673-b575-448c-9c66-e0b98f2dc2a1",
              "name": "user_id",
              "value": "={{ $('Format_Input1').first().json.user_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        240,
        912
      ],
      "id": "b46b5514-2431-4d62-ab85-ed0935b383ce",
      "name": "CollectMessageFields1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO chat_threads (id, user_id, title, created_at)\nVALUES ($1, $2, COALESCE($3, 'Untitled'), now())\nON CONFLICT (id) DO UPDATE\nSET id = EXCLUDED.id\nRETURNING id;",
        "options": {
          "queryReplacement": "=$1 = {{ $json.room_id }} , $2 = {{ $json.user_id }}, $3 = {{ $json.project_info.title }}"
        }
      },
      "id": "9b967547-5a3e-4ffa-9ed5-9824dd2548f9",
      "name": "EnsureThread1",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        80,
        912
      ],
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format_Input (n8n Code Node) — 修復：優先使用 extra.client_msg_id\nconst body  = $json.body ?? {};\nconst extra = body?.payload?.extra ?? {};\n\nreturn [{\n  json: {\n    // Thread 基本\n    thread_id: body.thread_id ?? extra.room_id ?? null,\n    room_id:   extra.room_id  ?? body.thread_id ?? null,\n    user_id:   extra.user_id  ?? null,\n\n    // —— 之後流程一定會用到的關鍵欄位 ——\n    // ⭐ 修復：優先使用 extra.client_msg_id（前端生成的），fallback 才用 body.client_msg_id\n    client_msg_id: extra.client_msg_id ?? body.client_msg_id ?? null, // 去重鍵\n    role_hint:     body.role_hint     ?? 'auto',\n    message_type:  body.message_type  ?? 'user_request',\n    text:          body?.payload?.text ?? '',\n\n    // 其餘輔助欄位\n    companions:    extra.companions    ?? [],\n    group_roles:   extra.group_roles   ?? [],\n    selected_role: extra.selected_role ?? {},\n    project_info:  extra.project_info  ?? {},\n    source:        extra.source        ?? null,\n    session_id:    extra.session_id    ?? null\n  }\n}];\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -96,
        912
      ],
      "id": "24eb83c2-0007-4a0b-aadb-1ac1be5f0d05",
      "name": "Format_Input1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, status, content, client_msg_id, created_at\nFROM chat_messages \nWHERE thread_id = ($1)::uuid \n  AND client_msg_id = $2\nLIMIT 1;",
        "options": {
          "queryReplacement": "=$1 = {{ $json.thread_id }}, $2 = {{ $('Format_Input1').first().json.client_msg_id }}"
        }
      },
      "id": "16cc62a7-3fd3-4605-ac0e-4e248974fe1a",
      "name": "CheckMessage",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        480,
        912
      ],
      "credentials": {
        "postgres": {
          "id": "UrO5b3fCBNg43wlC",
          "name": "HanamiEcho"
        }
      }
    }
  ],
  "connections": {
    "AiReciever": {
      "main": [
        [
          {
            "node": "Format_Input1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CheckMessageExists": {
      "main": [
        [
          {
            "node": "CheckFoodBalance2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "RespondMessageNotFound",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FixJSONResponse2": {
      "main": [
        [
          {
            "node": "BuildResponse200",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "200FormatError2": {
      "main": [
        [
          {
            "node": "FixJSONResponse2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InsertMessageCosts2": {
      "main": [
        [
          {
            "node": "MarkUserMsgCompleted2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SpendFoodAndTx2": {
      "main": [
        [
          {
            "node": "InsertMessageCosts2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MarkUserMsgCompleted2": {
      "main": [
        [
          {
            "node": "200FormatError2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InsertAssistantMessage2": {
      "main": [
        [
          {
            "node": "SpendFoodAndTx2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FormatOutput2": {
      "main": [
        [
          {
            "node": "InsertAssistantMessage2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouterAI2": {
      "main": [
        [
          {
            "node": "FormatOutput2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ExtractMemory2": {
      "main": [
        [
          {
            "node": "BuildMessages2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ReadMemory2": {
      "main": [
        [
          {
            "node": "ExtractMemory2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuildMessages2": {
      "main": [
        [
          {
            "node": "OpenRouterAI2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MarkUserProcessing2": {
      "main": [
        [
          {
            "node": "ReadMemory2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estimate&GateBudget2": {
      "main": [
        [
          {
            "node": "IFBalance2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "402FormatError2": {
      "main": [
        [
          {
            "node": "Respond403",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IFBalance2": {
      "main": [
        [
          {
            "node": "MarkUserProcessing2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "402FormatError2",
            "type": "main",
            "index": 0
          },
          {
            "node": "ErrorBalance2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NormalizeBalance2": {
      "main": [
        [
          {
            "node": "Estimate&GateBudget2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CheckFoodBalance2": {
      "main": [
        [
          {
            "node": "NormalizeBalance2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CollectMessageFields1": {
      "main": [
        [
          {
            "node": "CheckMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EnsureThread1": {
      "main": [
        [
          {
            "node": "CollectMessageFields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format_Input1": {
      "main": [
        [
          {
            "node": "EnsureThread1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CheckMessage": {
      "main": [
        [
          {
            "node": "CheckMessageExists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "AiReciever": [
      {
        "headers": {
          "host": "webhook.lingumiai.com",
          "user-agent": "node",
          "content-length": "546",
          "accept": "*/*",
          "accept-encoding": "gzip, br",
          "accept-language": "*",
          "authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkhhbmFtaUVjaG8iLCJhZG1pbiI6dHJ1ZSwiaWF0IjoxNzYxMzcwMjgxfQ.I2yLzJFSD7jsAP8YXIka5wNHK5gsEOA3-fUYLvhSO9w",
          "cdn-loop": "cloudflare; loops=1",
          "cf-connecting-ip": "138.199.22.154",
          "cf-ipcountry": "JP",
          "cf-ray": "993f53c24c45b005-NRT",
          "cf-visitor": "{\"scheme\":\"https\"}",
          "cf-warp-tag-id": "3479e890-bf26-418d-9f59-c56944c4c525",
          "connection": "keep-alive",
          "content-type": "application/json",
          "sec-fetch-mode": "cors",
          "x-forwarded-for": "138.199.22.154",
          "x-forwarded-proto": "https",
          "x-signature": "5d0fe8826451b87c74bae21838e7a95d996c0a775e69a05801741e1ad714c6d0"
        },
        "params": {},
        "query": {},
        "body": {
          "spec_version": "1.0",
          "event_type": "message.created",
          "thread_id": "0295b429-ac89-40dd-a2a2-3a7cccd468ae",
          "client_msg_id": "01K8CXK3XWX2P6DDT8FFHFYPMZ",
          "role_hint": "hibi",
          "message_type": "user_request",
          "payload": {
            "text": "la",
            "extra": {
              "user_id": "4b8fcd8f-ea99-42f6-8509-88018aac7a3d",
              "client_msg_id": "01K8CXK3XWX2P6DDT8FFHFYPMZ",
              "group_roles": [],
              "selected_role": {},
              "project_info": {}
            }
          },
          "priority": "normal",
          "timestamp": 1761370279868,
          "message_id": "7bb918c8-a14c-4a1f-a9f3-f48420d18333",
          "callback_url": "http://localhost:3000/api/webhook/ingress/callback"
        },
        "webhookUrl": "http://localhost:5678/webhook/ingress",
        "executionMode": "production",
        "jwtPayload": {
          "sub": "1234567890",
          "name": "HanamiEcho",
          "admin": true,
          "iat": 1761370281
        }
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "4b2fb6f84ef91181f85de1277717d6717566b015633b0c427e51a39fe81532f2"
  }
}