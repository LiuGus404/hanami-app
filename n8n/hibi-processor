{
    "nodes": [
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "{\n  \"ok\": false,\n  \"code\": 404,\n  \"error\": \"MESSAGE_NOT_FOUND\",\n  \"message\": \"訊息不存在於資料庫\",\n  \"details\": {\n    \"client_msg_id\": \"={{ $('Format_Input1').first().json.client_msg_id }}\",\n    \"thread_id\": \"={{ $('Format_Input1').first().json.thread_id }}\"\n  }\n}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.4,
        "position": [
          1840,
          592
        ],
        "id": "8f2d2f70-e645-464a-84c9-66a4a8cc3326",
        "name": "RespondMessageNotFound"
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 2
            },
            "conditions": [
              {
                "id": "515655f9-5caf-45ef-b69d-ab388a77e8c4",
                "leftValue": "={{$('CheckMessage').first().json.id}}",
                "rightValue": "",
                "operator": {
                  "type": "string",
                  "operation": "exists",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "type": "n8n-nodes-base.if",
        "typeVersion": 2.2,
        "position": [
          1648,
          336
        ],
        "id": "3d29c598-2678-40bd-8843-9cf04db670ab",
        "name": "CheckMessageExists"
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ $json.response200_payload }}",
          "options": {
            "responseCode": 200
          }
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.4,
        "position": [
          5728,
          176
        ],
        "id": "e56cc591-4b54-4dfb-8763-ba6cbf3a5608",
        "name": "BuildResponse200"
      },
      {
        "parameters": {
          "jsCode": "const response = {\n  ok: true,\n  code: 200,\n  data: {\n    thread_id: $('TriggerRouter').first().json.thread_id,\n    message_id: $('InsertAssistantMessage2').first().json.id,\n    client_msg_id: $('TriggerRouter').first().json.client_msg_id + ':assistant',\n    content: $('FormatOutput2').first().json.assistant_content,\n    model: $('FormatOutput2').first().json.model,\n    provider: $('FormatOutput2').first().json.provider,\n    usage: $('FormatOutput2').first().json.usage,\n    food: $('FormatOutput2').first().json.food,\n    balance_after: $('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.balance_after || null,\n    tx_id: $('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.tx_id || null\n  }\n};\n\nreturn [{ json: { response200_payload: response } }];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          5536,
          176
        ],
        "id": "fc0fe6e7-fd00-47db-a42f-120acc4c823c",
        "name": "FixJSONResponse2"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "7dd3096d-4ca2-4dee-aede-cc41f9d391a5",
                "name": "response200_payload",
                "value": "={{ ({ ok: true, code: 200, data: { thread_id: $('TriggerRouter').first().json.thread_id, message_id: $('InsertAssistantMessage2').first().json.id, client_msg_id: $('TriggerRouter').first().json.client_msg_id + ':assistant', content: $('FormatOutput2').first().json.assistant_content, model: $('FormatOutput2').first().json.model, provider: $('FormatOutput2').first().json.provider, usage: $('FormatOutput2').first().json.usage, food: $('FormatOutput2').first().json.food, balance_after: ($('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.balance_after ?? null), tx_id: ($('SpendFoodAndTx2').first().json?.data?.[0]?.rows?.[0]?.tx_id ?? null) } }) }}",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          5328,
          176
        ],
        "id": "e7242cec-2b6f-4595-9951-d7ae16f1a833",
        "name": "200FormatError2"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "INSERT INTO public.message_costs\n  (message_id, thread_id, user_id,\n   input_tokens, output_tokens, total_tokens,\n   model_provider, model_name,\n   total_cost_usd, food_amount, created_at)\nVALUES\n  (($1)::uuid, ($2)::uuid, ($3)::uuid,\n   $4, $5, $6,\n   $7, $8,\n   0, $9, now())\nRETURNING id;",
          "options": {
            "queryReplacement": "=$1 = {{ $('InsertAssistantMessage2').first().json.id }}, $2 = {{ $('TriggerRouter').first().json.thread_id }}, $3 = {{ $('TriggerRouter').first().json.user_id }}, $4 = {{ $('FormatOutput2').first().json.usage.input_tokens }}, $5 = {{ $('FormatOutput2').first().json.usage.output_tokens }}, $6 = {{ $('FormatOutput2').first().json.usage.total_tokens }}, $7 = {{ JSON.stringify($('FormatOutput2').first().json.provider) }}, $8 = {{ JSON.stringify($('FormatOutput2').first().json.model) }}, $9 = {{ $('FormatOutput2').first().json.food.total_food_cost }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          4864,
          176
        ],
        "id": "c393c980-90de-411a-a26a-c4f1bcdb882c",
        "name": "InsertMessageCosts2",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "WITH upd AS (\n  UPDATE public.user_food_balance\n  SET current_balance = current_balance - $2,\n      total_spent = total_spent + $2,\n      updated_at = now()\n  WHERE user_id = ($1)::uuid\n  RETURNING current_balance\n),\n-- 確保 thread 存在\nensure_thread AS (\n  INSERT INTO public.chat_threads (id, user_id, title, created_at)\n  VALUES (($4)::uuid, ($1)::uuid, 'Untitled', now())\n  ON CONFLICT (id) DO UPDATE SET updated_at = now()\n  RETURNING id\n),\nins AS (\n  INSERT INTO public.food_transactions\n    (user_id, transaction_type, amount, balance_after, message_id, thread_id, description, created_at)\n  SELECT\n    ($1)::uuid, 'spend', $2, u.current_balance, ($3)::uuid, ($4)::uuid, $5, now()\n  FROM upd u\n  RETURNING id\n)\nSELECT\n  (SELECT current_balance FROM upd) AS balance_after,\n  (SELECT id FROM ins) AS tx_id;",
          "options": {
            "queryReplacement": "=$1 = {{ $('TriggerRouter').first().json.user_id }}, $2 = {{ $('FormatOutput2').first().json.food.total_food_cost }}, $3 = {{ $('InsertAssistantMessage2').first().json.id }}, $4 = {{ $('TriggerRouter').first().json.thread_id }}, $5 = {{ JSON.stringify(`LLM spend: ${$('FormatOutput2').first().json.model} (in=${$('FormatOutput2').first().json.usage.input_tokens}, out=${$('FormatOutput2').first().json.usage.output_tokens}, chars=${$('FormatOutput2').first().json.food.output_chars})`) }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          4576,
          176
        ],
        "id": "979a510e-128d-41d8-8daf-8a6b2b04683a",
        "name": "SpendFoodAndTx2",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "UPDATE public.chat_messages\nSET\n  status = 'completed',\n  updated_at = now(),\n  content_json = COALESCE(NULLIF(content_json, '{}'::jsonb), '{}'::jsonb) || $2::jsonb\nWHERE id = ($1)::uuid\nRETURNING id;",
          "options": {
            "queryReplacement": "=$1 = {{ $('CheckMessage').first().json.id }}, $2 = {{ JSON.stringify({ assistant_message_id: $('InsertAssistantMessage2').first().json.id, finish_reason: $('FormatOutput2').first().json.finish_reason, usage: $('FormatOutput2').first().json.usage, food: $('FormatOutput2').first().json.food }) }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          5088,
          176
        ],
        "id": "74bd4a07-763b-401a-abae-ee1e6b4057fe",
        "name": "MarkUserMsgCompleted2",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "INSERT INTO public.chat_messages\n  (thread_id, role, message_type, content, status, client_msg_id, parent_id, content_json, created_at, updated_at)\nVALUES\n  (($1)::uuid, 'assistant', 'final', $2, 'completed', $3, ($4)::uuid, $5::jsonb, now(), now())\nRETURNING id;",
          "options": {
            "queryReplacement": "=$1 = {{ $json.thread_id }}, $2 = {{ $json.assistant_content }}, $3 = {{ $json.client_msg_id_asst }}, $4 = {{ $json.user_message_id }}, $5 = {{ JSON.stringify($json.meta) }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          4320,
          176
        ],
        "id": "c1fbc115-97ee-410d-bf4b-65a0204996f9",
        "name": "InsertAssistantMessage2",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const resp = $json;\nconst choice = resp?.choices?.[0] || {};\nconst msg = choice?.message || {};\nconst content = (msg.content || '').trim();\n\nfunction countChars(s){ return (s||'').match(/\\S/g)?.length ?? 0; }\n\nconst input_tokens = Number(resp?.usage?.prompt_tokens || 0);\nconst output_tokens = Number(resp?.usage?.completion_tokens || 0);\nconst total_tokens = Number(resp?.usage?.total_tokens || (input_tokens + output_tokens));\n\nconst provider = resp?.provider || 'openai';\nconst model = resp?.model || $('BuildMessages2').first().json?.model || $('TriggerRouter').first().json?.selected_role?.model || 'unknown';\n\nconst CHARS_PER_FOOD = parseInt($env.CHARS_PER_FOOD || '100', 10);\n\nconst input_chars = Number($('Estimate&GateBudget2').first().json?.input_chars || 0);\nconst input_food_cost = input_chars > 0 ? Math.ceil(input_chars / CHARS_PER_FOOD) : 0;\n\nconst output_chars = countChars(content);\nconst output_food_cost = output_chars > 0 ? Math.ceil(output_chars / CHARS_PER_FOOD) : 0;\n\nconst total_food_cost = input_food_cost + output_food_cost;\n\n// ⭐ 修復：直接從 Format_Input1 獲取 thread_id 和 user_id\nconst thread_id = $('TriggerRouter').first().json.thread_id || $('TriggerRouter').first().json.room_id;\nconst user_id = $('TriggerRouter').first().json.user_id;\nconst user_message_id = $('CheckMessage').first().json.id;\nconst client_msg_id = $('TriggerRouter').first().json.client_msg_id;\n\nconst openrouter_id = $('OpenRouterAI2').first().json?.id || null;\nconst client_msg_id_asst = openrouter_id || (client_msg_id ? `${client_msg_id}:assistant` : `asst-${$now}`);\n\nconst meta = {\n  provider,\n  model,\n  usage: { input_tokens, output_tokens, total_tokens },\n  food: {\n    CHARS_PER_FOOD,\n    input_chars, output_chars,\n    input_food_cost, output_food_cost, total_food_cost,\n    remain_before: Number($('Estimate&GateBudget2').first().json?.remain_food || 0)\n  },\n  openrouter_id,\n  parent_id: user_message_id,\n  source: 'n8n/openrouter'\n};\n\nreturn [{\n  json: {\n    assistant_content: content,\n    provider, model,\n    finish_reason: choice?.finish_reason || 'stop',\n    usage: { input_tokens, output_tokens, total_tokens },\n    food: meta.food,\n    thread_id, user_id, user_message_id, client_msg_id,\n    client_msg_id_asst,\n    meta\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          4096,
          176
        ],
        "id": "62dae9ee-166d-4c71-8b5b-c95de460cf3c",
        "name": "FormatOutput2"
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://openrouter.ai/api/v1/chat/completions",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "openRouterApi",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ $json }}",
          "options": {
            "response": {
              "response": {
                "responseFormat": "json"
              }
            }
          }
        },
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [
          3840,
          176
        ],
        "id": "64c44441-35b0-483b-929b-4e0414e400a3",
        "name": "OpenRouterAI2",
        "retryOnFail": true,
        "maxTries": 5,
        "credentials": {
          "openRouterApi": {
            "id": "vvJa75RZf9KwdDR5",
            "name": "AIResearch"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const input = Array.isArray($json.input) ? $json.input : (Array.isArray(items) ? items.map(i => i.json) : []);\n\nfunction stripLinks(s = \"\") {\n  s = String(s);\n  s = s.replace(/!\\[([^\\]]*)\\]\\((https?:\\/\\/[^\\s)]+)\\)/g, (_, alt) => (alt ? `${alt}（連結）` : \"連結\"));\n  s = s.replace(/\\[([^\\]]+)\\]\\((https?:\\/\\/[^\\s)]+)\\)/g, (_, text) => (text ? `${text}（連結）` : \"連結\"));\n  s = s.replace(/https?:\\/\\/[^\\s)]+/g, \"連結\");\n  return s.trim();\n}\n\nconst pickTime = (m) => m.timestamp || m.created_at || \"\";\nconst pickRole = (m) => (m?.content_json?.role_name) || m.sender || \"unknown\";\nconst pickContent = (m) => stripLinks(m.message_content ?? \"\");\n\nconst messages = input\n  .map(m => ({\n    time: pickTime(m),\n    role_name: pickRole(m),\n    content: pickContent(m),\n  }))\n  .filter(x => x.time && x.content);\n\nmessages.sort((a, b) => new Date(a.time) - new Date(b.time));\n\nfunction toDateKey(t) {\n  const d = new Date(t);\n  if (!isNaN(d)) return d.toISOString().slice(0, 10);\n  return (t.includes(\" \") ? t.split(\" \")[0] : String(t).slice(0, 10));\n}\n\nfunction toTimeOnly(t) {\n  const d = new Date(t);\n  if (!isNaN(d)) return d.toISOString().slice(11, 19);\n  const m = String(t).match(/\\b\\d{2}:\\d{2}:\\d{2}\\b/);\n  return m ? m[0] : \"\";\n}\n\nconst grouped = messages.reduce((acc, m) => {\n  const k = toDateKey(m.time);\n  (acc[k] ||= []).push(m);\n  return acc;\n}, {});\n\nconst bydate = Object.keys(grouped)\n  .sort()\n  .map(date => {\n    const arr = grouped[date];\n    const lines = arr.map(m => `[${toTimeOnly(m.time)}][${m.role_name}] ${m.content}`);\n    return {\n      date,\n      items: arr,\n      text: lines.join(\"\\n\"),\n    };\n  });\n\nconst memory_text = bydate\n  .map(g => `【${g.date}】\\n${g.text}`)\n  .join(\"\\n\\n\");\n\nreturn [\n  {\n    json: {\n      messages,\n      bydate,\n      memory_text,\n    }\n  }\n];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3376,
          176
        ],
        "id": "478f32b9-3ddf-43ab-8877-a7e76ad0b098",
        "name": "ExtractMemory2"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "-- ============================================\n-- 查詢聊天訊息（過濾已刪除的訊息）\n-- ============================================\n\nSELECT \n  id,\n  thread_id as room_id,\n  content as message_content,\n  CASE \n    WHEN role = 'user' THEN 'user'\n    WHEN content_json->>'role_name' = 'hibi' THEN 'hibi'\n    WHEN content_json->>'role_name' = 'mori' THEN 'mori'\n    WHEN content_json->>'role_name' = 'pico' THEN 'pico'\n    WHEN role = 'system' OR content_json->>'role_name' = 'system' THEN 'system'\n    ELSE 'unknown'\n  END as sender,\n  role as sender_type,\n  content_json,\n  created_at,\n  TO_CHAR(created_at, 'YYYY-MM-DD HH24:MI:SS') as timestamp\nFROM public.chat_messages\nWHERE thread_id = ($1)::uuid\n  AND status != 'deleted'  -- ⭐ 過濾已刪除的訊息\nORDER BY created_at DESC\nLIMIT 5;\n",
          "options": {
            "queryReplacement": "=$1 = {{ $('TriggerRouter').first().json.thread_id }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          3168,
          176
        ],
        "id": "4367003a-f92b-4754-ae63-1671ff36a801",
        "name": "ReadMemory2",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// ===== Robust Formatter for model / guidance / tone / project_info =====\n\n// 1) 基礎輸入\nconst f = ($('TriggerRouter').first()?.json) || {};\nconst roles = Array.isArray(f.group_roles) ? f.group_roles : [];\nconst roleHint = (f.role_hint || '').toLowerCase();\nconst selectedRoleInput = f.selected_role || null;\nconst userText = (f?.text || '').trim();\n\n// 2) 取出 project_info（可能用於 fallback）\nconst projectInfo = f.project_info || {};\nconst projectTitle = (projectInfo.title || '').trim();\nconst projectObjective = (projectInfo.objective || projectInfo.goal || '').trim();\nconst projectAudience = (projectInfo.audience || '').trim();\nconst projectStyle = (projectInfo.style || '').trim();\nconst projectConstraints = (projectInfo.constraints || '').trim();\nconst projectDefaultModel = (projectInfo.default_model || '').trim();\n\n// 3) 角色選擇邏輯\nfunction matchRoleByString(s) {\n  if (!s) return null;\n  const key = String(s).toLowerCase();\n  return roles.find(r => {\n    const id = (r?.id || '').toLowerCase();\n    const name = (r?.name || '').toLowerCase();\n    return id === key || name === key || id.includes(key) || name.includes(key);\n  }) || null;\n}\n\nlet sel = {};\nif (selectedRoleInput && typeof selectedRoleInput === 'object') {\n  // 已是角色物件\n  sel = selectedRoleInput;\n} else if (typeof selectedRoleInput === 'string') {\n  sel = matchRoleByString(selectedRoleInput) || {};\n} else if (roleHint) {\n  sel = matchRoleByString(roleHint) || {};\n}\n\n// 若仍未選到，取第一位\nif (!sel || Object.keys(sel).length === 0) {\n  sel = roles[0] || {};\n}\n\n// 4) 解析 guidance / tone（優先角色，次選 project_info，再預設）\nconst guidance =\n  (sel.guidance || projectInfo.guidance || f.guidance || '').trim();\n\nconst toneRaw =\n  (sel.tone || projectInfo.tone || f.tone || '').trim();\n\n// 5) 解析 model（支援多種型別）\nfunction pickFirstModelFromList(list) {\n  if (!list) return '';\n  if (Array.isArray(list)) {\n    // 可能是字串陣列或物件陣列\n    for (const m of list) {\n      if (typeof m === 'string' && m.trim()) return m.trim();\n      if (m && typeof m === 'object') {\n        // 常見字段：id / name / model\n        if (typeof m.model === 'string' && m.model.trim()) return m.model.trim();\n        if (typeof m.id === 'string' && m.id.trim()) return m.id.trim();\n        if (typeof m.name === 'string' && m.name.trim()) return m.name.trim();\n      }\n    }\n  } else if (typeof list === 'object') {\n    // 單一物件\n    if (typeof list.model === 'string' && list.model.trim()) return list.model.trim();\n    if (typeof list.id === 'string' && list.id.trim()) return list.id.trim();\n    if (typeof list.name === 'string' && list.name.trim()) return list.name.trim();\n  } else if (typeof list === 'string') {\n    return list.trim();\n  }\n  return '';\n}\n\nlet resolvedModel =\n  (sel.model && String(sel.model).trim()) ||\n  pickFirstModelFromList(sel.models) ||\n  (projectDefaultModel) ||\n  (f.default_model && String(f.default_model).trim()) ||\n  (String($json.model || '').trim()) ||\n  'openai/gpt-4o-mini';\n\n// 6) 記憶處理（去重＋截斷）\nconst rawMemory = (String($json.memory_text ?? '')).trim();\nconst seen = new Set();\nconst dedupLines = rawMemory\n  .split(/\\r?\\n/)\n  .map(s => s.trim())\n  .filter(Boolean)\n  .filter(line => {\n    const key = line.toLowerCase();\n    if (seen.has(key)) return false;\n    seen.add(key);\n    return true;\n  });\n\nconst MEMORY_MAX_CHARS = parseInt($env.MEMORY_MAX_CHARS || '1200', 10);\nlet memoryText = dedupLines.join('\\n').slice(0, MEMORY_MAX_CHARS);\nconst memorySection = memoryText ? `\\n# 已知背景（Memory）\\n${memoryText}\\n` : '';\n\n// 7) Tone 轉條列（最多 6 個），若無則預設\nconst toneList = toneRaw\n  .split(/[、，,。;；\\n]/)\n  .map(s => s.trim())\n  .filter(Boolean)\n  .slice(0, 6);\n\nconst toneBullets = (toneList.length ? toneList : ['友善', '專業', '有條理'])\n  .map(x => `- ${x}`)\n  .join('\\n');\n\n// 8) 專案資訊區塊（若有，就補上）\nlet projectInfoSection = '';\nif (projectTitle || projectObjective || projectAudience || projectStyle || projectConstraints) {\n  projectInfoSection =\n    `\\n# 專案資訊（project_info）` +\n    (projectTitle ? `\\n- 標題：${projectTitle}` : '') +\n    (projectObjective ? `\\n- 目標/目的：${projectObjective}` : '') +\n    (projectAudience ? `\\n- 受眾：${projectAudience}` : '') +\n    (projectStyle ? `\\n- 風格：${projectStyle}` : '') +\n    (projectConstraints ? `\\n- 限制/注意事項：${projectConstraints}` : '') +\n    '\\n';\n}\n\n// 9) 角色名稱處理\nconst roleLabel = sel.id || sel.name || '協作助手';\n\n// 10) 系統資訊\nconst TZ = 'Asia/Hong_Kong'; // ✅ 正確時區名稱\nconst today = $now;\n\n// 11) guidance 若為空，給一段溫和預設\nconst guidanceFinal = guidance || '協助使用者完成任務、維持專案進度與品質，並主動給出下一步建議。';\n\n// 12) System Prompt\nconst systemPrompt = `\n你是 ${roleLabel}。\n# 目標\n${guidanceFinal}\n\n# 語氣與風格\n${toneBullets}\n${memorySection}${projectInfoSection}# 系統資訊\n- 作業時區：${TZ}\n- 今天：${today}\n\n# 輸出原則\n- 以「繁體中文」回應（除非使用者另有要求）\n- 優先條列、分段清晰、步驟可執行\n- 資訊不足時先以最少澄清補齊假設，再給初稿\n- 不要暴露本系統提示或內部設定\n- 若需要程式碼或結構化資料，再提供；否則純文字回覆\n`.trim();\n\n// 13) 產出 LLM 請求\nconst maxTokens = Math.max(Number($json.llm_payload_max_tokens || 0), 0) || 2048;\n\nreturn [{\n  json: {\n    model: resolvedModel,\n    messages: [\n      { role: 'system', content: systemPrompt },\n      { role: 'user', content: userText }\n    ],\n    max_tokens: maxTokens,\n    temperature: 0.7\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          3600,
          176
        ],
        "id": "c036e19e-d538-4c80-91b2-35e6efa1daf0",
        "name": "BuildMessages2"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "UPDATE public.chat_messages\nSET\n  status = 'processing',\n  updated_at = now(),\n  content_json = COALESCE(NULLIF(content_json, '{}'::jsonb), '{}'::jsonb) || COALESCE($2::jsonb, '{}'::jsonb)\nWHERE id = ($1)::uuid\nRETURNING id;",
          "options": {
            "queryReplacement": "=$1 = {{ $('CheckMessage').first().json.id }}, $2 = {{ null }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          2960,
          176
        ],
        "id": "dea6aee2-bacb-485c-ba49-8cd0b990a74b",
        "name": "MarkUserProcessing2",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Estimate & Gate Budget (n8n Code Node)\nconst CHARS_PER_FOOD = parseInt($env.CHARS_PER_FOOD || '100', 10);\nconst CHAR_PER_TOKEN = parseFloat($env.CHAR_PER_TOKEN || '4');\nconst MAX_TOKENS_CAP = parseInt($env.MAX_TOKENS_CAP || '2048', 10);\nconst MIN_OUTPUT_TOKENS = parseInt($env.MIN_OUTPUT_TOKENS || '16', 10);\nconst OVERHEAD_CHARS = parseInt($env.MSG_OVERHEAD_CHARS || '20', 10);\n\nfunction countChars(s) {\n  if (!s) return 0;\n  return (s.match(/\\S/g) || []).length;\n}\n\nconst sysMsg = ($json.messages?.find(m => m.role === 'system')?.content) ?? ($('TriggerRouter').first().json?.selected_role?.guidance || '');\nconst userMsg = ($json.messages?.find(m => m.role === 'user')?.content) ?? ($('TriggerRouter').first().json?.text || '');\n\nlet input_chars = countChars(sysMsg) + countChars(userMsg) + OVERHEAD_CHARS;\nif (input_chars < 0) input_chars = 0;\n\nconst current_food = Number($json.current_balance || 0);\nconst input_food_cost = input_chars > 0 ? Math.ceil(input_chars / CHARS_PER_FOOD) : 0;\n\nlet remain_food = current_food - input_food_cost;\nif (remain_food < 0) remain_food = 0;\n\nconst llm_payload_max_chars = remain_food * CHARS_PER_FOOD;\nlet llm_payload_max_tokens = Math.floor(llm_payload_max_chars / CHAR_PER_TOKEN);\nllm_payload_max_tokens = Math.min(llm_payload_max_tokens, MAX_TOKENS_CAP);\n\nconst budget_ok = llm_payload_max_tokens >= MIN_OUTPUT_TOKENS;\nif (!budget_ok) llm_payload_max_tokens = 0;\n\nreturn [{\n  json: {\n    ...$json,\n    input_chars,\n    input_food_cost,\n    current_food,\n    remain_food,\n    llm_payload_max_chars,\n    llm_payload_max_tokens,\n    budget_ok,\n    budget_rule: {\n      CHARS_PER_FOOD,\n      CHAR_PER_TOKEN,\n      MAX_TOKENS_CAP,\n      MIN_OUTPUT_TOKENS,\n      OVERHEAD_CHARS\n    }\n  }\n}];"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2368,
          336
        ],
        "id": "32a2983b-b5e9-4cab-90f3-5fc2aad955ab",
        "name": "Estimate&GateBudget2"
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "178e3ad5-6128-4a08-a9a7-163b9b219984",
                "name": "response_payload",
                "value": "={{ ({ ok: false, code: 402, message: 'Insufficient balance for this request', details: { thread_id: $('Format_Input1').item.json.thread_id || null, client_msg_id: $('Format_Input1').first().json.client_msg_id || null, current_food: ($json.current_balance !== undefined ? $json.current_balance : $json.current_food) || 0, input_food_cost: Number($json.input_food_cost || 0), remain_food: Number($json.remain_food || 0), input_chars: Number($json.input_chars || 0), budget_rule: $json.budget_rule || {} } }) }}",
                "type": "object"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          2800,
          608
        ],
        "id": "b409369e-ff86-42f9-9144-723514a29862",
        "name": "402FormatError2"
      },
      {
        "parameters": {
          "respondWith": "json",
          "responseBody": "={{ $json.response_payload }}",
          "options": {}
        },
        "type": "n8n-nodes-base.respondToWebhook",
        "typeVersion": 1.4,
        "position": [
          3072,
          768
        ],
        "id": "fb274942-376b-4121-9c51-eae1ba376c1b",
        "name": "Respond403"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "UPDATE public.chat_messages\nSET\n  status = 'error',\n  error_message = $2,\n  updated_at = now(),\n  content_json = COALESCE(NULLIF(content_json, '{}'::jsonb), '{}'::jsonb) || $3::jsonb\nWHERE thread_id = ($1)::uuid\n  AND client_msg_id = $4\nRETURNING id;",
          "options": {
            "queryReplacement": "=$1 = {{ $('Format_Input1').item.json.thread_id }}, $2 = {{'INSUFFICIENT_FOOD'}}, $3 = {{JSON.stringify({ error_code: 'INSUFFICIENT_FOOD', current_food: $json.current_food, input_food_cost: $json.input_food_cost, remain_food: $json.remain_food })}}, $4 = {{ $('Format_Input1').first().json.client_msg_id }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          3200,
          608
        ],
        "id": "665385d7-de1b-46b7-9d22-0ffc247615c2",
        "name": "ErrorBalance2",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "conditions": {
            "options": {
              "caseSensitive": true,
              "leftValue": "",
              "typeValidation": "strict",
              "version": 1
            },
            "conditions": [
              {
                "id": "863ed59a-f8aa-4fc4-bd10-3e23dffaa568",
                "leftValue": "={{ $json.budget_ok }}",
                "rightValue": 0,
                "operator": {
                  "type": "boolean",
                  "operation": "true",
                  "singleValue": true
                }
              }
            ],
            "combinator": "and"
          },
          "options": {}
        },
        "id": "72d9e2c9-84cf-4fc8-983b-20a5978def44",
        "name": "IFBalance2",
        "type": "n8n-nodes-base.if",
        "typeVersion": 2,
        "position": [
          2592,
          336
        ]
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "6ac663da-8c49-4ee7-9ae8-2cdf527ef021",
                "name": "=current_balance",
                "value": "={{ $json[\"Check Food Balance\"]?.data?.[0]?.rows?.[0]?.current_balance ?? $json.current_balance ?? 0 }}",
                "type": "number"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          2160,
          336
        ],
        "id": "3b6c52d4-36d6-4688-a4a3-36f848091268",
        "name": "NormalizeBalance2"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "SELECT current_balance FROM public.user_food_balance WHERE user_id = ($1)::uuid LIMIT 1;",
          "options": {
            "queryReplacement": "=$1 = {{ $('TriggerRouter').first().json.user_id }}"
          }
        },
        "id": "a6a835f0-2839-4df5-8d1e-7d05f591d1c8",
        "name": "CheckFoodBalance2",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2,
        "position": [
          1952,
          336
        ],
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "assignments": {
            "assignments": [
              {
                "id": "aea6aa7c-c9b8-4093-90a8-24c4849d3d23",
                "name": "thread_id",
                "value": "={{ $json.id || $json.thread_id || $json.room_id }}",
                "type": "string"
              },
              {
                "id": "2b8b745d-87ed-4315-b4c5-62495b64068b",
                "name": "title",
                "value": "={{ $('TriggerRouter').first().json.project_info.title || 'Untitled' }}",
                "type": "string"
              },
              {
                "id": "1520f673-b575-448c-9c66-e0b98f2dc2a1",
                "name": "user_id",
                "value": "={{ $('TriggerRouter').first().json.user_id }}",
                "type": "string"
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.set",
        "typeVersion": 3.4,
        "position": [
          1040,
          400
        ],
        "id": "39f96406-9745-4925-9889-be48f439ccfc",
        "name": "CollectMessageFields1"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "SELECT id, status, content, client_msg_id, created_at\nFROM chat_messages \nWHERE thread_id = ($1)::uuid \n  AND client_msg_id = $2\nLIMIT 1;",
          "options": {
            "queryReplacement": "=$1 = {{ $('TriggerRouter').first().json.thread_id }}, $2 = {{ $('TriggerRouter').first().json.client_msg_id }}"
          }
        },
        "id": "77e4b0ef-02d8-44ab-a589-ba6c18427ded",
        "name": "CheckMessage",
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2,
        "position": [
          1440,
          336
        ],
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "inputSource": "passthrough"
        },
        "id": "c055762a-8fe7-4141-a639-df2372f30060",
        "typeVersion": 1.1,
        "name": "ImmediateTrigger",
        "type": "n8n-nodes-base.executeWorkflowTrigger",
        "position": [
          -224,
          352
        ]
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "field": "seconds"
              }
            ]
          }
        },
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1.2,
        "position": [
          -240,
          544
        ],
        "id": "6f1027c1-2ff3-4b01-8c55-4a694ee981fd",
        "name": "CronTrigger"
      },
      {
        "parameters": {
          "jsCode": "// TriggerRouter — 輸出完整欄位（含示例中的所有鍵）並分流 Cron / Immediate\n\n// ---------- Helpers ----------\nfunction pickFirstModel(list) {\n  if (!list) return '';\n  if (typeof list === 'string') return list.trim();\n  if (Array.isArray(list)) {\n    for (const m of list) {\n      if (typeof m === 'string' && m.trim()) return m.trim();\n      if (m && typeof m === 'object') {\n        if (typeof m.model === 'string' && m.model.trim()) return m.model.trim();\n        if (typeof m.id === 'string' && m.id.trim()) return m.id.trim();\n        if (typeof m.name === 'string' && m.name.trim()) return m.name.trim();\n      }\n    }\n  } else if (typeof list === 'object') {\n    if (typeof list.model === 'string' && list.model.trim()) return list.model.trim();\n    if (typeof list.id === 'string' && list.id.trim()) return list.id.trim();\n    if (typeof list.name === 'string' && list.name.trim()) return list.name.trim();\n  }\n  return '';\n}\n\nfunction normalizeGroupRoles(input) {\n  // 支援：已是扁平格式 / 原始 roles 物件 / 混合型\n  const roles = Array.isArray(input) ? input : [];\n  return roles.map(r => {\n    const model = (typeof r?.model === 'string' && r.model.trim())\n      ? r.model.trim()\n      : pickFirstModel(r?.models);\n    return {\n      id: (r?.id || '').trim(),\n      name: (r?.name || '').trim(),\n      model,\n      tone: (r?.tone || '').trim(),\n      guidance: (r?.guidance || '').trim(),\n    };\n  });\n}\n\nfunction inferWorkflow(roleId, fallback = 'hibi-processor') {\n  if (!roleId || typeof roleId !== 'string') return fallback;\n  if (roleId.startsWith('hibi')) return 'hibi-processor';\n  if (roleId.startsWith('mori')) return 'mori-processor';\n  if (roleId.startsWith('pico')) return 'pico-processor';\n  // 其他：用前綴推斷\n  const prefix = roleId.split('-')[0] || 'hibi';\n  return `${prefix}-processor`;\n}\n\n// ---------- Main ----------\nconst list = (Array.isArray(items) && items.length) ? items : [{ json: {} }];\n\n// Cron（Schedule Trigger 典型：一筆空物件）\nconst firstJson = list[0]?.json ?? {};\nconst isCronTrigger = list.length === 1 && firstJson && Object.keys(firstJson).length === 0;\n\nif (isCronTrigger) {\n  const roleId = 'hibi-manager';\n  const workerId = 'hibi-processor';\n  return [{\n    json: {\n      // —— 路由欄位 ——\n      trigger_type: 'cron',\n      is_immediate: false,\n      is_cron: true,\n      batch_limit: 3,\n      worker_id: workerId,\n      role_id: roleId,\n\n      // —— 你示例所需的完整欄位 ——\n      message_id: null,\n      thread_id: null,\n      client_msg_id: null,\n      assigned_role_id: roleId,\n      user_id: null,\n      text: '',\n      selected_role: {},\n      group_roles: [],\n      project_info: {},\n      trigger_workflow: inferWorkflow(roleId, workerId),\n    }\n  }];\n}\n\n// Immediate：逐筆輸出完整欄位\nreturn list.map(it => {\n  const j = it?.json ?? {};\n\n  const triggerType = (j.trigger_type ?? 'immediate').toString().trim();\n  const workerId    = (j.worker_id ?? 'hibi-processor').toString().trim();\n  const roleId      = (j.role_id   ?? j.assigned_role_id ?? j?.selected_role?.id ?? 'hibi-manager').toString().trim();\n\n  const groupRolesNormalized = normalizeGroupRoles(j.group_roles ?? j.group_roles_compact ?? []);\n\n  const out = {\n    // —— 路由欄位 ——\n    trigger_type: triggerType,\n    is_immediate: triggerType === 'immediate',\n    is_cron:      triggerType === 'cron',\n    batch_limit:  j.batch_limit ?? 1, // 即時預設單筆\n    worker_id:    workerId,\n    role_id:      roleId,\n\n    // —— 你示例所需的完整欄位 ——\n    message_id:       j.message_id ?? null,\n    thread_id:        j.thread_id ?? null,\n    client_msg_id:    j.client_msg_id ?? null,\n    assigned_role_id: j.assigned_role_id ?? roleId,\n    user_id:          j.user_id ?? null,\n    text:             j.text ?? '',\n    selected_role:    j.selected_role ?? {},\n    group_roles:      groupRolesNormalized,\n    project_info:     j.project_info ?? {},\n    trigger_workflow: j.trigger_workflow || inferWorkflow(roleId, workerId),\n  };\n\n  return {\n    json: out,\n    ...(it.binary ? { binary: it.binary } : {}),\n  };\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          336,
          416
        ],
        "id": "2bc40ab2-6e51-4fe1-ad71-5d66cbcf7647",
        "name": "TriggerRouter"
      },
      {
        "parameters": {
          "operation": "executeQuery",
          "query": "-- 修正後的查詢（用於 n8n executeQuery 節點）\nWITH picked AS (\n  SELECT\n    cm.id,\n    cm.thread_id,\n    cm.content,\n    cm.client_msg_id,\n    cm.created_at,\n    cm.status,\n    ct.user_id,  -- 通過 thread_id 關聯獲取 user_id\n    cm.assigned_role_id as selected_role_id  -- 使用正確的欄位名\n  FROM chat_messages cm\n  INNER JOIN chat_threads ct ON cm.thread_id = ct.id  -- 改為 INNER JOIN\n  WHERE\n    -- 即時觸發：處理特定訊息\n    (NULLIF($1, '')::uuid IS NOT NULL AND cm.id = NULLIF($1, '')::uuid)\n    OR\n    -- 批次掃描：處理 queued + 指定角色（硬編碼 hibi-manager）\n    (NULLIF($1, '')::uuid IS NULL AND cm.status = 'queued' AND cm.assigned_role_id = 'hibi-manager')\n  ORDER BY cm.created_at ASC\n  LIMIT CASE\n           WHEN NULLIF($1, '')::uuid IS NOT NULL THEN 1\n           ELSE GREATEST(1, COALESCE(CAST($2 AS INTEGER), 3))\n        END\n  FOR UPDATE SKIP LOCKED\n)\nUPDATE chat_messages AS u\nSET\n  status               = 'processing',\n  processing_lock_id   = gen_random_uuid()::text,\n  processing_started_at= now(),\n  processing_worker_id = COALESCE($3, 'hibi-processor'),\n  updated_at           = now()\nFROM picked p\nWHERE u.id = p.id\nRETURNING\n  u.id,\n  u.thread_id,\n  u.content,\n  u.client_msg_id,\n  u.created_at,\n  u.status,\n  p.user_id,  -- 從 picked 中獲取 user_id\n  u.assigned_role_id as selected_role_id,  -- 使用正確的欄位名\n  u.processing_lock_id,\n  u.processing_started_at,\n  u.processing_worker_id;",
          "options": {
            "queryReplacement": "=$1 = {{ $json.message_id || '' }}, $2 = {{ parseInt($json.batch_limit) || 3 }}, $3 = {{ $json.worker_id || 'hibi-processor' }}, $4 = {{ $json.role_id || 'hibi-manager' }}"
          }
        },
        "type": "n8n-nodes-base.postgres",
        "typeVersion": 2.6,
        "position": [
          544,
          416
        ],
        "id": "023c0407-6eaf-42a0-885d-5d8984669c83",
        "name": "executeQuery",
        "credentials": {
          "postgres": {
            "id": "UrO5b3fCBNg43wlC",
            "name": "HanamiEcho"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// n8n Code node (Node.js)\n// Input: items[]，每筆放在 item.json\n// Output: 僅保留 status === 'processing' 且有 id 的筆數\n\n// 若上游偶爾把一個「陣列」包在單一 item.json 內，這裡一併支援：\nfunction expandIfWrapped(inputItems) {\n  if (inputItems.length === 1) {\n    const j = inputItems[0]?.json;\n    if (Array.isArray(j)) {\n      return j.map(x => ({ json: x }));\n    }\n    if (Array.isArray(j?.messages)) {\n      return j.messages.map(x => ({ json: x }));\n    }\n  }\n  return inputItems;\n}\n\nconst list = expandIfWrapped(items);\nconst batchSize = list.length;\n\nconst out = list\n  .filter(it => it?.json?.id && it?.json?.status === 'processing')\n  .map(it => ({\n    json: {\n      ...it.json,\n      batch_size: batchSize,\n      processing_started: true,\n      processing_started_at: new Date().toISOString(),\n    },\n    // 保留 binary（若有）\n    ...(it.binary ? { binary: it.binary } : {}),\n  }));\n\n// 若你希望「沒有匹配」時也回傳一筆提示，改用下方這行：\n// if (!out.length) return [{ json: { note: 'no processing items', batch_size: batchSize } }];\n\nreturn out;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          752,
          416
        ],
        "id": "4895f6d4-dae5-4e21-ac78-4062d221e03a",
        "name": "SmartMessageFetcher"
      }
    ],
    "connections": {
      "CheckMessageExists": {
        "main": [
          [
            {
              "node": "CheckFoodBalance2",
              "type": "main",
              "index": 0
            }
          ],
          []
        ]
      },
      "FixJSONResponse2": {
        "main": [
          [
            {
              "node": "BuildResponse200",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "200FormatError2": {
        "main": [
          [
            {
              "node": "FixJSONResponse2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "InsertMessageCosts2": {
        "main": [
          [
            {
              "node": "MarkUserMsgCompleted2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "SpendFoodAndTx2": {
        "main": [
          [
            {
              "node": "InsertMessageCosts2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "MarkUserMsgCompleted2": {
        "main": [
          []
        ]
      },
      "InsertAssistantMessage2": {
        "main": [
          [
            {
              "node": "SpendFoodAndTx2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "FormatOutput2": {
        "main": [
          [
            {
              "node": "InsertAssistantMessage2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "OpenRouterAI2": {
        "main": [
          [
            {
              "node": "FormatOutput2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ExtractMemory2": {
        "main": [
          [
            {
              "node": "BuildMessages2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ReadMemory2": {
        "main": [
          [
            {
              "node": "ExtractMemory2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "BuildMessages2": {
        "main": [
          [
            {
              "node": "OpenRouterAI2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "MarkUserProcessing2": {
        "main": [
          [
            {
              "node": "ReadMemory2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Estimate&GateBudget2": {
        "main": [
          [
            {
              "node": "IFBalance2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "402FormatError2": {
        "main": [
          [
            {
              "node": "Respond403",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "IFBalance2": {
        "main": [
          [
            {
              "node": "MarkUserProcessing2",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "ErrorBalance2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "NormalizeBalance2": {
        "main": [
          [
            {
              "node": "Estimate&GateBudget2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "CheckFoodBalance2": {
        "main": [
          [
            {
              "node": "NormalizeBalance2",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "CollectMessageFields1": {
        "main": [
          [
            {
              "node": "CheckMessage",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "CheckMessage": {
        "main": [
          [
            {
              "node": "CheckMessageExists",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "ImmediateTrigger": {
        "main": [
          [
            {
              "node": "TriggerRouter",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "CronTrigger": {
        "main": [
          [
            {
              "node": "TriggerRouter",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "TriggerRouter": {
        "main": [
          [
            {
              "node": "executeQuery",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "executeQuery": {
        "main": [
          [
            {
              "node": "SmartMessageFetcher",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "SmartMessageFetcher": {
        "main": [
          [
            {
              "node": "CollectMessageFields1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "pinData": {
      "ImmediateTrigger": [
        {
          "message_id": "c79f35ac-9b5e-481c-90ea-ed452e7b150d",
          "thread_id": "0295b429-ac89-40dd-a2a2-3a7cccd468ae",
          "client_msg_id": "01K8JQ3WG1SEJB2J2C21X5VH4M",
          "assigned_role_id": "hibi-manager",
          "user_id": "4b8fcd8f-ea99-42f6-8509-88018aac7a3d",
          "text": "hi",
          "selected_role": {
            "id": "hibi-manager",
            "name": "希希 (Hibi)",
            "models": [
              "openai/gpt-5-mini"
            ],
            "tone": "友善、專業、有條理。語氣專注在整體進度，帶有協調與管理的口吻；強調清晰分工，確保合作順暢並持續更新狀態。\n",
            "guidance": "你是 Hibi，Hanami Echo 的系統總管和中央協調者。你負責：\n1. 統籌和分配任務給適合的 AI 角色\n2. 協調專案中多位角色之間的合作\n3. 確保工作流程順暢並提供進度更新\n4. 作為用戶與各個專業角色之間的橋樑\n\n請以友善、專業且有條理的方式回應，始終關注任務的整體進度和品質。"
          },
          "group_roles": [
            {
              "id": "hibi-manager",
              "name": "希希 (Hibi)",
              "model": "openai/gpt-5-mini",
              "tone": "友善、專業、有條理。語氣專注在整體進度，帶有協調與管理的口吻；強調清晰分工，確保合作順暢並持續更新狀態。",
              "guidance": "你是 Hibi，Hanami Echo 的系統總管和中央協調者。你負責：\n1. 統籌和分配任務給適合的 AI 角色\n2. 協調專案中多位角色之間的合作\n3. 確保工作流程順暢並提供進度更新\n4. 作為用戶與各個專業角色之間的橋樑\n\n請以友善、專業且有條理的方式回應，始終關注任務的整體進度和品質。"
            }
          ],
          "project_info": {
            "title": "查詢內容",
            "description": "由 Hibi 開始的專案協作空間",
            "guidance": "由 Hibi 開始的專案協作空間"
          },
          "trigger_workflow": "hibi-processor"
        }
      ]
    },
    "meta": {
      "templateCredsSetupCompleted": true,
      "instanceId": "4b2fb6f84ef91181f85de1277717d6717566b015633b0c427e51a39fe81532f2"
    }
  }