# 權限系統緊急修復指南

## 概述
本指南將幫助您修復 Hanami Web 專案的權限系統，確保管理員可以正常訪問所有資料，並為所有用戶建立適當的權限記錄。

## 修復步驟

### 步驟 1：執行緊急修復腳本

1. **登入 Supabase Dashboard**
   - 前往 [https://supabase.com/dashboard](https://supabase.com/dashboard)
   - 選擇您的 Hanami Web 專案

2. **進入 SQL 編輯器**
   - 在左側選單中點擊 "SQL Editor"
   - 點擊 "New query" 創建新的查詢

3. **執行修復腳本**
   - 複製 `simple_emergency_fix.sql` 文件的內容
   - 貼上到 SQL 編輯器中
   - 點擊 "Run" 執行腳本

### 步驟 2：驗證修復結果

執行完成後，您應該看到以下結果：

1. **權限記錄統計**
   - 顯示各類型用戶的權限記錄數量
   - 確認所有管理員、老師、家長都有權限記錄

2. **權限檢查函數測試**
   - 顯示權限檢查函數是否正常工作
   - 確認管理員權限設置正確

3. **完成訊息**
   - 顯示 "緊急修復完成" 訊息
   - 提醒 RLS 已暫時禁用

### 步驟 3：測試前端功能

1. **重新啟動開發伺服器**
   ```bash
   npm run dev
   ```

2. **測試管理員登入**
   - 使用管理員帳號登入
   - 確認可以正常訪問學生資料
   - 確認可以正常訪問權限管理頁面

3. **測試權限管理功能**
   - 前往 `/admin/permissions` 頁面
   - 確認可以查看和編輯用戶權限
   - 測試批量權限設置功能

## 修復內容說明

### 1. 權限記錄創建
- **管理員**：獲得所有權限，包括查看所有學生、管理老師、管理學生等
- **老師**：獲得基本權限，可以管理課程，但不能查看所有學生
- **家長**：獲得限制權限，只能查看自己孩子的進度

### 2. 資料庫權限設置
- 確保所有表都有適當的讀寫權限
- 為 authenticated 和 service_role 用戶授予必要權限

### 3. RLS 暫時禁用
- 暫時禁用 Row Level Security 以確保基本功能正常
- 在確認系統正常後可以重新啟用

### 4. 權限檢查函數
- 創建 `check_user_permission` 函數
- 提供統一的權限檢查介面

## 後續步驟

### 1. 重新啟用 RLS（可選）
在確認系統正常運作後，您可以重新啟用 RLS：

```sql
-- 重新啟用 RLS
ALTER TABLE "Hanami_Students" ENABLE ROW LEVEL SECURITY;
ALTER TABLE hanami_student_lesson ENABLE ROW LEVEL SECURITY;
ALTER TABLE hanami_employee ENABLE ROW LEVEL SECURITY;
ALTER TABLE hanami_admin ENABLE ROW LEVEL SECURITY;
```

### 2. 設置老師-學生關聯
如果需要更細緻的權限控制，可以設置老師-學生關聯：

```sql
-- 為老師添加學生關聯
INSERT INTO hanami_teacher_student_relations (
  teacher_id,
  student_id,
  can_view_student_data,
  can_edit_student_data,
  can_view_lessons,
  can_edit_lessons,
  can_view_progress,
  can_edit_progress
) VALUES (
  'teacher-uuid',
  'student-uuid',
  true,
  false,
  true,
  true,
  true,
  true
);
```

### 3. 設置家長-學生關聯
為家長設置學生關聯：

```sql
-- 為家長添加學生關聯
INSERT INTO hanami_parent_student_relations (
  parent_id,
  student_id,
  can_view_student_data,
  can_view_lessons,
  can_view_progress,
  can_view_financial_data
) VALUES (
  'parent-uuid',
  'student-uuid',
  true,
  true,
  true,
  false
);
```

## 故障排除

### 問題 1：權限記錄創建失敗
**症狀**：執行腳本時出現錯誤
**解決方案**：
- 檢查 `hanami_user_permissions` 表是否存在
- 確認表結構是否正確
- 檢查是否有重複的用戶郵箱

### 問題 2：管理員仍無法訪問資料
**症狀**：管理員登入後無法查看學生資料
**解決方案**：
- 確認管理員的權限記錄已創建
- 檢查 `is_active` 欄位是否為 `true`
- 確認 RLS 已正確禁用

### 問題 3：前端權限檢查失敗
**症狀**：前端顯示權限錯誤
**解決方案**：
- 檢查 `permissionUtils.ts` 中的權限檢查邏輯
- 確認 Supabase 客戶端配置正確
- 檢查用戶會話是否正常

## 聯繫支援

如果遇到無法解決的問題，請：
1. 檢查 Supabase 日誌
2. 查看瀏覽器控制台錯誤
3. 確認環境變數設置正確
4. 聯繫技術支援

---

**注意**：此修復腳本會暫時禁用 RLS 以確保基本功能正常。在生產環境中，建議在確認系統穩定後重新啟用 RLS 並設置適當的安全策略。 