-- 計算剩餘堂數的 RPC 函數
-- 使用 student_id 分組，不考慮 status，確保結果準確

CREATE OR REPLACE FUNCTION calculate_remaining_lessons_batch(
  student_ids UUID[],
  today_date DATE
)
RETURNS TABLE (
  student_id UUID,
  remaining_lessons BIGINT
) 
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    hsl.student_id,
    COUNT(*)::BIGINT AS remaining_lessons
  FROM hanami_student_lesson hsl
  WHERE hsl.student_id = ANY(student_ids)
    AND hsl.lesson_date >= today_date
  GROUP BY hsl.student_id;
END;
$$;

-- 如果需要更詳細的查詢（包含學生姓名等），可以使用以下函數
CREATE OR REPLACE FUNCTION calculate_remaining_lessons_detailed(
  student_ids UUID[],
  today_date DATE
)
RETURNS TABLE (
  student_id UUID,
  full_name TEXT,
  remaining_lessons BIGINT,
  next_lesson_date DATE,
  next_lesson_time TIME,
  course_type TEXT
) 
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT 
    hsl.student_id,
    MIN(hs.full_name) AS full_name,
    COUNT(*)::BIGINT AS remaining_lessons,
    MIN(hsl.lesson_date) AS next_lesson_date,
    MIN(hsl.actual_timeslot) AS next_lesson_time,
    MIN(hsl.course_type) AS course_type
  FROM hanami_student_lesson hsl
  LEFT JOIN "Hanami_Students" hs ON hsl.student_id = hs.id
  WHERE hsl.student_id = ANY(student_ids)
    AND hsl.lesson_date >= today_date
  GROUP BY hsl.student_id
  ORDER BY next_lesson_date, next_lesson_time;
END;
$$;