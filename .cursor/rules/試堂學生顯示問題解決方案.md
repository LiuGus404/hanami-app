# 試堂學生顯示問題解決方案

## 問題描述
在學生管理頁面中，試堂學生無法正常顯示，只能顯示常規學生和停用學生。

## 問題分析
經過代碼分析，發現可能的原因包括：

1. **試堂學生表不存在**：`hanami_trial_students` 表可能沒有被創建
2. **表存在但無資料**：表存在但沒有試堂學生資料
3. **RLS策略問題**：行級安全策略可能阻止了資料讀取
4. **權限問題**：用戶可能沒有讀取試堂學生表的權限

## 解決方案

### 步驟 1：執行資料庫修復腳本

在 Supabase SQL 編輯器中執行以下腳本：

1. **執行 `fix_trial_students.sql`**：
   - 檢查試堂學生表是否存在
   - 如果不存在，自動創建表
   - 設置正確的欄位結構
   - 創建必要的索引
   - 設置 RLS 策略
   - 插入測試資料（如果表為空）

2. **執行 `simple_trial_diagnosis.sql`**（推薦）：
   - 簡單的診斷腳本，不依賴自定義函數
   - 檢查表狀態、結構、資料數量
   - 檢查 RLS 策略和權限
   - 自動插入測試資料（如果需要）

### 步驟 2：使用頁面調試工具

在學生管理頁面中，使用新增的調試工具：

1. **點擊「詳細診斷」按鈕**：
   - 檢查試堂學生表狀態
   - 查看資料數量
   - 檢查 RLS 策略
   - 查看錯誤信息

2. **點擊「插入測試資料」按鈕**：
   - 自動插入一條測試試堂學生資料
   - 驗證表是否正常工作

3. **點擊「只顯示試堂學生」按鈕**：
   - 測試試堂學生篩選功能

### 步驟 3：檢查篩選邏輯

代碼中的篩選邏輯已經正確處理了試堂學生：

```typescript
// 課程篩選邏輯
const courseMatch = selectedCourses.some((selected) => {
  if (selected === '試堂') {
    return student.student_type === '試堂'
  }
  // ... 其他邏輯
})

// 星期篩選邏輯
const weekdayMatch = regularWeekdays.some((day: string) => selectedWeekdays.includes(day)) ||
  (trialWeekday && selectedWeekdays.includes(trialWeekday))
```

### 步驟 4：驗證修復結果

修復完成後，應該能夠：

1. **正常顯示試堂學生**：在學生列表中看到試堂學生
2. **正確篩選**：使用「試堂」篩選條件只顯示試堂學生
3. **正確排序**：試堂學生按試堂日期排序
4. **正確操作**：可以刪除試堂學生（但不能停用）

## 試堂學生資料結構

試堂學生表 `hanami_trial_students` 包含以下欄位：

- `id`: UUID 主鍵
- `full_name`: 學生姓名
- `student_dob`: 出生日期
- `gender`: 性別（男/女）
- `course_type`: 課程類型
- `lesson_date`: 試堂日期
- `actual_timeslot`: 試堂時間
- `student_preference`: 學生偏好
- `contact_number`: 聯絡電話
- `parent_email`: 家長郵箱
- `school`: 學校
- `address`: 地址
- `student_teacher`: 負責老師
- `health_notes`: 健康備註
- `student_oid`: 學生編號
- `remaining_lessons`: 剩餘堂數（預設為1）
- `duration_months`: 課程時長（預設為1）

## 試堂學生與常規學生的區別

| 特性 | 常規學生 | 試堂學生 |
|------|----------|----------|
| 資料表 | `Hanami_Students` | `hanami_trial_students` |
| 學生類型 | 非「試堂」 | 「試堂」 |
| 星期格式 | 數字陣列 | 單一數字 |
| 入學日期 | `started_date` | `lesson_date` |
| 剩餘堂數 | 可大於1 | 通常為1 |
| 操作限制 | 可停用 | 只能刪除 |

## 故障排除

### 如果試堂學生仍然不顯示：

1. **檢查控制台錯誤**：
   - 打開瀏覽器開發者工具
   - 查看 Console 標籤中的錯誤信息

2. **檢查網路請求**：
   - 查看 Network 標籤
   - 檢查 Supabase 請求是否成功

3. **檢查資料庫權限**：
   - 確認用戶有讀取 `hanami_trial_students` 表的權限
   - 檢查 RLS 策略是否正確

4. **重新執行修復腳本**：
   - 如果問題持續，重新執行 `fix_trial_students.sql`

### 常見錯誤及解決方法：

1. **"relation does not exist"**：
   - 執行 `fix_trial_students.sql` 創建表

2. **"permission denied"**：
   - 檢查 RLS 策略
   - 確認用戶認證狀態

3. **"invalid input syntax"**：
   - 檢查資料格式
   - 確認日期格式正確

## 聯繫支持

如果問題仍然存在，請提供以下信息：

1. 瀏覽器控制台的錯誤信息
2. 網路請求的響應狀態
3. 執行的 SQL 腳本結果
4. 頁面調試工具的輸出

---

**注意**：此解決方案已更新學生管理頁面，添加了詳細的調試工具，可以幫助診斷和解決試堂學生顯示問題。 