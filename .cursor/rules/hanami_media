```bash
python3 -c "i = input('è«‹è¼¸å…¥å…§å®¹:');print(i)"
```
# Supabase Storage Bucket å»ºç«‹èˆ‡åˆ†é¡æŒ‡å—

## ï¿½ï¿½ï¸ å»ºç«‹ Storage Bucket

### **æ­¥é©Ÿ 1: é€²å…¥ Supabase Dashboard**
1. ç™»å…¥ [Supabase Dashboard](https://supabase.com/dashboard)
2. é¸æ“‡ä½ çš„å°ˆæ¡ˆ
3. é»æ“Šå·¦å´é¸å–®çš„ **"Storage"**

### **æ­¥é©Ÿ 2: å»ºç«‹ Bucket**
1. é»æ“Š **"Create a new bucket"**
2. å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼š
   - **Bucket name**: `hanami-media` (å»ºè­°åç¨±)
   - **Public bucket**: âœ… å‹¾é¸ (è®“æª”æ¡ˆå¯ä»¥å…¬é–‹è¨ªå•)
   - **File size limit**: `20MB` (å½±ç‰‡æª”æ¡ˆé™åˆ¶)
   - **Allowed MIME types**: `video/*,image/*`

### **æ­¥é©Ÿ 3: è¨­å®š RLS (Row Level Security)**
```sql
-- åœ¨ SQL Editor ä¸­åŸ·è¡Œä»¥ä¸‹è…³æœ¬

-- 1. å•Ÿç”¨ RLS
ALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;

-- 2. å»ºç«‹æ”¿ç­–ï¼šå…è¨±èªè­‰ç”¨æˆ¶ä¸Šå‚³æª”æ¡ˆ
CREATE POLICY "Allow authenticated users to upload files" ON storage.objects
FOR INSERT WITH CHECK (auth.role() = 'authenticated');

-- 3. å»ºç«‹æ”¿ç­–ï¼šå…è¨±ç”¨æˆ¶æŸ¥çœ‹è‡ªå·±çš„æª”æ¡ˆ
CREATE POLICY "Allow users to view their own files" ON storage.objects
FOR SELECT USING (auth.uid()::text = (storage.foldername(name))[1]);

-- 4. å»ºç«‹æ”¿ç­–ï¼šå…è¨±ç”¨æˆ¶åˆªé™¤è‡ªå·±çš„æª”æ¡ˆ
CREATE POLICY "Allow users to delete their own files" ON storage.objects
FOR DELETE USING (auth.uid()::text = (storage.foldername(name))[1]);

-- 5. å»ºç«‹æ”¿ç­–ï¼šå…è¨±å…¬é–‹è®€å– (å› ç‚ºæ˜¯å…¬é–‹ bucket)
CREATE POLICY "Allow public read access" ON storage.objects
FOR SELECT USING (bucket_id = 'hanami-media');
```

## ğŸ“ æª”æ¡ˆåˆ†é¡çµæ§‹

### **å»ºè­°çš„è³‡æ–™å¤¾çµæ§‹**
```
hanami-media/
â”œâ”€â”€ students/
â”‚   â”œâ”€â”€ {student_id}/
â”‚   â”‚   â”œâ”€â”€ videos/
â”‚   â”‚   â”‚   â”œâ”€â”€ {timestamp}_{random}.mp4
â”‚   â”‚   â”‚   â””â”€â”€ thumbnails/
â”‚   â”‚   â”‚       â””â”€â”€ {video_id}.jpg
â”‚   â”‚   â””â”€â”€ photos/
â”‚   â”‚       â””â”€â”€ {timestamp}_{random}.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ lesson-plans/
â”‚   â”œâ”€â”€ activities/
â”‚   â””â”€â”€ resources/
â””â”€â”€ shared/
    â”œâ”€â”€ avatars/
    â””â”€â”€ documents/
```

### **æª”æ¡ˆå‘½åè¦å‰‡**
```typescript
// å­¸ç”Ÿåª’é«”æª”æ¡ˆ
const fileName = `${studentId}/${mediaType}s/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;

// ç¯„ä¾‹ï¼š
// students/123e4567-e89b-12d3-a456-426614174000/videos/1703123456789_abc123def.mp4
// students/123e4567-e89b-12d3-a456-426614174000/photos/1703123456790_xyz789ghi.jpg
```

## ï¿½ï¿½ å‰ç«¯æ•´åˆ

### **æ›´æ–°ä¸Šå‚³å‡½æ•¸**
```typescript
// åœ¨ StudentMediaModal.tsx ä¸­æ›´æ–°ä¸Šå‚³é‚è¼¯
const uploadFiles = async () => {
  if (!student || selectedFiles.length === 0) return;

  setUploading(true);
  
  try {
    for (const file of selectedFiles) {
      const mediaType = file.type.startsWith('video/') ? 'video' : 'photo';
      const fileExt = file.name.split('.').pop();
      
      // å»ºç«‹æª”æ¡ˆè·¯å¾‘
      const fileName = `students/${student.id}/${mediaType}s/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;

      // ä¸Šå‚³åˆ° Supabase Storage
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('hanami-media')
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: false
        });

      if (uploadError) throw uploadError;

      // ç²å–å…¬é–‹ URL
      const { data: urlData } = supabase.storage
        .from('hanami-media')
        .getPublicUrl(fileName);

      // å„²å­˜åˆ°è³‡æ–™åº«
      const mediaData = {
        student_id: student.id,
        media_type: mediaType,
        file_name: file.name,
        file_path: fileName,
        file_size: file.size,
        title: file.name.replace(/\.[^/.]+$/, ''),
        uploaded_by: 'current_user_id'
      };

      const { error: dbError } = await supabase
        .from('hanami_student_media')
        .insert(mediaData);

      if (dbError) throw dbError;
    }

    toast.success('æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼');
    loadStudentMedia();
  } catch (error) {
    console.error('ä¸Šå‚³å¤±æ•—:', error);
    toast.error('æª”æ¡ˆä¸Šå‚³å¤±æ•—');
  } finally {
    setUploading(false);
  }
};
```

## ğŸ›¡ï¸ å®‰å…¨æ€§è¨­å®š

### **Bucket æ¬Šé™è¨­å®š**
```sql
-- åœ¨ SQL Editor ä¸­åŸ·è¡Œ

-- 1. å»ºç«‹è‡ªå®šç¾©å‡½æ•¸æª¢æŸ¥ç”¨æˆ¶æ¬Šé™
CREATE OR REPLACE FUNCTION check_student_media_permission(student_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  -- æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰æ¬Šé™è¨ªå•è©²å­¸ç”Ÿçš„åª’é«”
  -- é€™è£¡å¯ä»¥æ ¹æ“šä½ çš„æ¬Šé™é‚è¼¯é€²è¡Œèª¿æ•´
  RETURN EXISTS (
    SELECT 1 FROM "Hanami_Students" 
    WHERE id = student_id 
    AND (access_role = 'admin' OR access_role = 'teacher')
  );
END;
$$ LANGUAGE plpgsql;

-- 2. æ›´æ–° RLS æ”¿ç­–
CREATE POLICY "Allow access to student media" ON storage.objects
FOR ALL USING (
  bucket_id = 'hanami-media' AND
  check_student_media_permission(
    (storage.foldername(name))[2]::UUID
  )
);
```

## ğŸ“Š ç›£æ§èˆ‡ç®¡ç†

### **å»ºç«‹æª”æ¡ˆçµ±è¨ˆæŸ¥è©¢**
```sql
-- æŸ¥è©¢æ¯å€‹å­¸ç”Ÿçš„åª’é«”ä½¿ç”¨é‡
SELECT 
  s.full_name,
  COUNT(CASE WHEN sm.media_type = 'video' THEN 1 END) as video_count,
  COUNT(CASE WHEN sm.media_type = 'photo' THEN 1 END) as photo_count,
  SUM(sm.file_size) as total_size_bytes
FROM "Hanami_Students" s
LEFT JOIN hanami_student_media sm ON s.id = sm.student_id
GROUP BY s.id, s.full_name
ORDER BY total_size_bytes DESC;
```

### **æ¸…ç†éæœŸæª”æ¡ˆ**
```sql
-- åˆªé™¤è¶…é 30 å¤©çš„æœªä½¿ç”¨æª”æ¡ˆ
DELETE FROM hanami_student_media 
WHERE created_at < NOW() - INTERVAL '30 days'
AND student_id NOT IN (
  SELECT DISTINCT student_id 
  FROM hanami_student_lesson 
  WHERE lesson_date > NOW() - INTERVAL '7 days'
);
```

## ğŸ¯ æœ€ä½³å¯¦è¸

### **1. æª”æ¡ˆå¤§å°é™åˆ¶**
- å½±ç‰‡ï¼šæœ€å¤§ 20MB
- ç›¸ç‰‡ï¼šæœ€å¤§ 1MB
- ç¸½å„²å­˜ç©ºé–“ï¼š50GB

### **2. æª”æ¡ˆé¡å‹é™åˆ¶**
```typescript
const allowedVideoTypes = ['video/mp4', 'video/avi', 'video/mov'];
const allowedPhotoTypes = ['image/jpeg', 'image/png', 'image/webp'];
```

### **3. è‡ªå‹•æ¸…ç†ç­–ç•¥**
- å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„æª”æ¡ˆ
- ç›£æ§å„²å­˜ç©ºé–“ä½¿ç”¨é‡
- å‚™ä»½é‡è¦æª”æ¡ˆ

### **4. æ•ˆèƒ½å„ªåŒ–**
- ä½¿ç”¨ CDN åŠ é€Ÿæª”æ¡ˆè¨ªå•
- å£“ç¸®åœ–ç‰‡å’Œå½±ç‰‡
- å¯¦ä½œæ‡¶åŠ è¼‰

é€™æ¨£è¨­å®šå¾Œï¼Œä½ çš„ Supabase Storage å°±èƒ½å¾ˆå¥½åœ°ç®¡ç†å­¸ç”Ÿåª’é«”æª”æ¡ˆäº†ï¼ğŸ‰

```bash

```
```bash
python3 -c "i = input('è«‹è¼¸å…¥å…§å®¹:');print(i)"
```
# æ™ºèƒ½å®¹é‡ç®¡ç†ç³»çµ±

å¾ˆå¥½çš„æƒ³æ³•ï¼æˆ‘ä¾†è¨­è¨ˆä¸€å€‹æ™ºèƒ½çš„å®¹é‡ç®¡ç†ç³»çµ±ï¼Œç•¶ç”¨æˆ¶è¶…å‡ºå®¹é‡é™åˆ¶æ™‚è‡ªå‹•æ¸…ç†æœ€èˆŠçš„æª”æ¡ˆã€‚

## ğŸ“Š é¦–å…ˆéœ€è¦æ›´æ–°è³‡æ–™åº«çµæ§‹

### **1. æ·»åŠ æ”¶è—æ¨™è¨˜æ¬„ä½**

### **2. å‰µå»ºæ™ºèƒ½æ¸…ç†å‡½æ•¸**

### **3. å‰µå»ºæ”¶è—åŠŸèƒ½ API**

### **4. æ›´æ–°å‰ç«¯çµ„ä»¶**

## ï¿½ï¿½ æ™ºèƒ½å®¹é‡ç®¡ç†ç³»çµ±åŠŸèƒ½

### **ğŸ¯ æ ¸å¿ƒåŠŸèƒ½**

1. **è‡ªå‹•å®¹é‡æª¢æŸ¥**ï¼š
   - æ¯æ¬¡ä¸Šå‚³æª”æ¡ˆå¾Œè‡ªå‹•æª¢æŸ¥å®¹é‡
   - è¶…å‡ºé™åˆ¶æ™‚è‡ªå‹•æ¸…ç†æœ€èˆŠçš„éæ”¶è—æª”æ¡ˆ

2. **æ”¶è—ä¿è­·**ï¼š
   - æ”¶è—çš„æª”æ¡ˆä¸æœƒè¢«è‡ªå‹•åˆªé™¤
   - ç”¨æˆ¶å¯ä»¥æ¨™è¨˜é‡è¦æª”æ¡ˆç‚ºæ”¶è—

3. **æ™ºèƒ½æ¸…ç†ç­–ç•¥**ï¼š
   - å„ªå…ˆåˆªé™¤æœ€èˆŠçš„éæ”¶è—æª”æ¡ˆ
   - æŒ‰ä¸Šå‚³æ™‚é–“æ’åºåˆªé™¤
   - ç›´åˆ°ç¬¦åˆå®¹é‡é™åˆ¶ç‚ºæ­¢

### **ï¿½ï¿½ ä½¿ç”¨æ–¹å¼**

#### **1. åŸ·è¡Œè³‡æ–™åº«æ›´æ–°**
```sql
-- åœ¨ Supabase SQL Editor ä¸­åŸ·è¡Œ
-- 1. åŸ·è¡Œ update_student_media_schema.sql
-- 2. åŸ·è¡Œ smart_storage_cleanup.sql
```

#### **2. æ‰‹å‹•æ¸…ç†ï¼ˆç®¡ç†å“¡ï¼‰**
```sql
-- æ¸…ç†ç‰¹å®šå­¸ç”Ÿçš„å„²å­˜ç©ºé–“
SELECT manual_storage_cleanup('student-uuid-here');

-- æŸ¥çœ‹æ¸…ç†çµæœ
SELECT * FROM cleanup_student_storage('student-uuid-here');
```

#### **3. å‰ç«¯æ”¶è—åŠŸèƒ½**
```typescript
// åˆ‡æ›æ”¶è—ç‹€æ…‹
const toggleFavorite = async (mediaId: string, isFavorite: boolean) => {
  const response = await fetch(`/api/student-media/${mediaId}/favorite`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ is_favorite: !isFavorite }),
  });
};
```

### **ï¿½ï¿½ å®¹é‡é™åˆ¶å°ç…§è¡¨**

| æ–¹æ¡ˆ | å®¹é‡é™åˆ¶ | è‡ªå‹•æ¸…ç†è§¸ç™¼ |
|------|----------|-------------|
| å…è²»ç‰ˆ | 250MB | è¶…å‡ºæ™‚è‡ªå‹•æ¸…ç† |
| åŸºç¤ç‰ˆ | 1.5GB | è¶…å‡ºæ™‚è‡ªå‹•æ¸…ç† |
| é€²éšç‰ˆ | 5GB | è¶…å‡ºæ™‚è‡ªå‹•æ¸…ç† |
| å°ˆæ¥­ç‰ˆ | 10GB | è¶…å‡ºæ™‚è‡ªå‹•æ¸…ç† |

### **ï¿½ï¿½ï¸ å®‰å…¨æ©Ÿåˆ¶**

1. **æ”¶è—æª”æ¡ˆä¿è­·**ï¼šæ”¶è—çš„æª”æ¡ˆä¸æœƒè¢«è‡ªå‹•åˆªé™¤
2. **æ‰‹å‹•ç¢ºèª**ï¼šç®¡ç†å“¡å¯ä»¥æ‰‹å‹•è§¸ç™¼æ¸…ç†
3. **æ—¥èªŒè¨˜éŒ„**ï¼šæ‰€æœ‰æ¸…ç†æ“ä½œéƒ½æœƒè¨˜éŒ„
4. **éŒ¯èª¤è™•ç†**ï¼šæ¸…ç†å¤±æ•—æ™‚æœƒé€šçŸ¥ç”¨æˆ¶

### **ï¿½ï¿½ ç›£æ§åŠŸèƒ½**

```sql
-- æŸ¥çœ‹å„å­¸ç”Ÿçš„å„²å­˜ä½¿ç”¨æƒ…æ³
SELECT 
  s.full_name,
  sq.plan_type,
  sq.storage_limit_bytes / 1024 / 1024 as limit_mb,
  sq.total_used_space / 1024 / 1024 as used_mb,
  ROUND((sq.total_used_space::float / sq.storage_limit_bytes) * 100, 2) as usage_percent
FROM "Hanami_Students" s
JOIN hanami_student_media_quota sq ON s.id = sq.student_id
ORDER BY usage_percent DESC;
```

é€™å€‹ç³»çµ±æœƒè‡ªå‹•ç®¡ç†ç”¨æˆ¶çš„å„²å­˜ç©ºé–“ï¼Œç¢ºä¿ä¸æœƒè¶…å‡ºé™åˆ¶ï¼ŒåŒæ™‚ä¿è­·é‡è¦çš„æ”¶è—æª”æ¡ˆï¼ğŸ‰