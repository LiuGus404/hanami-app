# 學生管理功能測試指南

## 概述
本指南涵蓋 Hanami Web 教育管理系統學生管理功能的完整測試流程，包括外鍵約束問題的解決方案。

## 外鍵約束問題解決方案

### 問題描述
刪除學生時遇到外鍵約束錯誤：`hanami_student_lesson_student_id_fkey`

### 解決方案
已更新刪除和停用功能，在刪除學生之前按以下順序處理外鍵依賴：

1. **刪除課堂記錄** (`hanami_student_lesson`)
2. **刪除進度記錄** (`hanami_student_progress`)
3. **刪除課程包** (`Hanami_Student_Package`)
4. **刪除試堂隊列** (`hanami_trial_queue`)
5. **最後刪除學生記錄** (`Hanami_Students`)

### 資料庫檢查腳本
使用 `database_foreign_key_check.sql` 腳本檢查資料庫狀態：

```sql
-- 在 Supabase SQL Editor 中執行
-- 檢查外鍵約束和孤立記錄
```

## 功能測試

### 1. 基本功能測試

#### 1.1 學生篩選功能
- [ ] 課程篩選：鋼琴、音樂專注力、未分班、常規、試堂、停用學生
- [ ] 星期篩選：星期一至星期日
- [ ] 堂數篩選：全部、> 2、≤ 2、自訂數字
- [ ] 姓名搜尋：即時搜尋功能

#### 1.2 學生操作功能
- [ ] 選擇學生：單選和多選功能
- [ ] 編輯學生：點擊編輯圖標進入學生詳情頁面
- [ ] 批量操作：支持多選學生進行批量操作

#### 1.3 列表排序功能
- [ ] 點擊欄目標題進行排序
- [ ] 再次點擊同一欄位切換升序/降序
- [ ] 排序圖標顯示正確（↕、↑、↓）
- [ ] 數字欄位按數字排序（年齡、剩餘堂數等）
- [ ] 日期欄位按日期排序（生日、入學日期等）
- [ ] 時間欄位按時間排序（上課時間、試堂時間等）
- [ ] 字符串欄位按字母排序（姓名、課程等）
- [ ] 上課日按數字排序
- [ ] 排序狀態在篩選後保持

### 2. 停用學生功能測試

#### 2.1 停用常規學生
- [ ] 選擇常規學生
- [ ] 點擊"停用學生"按鈕
- [ ] 確認操作
- [ ] 驗證學生從常規列表消失
- [ ] 驗證學生出現在停用學生列表
- [ ] 驗證停用學生顯示為灰色

#### 2.2 停用試堂學生
- [ ] 選擇試堂學生
- [ ] 點擊"停用學生"按鈕
- [ ] 確認操作
- [ ] 驗證學生從試堂列表消失
- [ ] 驗證學生出現在停用學生列表

#### 2.3 查看停用學生
- [ ] 在篩選課程中選擇"停用學生"
- [ ] 驗證停用學生列表顯示正確
- [ ] 驗證停用學生樣式為灰色
- [ ] 驗證停用日期信息顯示正確

### 3. 回復學生功能測試

#### 3.1 回復常規學生
- [ ] 在停用學生篩選中選擇要回復的學生
- [ ] 點擊"回復學生"按鈕
- [ ] 確認操作
- [ ] 驗證學生從停用列表消失
- [ ] 驗證學生出現在常規列表
- [ ] 驗證學生樣式恢復正常

#### 3.2 回復試堂學生
- [ ] 在停用學生篩選中選擇要回復的試堂學生
- [ ] 點擊"回復學生"按鈕
- [ ] 確認操作
- [ ] 驗證學生從停用列表消失
- [ ] 驗證學生出現在試堂列表

### 4. 刪除學生功能測試

#### 4.1 刪除常規學生（無外鍵依賴）
- [ ] 選擇沒有相關記錄的常規學生
- [ ] 點擊"刪除學生"按鈕
- [ ] 確認操作
- [ ] 驗證學生被永久刪除
- [ ] 驗證相關記錄也被刪除

#### 4.2 刪除常規學生（有外鍵依賴）
- [ ] 選擇有課堂記錄的常規學生
- [ ] 點擊"刪除學生"按鈕
- [ ] 確認操作
- [ ] 驗證外鍵依賴被正確處理
- [ ] 驗證學生和相關記錄都被刪除

#### 4.3 刪除試堂學生
- [ ] 選擇試堂學生
- [ ] 點擊"刪除學生"按鈕
- [ ] 確認操作
- [ ] 驗證學生被永久刪除

#### 4.4 刪除停用學生
- [ ] 在停用學生篩選中選擇要刪除的學生
- [ ] 點擊"刪除學生"按鈕
- [ ] 確認操作
- [ ] 驗證學生從停用列表永久刪除
- [ ] 驗證相關記錄也被刪除
- [ ] 驗證原始學生記錄（如果存在）也被刪除

### 5. 外鍵約束測試

#### 5.1 資料庫完整性檢查
- [ ] 執行資料庫檢查腳本
- [ ] 驗證沒有孤立記錄
- [ ] 驗證外鍵約束正常

#### 5.2 錯誤處理測試
- [ ] 測試刪除有複雜依賴的學生
- [ ] 驗證錯誤訊息顯示正確
- [ ] 驗證操作回滾正常

## 視覺測試

### 1. 停用學生樣式
- [ ] 停用學生顯示為灰色
- [ ] 停用標籤顯示正確
- [ ] 停用日期信息顯示正確

### 2. 按鈕狀態
- [ ] 未選擇學生時按鈕禁用
- [ ] 選擇學生後按鈕啟用
- [ ] 操作進行中按鈕顯示載入狀態

### 3. 響應式設計
- [ ] 桌面版顯示正常
- [ ] 平板版顯示正常
- [ ] 手機版顯示正常

## 權限測試

### 1. 管理員權限
- [ ] 管理員可以執行所有操作
- [ ] 管理員可以查看所有學生
- [ ] 管理員可以刪除學生

### 2. 非管理員權限
- [ ] 非管理員無法訪問學生管理頁面
- [ ] 非管理員無法執行刪除操作

## 安全測試

### 1. 資料驗證
- [ ] 輸入驗證正常
- [ ] SQL 注入防護
- [ ] XSS 防護

### 2. 操作確認
- [ ] 刪除操作需要確認
- [ ] 停用操作需要確認
- [ ] 回復操作需要確認

## 性能測試

### 1. 載入性能
- [ ] 學生列表載入時間 < 3秒
- [ ] 篩選操作響應時間 < 1秒
- [ ] 搜尋操作響應時間 < 1秒

### 2. 批量操作性能
- [ ] 批量刪除 10 個學生 < 5秒
- [ ] 批量停用 10 個學生 < 5秒
- [ ] 批量回復 10 個學生 < 5秒

## 錯誤處理測試

### 1. 網路錯誤
- [ ] 網路中斷時顯示錯誤訊息
- [ ] 網路恢復後可以重試操作

### 2. 資料庫錯誤
- [ ] 外鍵約束錯誤顯示正確訊息
- [ ] 權限錯誤顯示正確訊息
- [ ] 其他資料庫錯誤處理正常

## 測試環境設置

### 1. 測試資料
```sql
-- 創建測試學生
INSERT INTO "Hanami_Students" (id, full_name, contact_number, student_type)
VALUES 
  ('test-student-1', '測試學生1', '12345678', '常規'),
  ('test-student-2', '測試學生2', '87654321', '常規');

-- 創建測試課堂記錄
INSERT INTO hanami_student_lesson (id, student_id, lesson_date, course_type)
VALUES 
  ('test-lesson-1', 'test-student-1', '2024-01-01', '鋼琴');
```

### 2. 測試用戶
- 管理員用戶：admin@test.com
- 普通用戶：user@test.com

## 測試報告模板

### 測試結果記錄
```
測試日期：_________
測試人員：_________
測試環境：_________

功能測試結果：
□ 通過  □ 失敗  □ 部分通過

視覺測試結果：
□ 通過  □ 失敗  □ 部分通過

權限測試結果：
□ 通過  □ 失敗  □ 部分通過

安全測試結果：
□ 通過  □ 失敗  □ 部分通過

性能測試結果：
□ 通過  □ 失敗  □ 部分通過

發現的問題：
1. ________________
2. ________________
3. ________________

建議改進：
1. ________________
2. ________________
3. ________________
```

## 部署檢查清單

### 1. 代碼部署
- [ ] 代碼已合併到主分支
- [ ] 所有測試通過
- [ ] 代碼審查完成

### 2. 資料庫部署
- [ ] 外鍵約束檢查完成
- [ ] RLS 策略已更新
- [ ] 權限設置正確

### 3. 功能驗證
- [ ] 生產環境功能測試通過
- [ ] 性能測試通過
- [ ] 錯誤處理正常

### 4. 監控設置
- [ ] 錯誤日誌監控
- [ ] 性能監控
- [ ] 用戶行為監控

## 故障排除

### 常見問題

#### 1. 外鍵約束錯誤
**症狀**：刪除學生時出現 `hanami_student_lesson_student_id_fkey` 錯誤
**解決方案**：
1. 檢查是否有相關的課堂記錄
2. 使用資料庫檢查腳本診斷問題
3. 手動刪除相關記錄後再刪除學生

#### 2. 權限錯誤
**症狀**：操作時出現權限錯誤
**解決方案**：
1. 檢查用戶角色
2. 檢查 RLS 策略
3. 檢查表權限

#### 3. 性能問題
**症狀**：操作響應緩慢
**解決方案**：
1. 檢查資料庫索引
2. 優化查詢語句
3. 檢查網路連接

### 聯繫支持
如遇到無法解決的問題，請聯繫技術支持團隊：
- 郵箱：support@hanami.com
- 電話：+852 1234 5678
- 緊急聯繫：+852 9876 5432

---

最後更新：2024-03-21
版本：2.0 