-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.Hanami_CourseTypes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text,
  status boolean DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  trial_limit integer NOT NULL DEFAULT 1,
  price_per_lesson numeric DEFAULT NULL::numeric,
  CONSTRAINT Hanami_CourseTypes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.Hanami_Student_Package (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid NOT NULL,
  course_name text NOT NULL,
  start_date date NOT NULL,
  weekday text NOT NULL,
  lesson_time text NOT NULL,
  lesson_duration integer NOT NULL,
  total_lessons integer NOT NULL,
  remaining_lessons integer NOT NULL,
  price numeric NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone NOT NULL DEFAULT now(),
  package_type text NOT NULL,
  status USER-DEFINED DEFAULT 'active'::package_status_type,
  access_role text,
  full_name text,
  CONSTRAINT Hanami_Student_Package_pkey PRIMARY KEY (id),
  CONSTRAINT Hanami_Student_Package_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id)
);
CREATE TABLE public.Hanami_Students (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  full_name text NOT NULL,
  contact_number text NOT NULL,
  student_dob date,
  parent_email text,
  health_notes text,
  address text,
  school text,
  started_date date,
  duration_months bigint,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  access_role text,
  student_oid text DEFAULT generate_simple_id() UNIQUE,
  student_email text,
  student_password text,
  student_age integer,
  student_preference text,
  course_type text,
  ongoing_lessons integer,
  upcoming_lessons integer,
  regular_timeslot time without time zone,
  regular_weekday integer,
  gender text,
  student_type text DEFAULT '常規'::text,
  student_teacher text,
  nick_name text,
  student_remarks text,
  assigned_tree_id uuid,
  CONSTRAINT Hanami_Students_pkey PRIMARY KEY (id),
  CONSTRAINT Hanami_Students_assigned_tree_id_fkey FOREIGN KEY (assigned_tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.ai_suggestions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  incoming_id uuid,
  suggested_reply text,
  confidence_score numeric,
  risk_level text CHECK (risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])),
  is_safe_to_send boolean DEFAULT false,
  ai_model text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_suggestions_pkey PRIMARY KEY (id),
  CONSTRAINT ai_suggestions_incoming_id_fkey FOREIGN KEY (incoming_id) REFERENCES public.incoming_messages(id)
);
CREATE TABLE public.ai_tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  title text,
  prompt text,
  model text,
  status text CHECK (status = ANY (ARRAY['queued'::text, 'processing'::text, 'done'::text, 'error'::text])),
  result text,
  created_at timestamp without time zone DEFAULT now(),
  started_at timestamp without time zone,
  finished_at timestamp without time zone,
  memory_id uuid,
  assigned_model text,
  error_message text,
  CONSTRAINT ai_tasks_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_ability_assessment_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  assessment_id uuid NOT NULL,
  student_id uuid NOT NULL,
  ability_id uuid NOT NULL,
  previous_level integer,
  new_level integer,
  change_date date NOT NULL,
  change_reason text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_ability_assessment_history_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_ability_assessment_history_assessment_id_fkey FOREIGN KEY (assessment_id) REFERENCES public.hanami_ability_assessments(id)
);
CREATE TABLE public.hanami_ability_assessments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid NOT NULL,
  tree_id uuid NOT NULL,
  assessment_date date NOT NULL,
  lesson_date date NOT NULL,
  teacher_id uuid,
  ability_assessments jsonb NOT NULL,
  overall_performance_rating integer CHECK (overall_performance_rating >= 1 AND overall_performance_rating <= 5),
  general_notes text,
  next_lesson_focus text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  selected_goals jsonb DEFAULT '[]'::jsonb,
  version_info jsonb DEFAULT '{"version": "1.0", "created_at": null, "updated_at": null}'::jsonb,
  tree_version text DEFAULT '1.0'::text,
  goals_snapshot jsonb,
  CONSTRAINT hanami_ability_assessments_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_ability_assessments_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_ability_assessments_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id),
  CONSTRAINT hanami_ability_assessments_teacher_id_fkey FOREIGN KEY (teacher_id) REFERENCES public.hanami_employee(id)
);
CREATE TABLE public.hanami_ability_categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  category_name text NOT NULL UNIQUE,
  category_description text,
  category_color text DEFAULT '#FFB6C1'::text,
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_ability_categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_ability_levels (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ability_id uuid NOT NULL,
  level integer NOT NULL,
  level_title text NOT NULL,
  level_description text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_ability_levels_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_ability_levels_ability_id_fkey FOREIGN KEY (ability_id) REFERENCES public.hanami_development_abilities(id)
);
CREATE TABLE public.hanami_admin (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  admin_oid text,
  admin_name text,
  admin_email text,
  admin_password text,
  role text DEFAULT 'admin'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  contact_number text,
  CONSTRAINT hanami_admin_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_ai_message_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid NOT NULL,
  template_id uuid,
  message_content text NOT NULL,
  student_data jsonb NOT NULL,
  webhook_response jsonb,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'sent'::text, 'failed'::text])),
  sent_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_ai_message_logs_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_ai_message_logs_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.hanami_ai_message_templates(id)
);
CREATE TABLE public.hanami_ai_message_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_name text NOT NULL,
  template_content text NOT NULL,
  template_type text DEFAULT 'general'::text,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_ai_message_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_ai_tool_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tool_id text NOT NULL,
  user_email text NOT NULL,
  status text NOT NULL DEFAULT 'queued'::text CHECK (status = ANY (ARRAY['queued'::text, 'processing'::text, 'completed'::text, 'failed'::text])),
  created_at timestamp with time zone DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  queue_position integer DEFAULT 1,
  priority integer DEFAULT 1,
  input_data jsonb DEFAULT '{}'::jsonb,
  output_data jsonb DEFAULT '{}'::jsonb,
  error_message text,
  retry_count integer DEFAULT 0,
  max_retries integer DEFAULT 3,
  processing_time_ms integer,
  token_count integer,
  cost_estimate numeric,
  user_agent text,
  ip_address inet,
  session_id text,
  CONSTRAINT hanami_ai_tool_usage_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_assessment_compatibility_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  assessment_id uuid NOT NULL,
  tree_id uuid NOT NULL,
  issue_type text NOT NULL CHECK (issue_type = ANY (ARRAY['deleted_goal'::text, 'level_count_changed'::text, 'max_level_changed'::text, 'assessment_mode_changed'::text])),
  goal_id uuid,
  goal_name text,
  original_data jsonb,
  current_data jsonb,
  processed_at timestamp with time zone DEFAULT now(),
  resolved boolean DEFAULT false,
  resolution_notes text,
  CONSTRAINT hanami_assessment_compatibility_logs_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_assessment_compatibility_logs_assessment_id_fkey FOREIGN KEY (assessment_id) REFERENCES public.hanami_ability_assessments(id),
  CONSTRAINT hanami_assessment_compatibility_logs_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.hanami_auto_version_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tree_id uuid NOT NULL,
  change_type text NOT NULL CHECK (change_type = ANY (ARRAY['goal_added'::text, 'goal_modified'::text, 'goal_removed'::text, 'tree_modified'::text])),
  change_description text,
  affected_goals jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_auto_version_logs_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_auto_version_logs_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.hanami_child_development_milestones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  age_months integer NOT NULL,
  age_description text NOT NULL,
  age_range_min integer NOT NULL,
  age_range_max integer NOT NULL,
  music_interest text DEFAULT 3,
  separation_anxiety text DEFAULT 3,
  attention_span text DEFAULT 3,
  fine_motor text DEFAULT 3,
  emotional_development text DEFAULT 3,
  social_interaction text DEFAULT 3,
  joint_attention text DEFAULT 3,
  social_norms text DEFAULT 3,
  language_comprehension text DEFAULT 3,
  spatial_concept text DEFAULT 3,
  hand_eye_coordination text DEFAULT 3,
  bilateral_coordination text DEFAULT 3,
  development_data jsonb DEFAULT '{}'::jsonb,
  milestones ARRAY,
  red_flags ARRAY,
  music_development jsonb DEFAULT '{}'::jsonb,
  recommended_activities ARRAY,
  teaching_strategies ARRAY,
  notes text,
  source text,
  last_updated_by text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_child_development_milestones_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_course_activity_defaults (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  course_type text NOT NULL,
  activity_id uuid NOT NULL,
  weekday smallint,
  order_index integer DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT hanami_course_activity_defaults_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_course_activity_defaults_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.hanami_teaching_activities(id)
);
CREATE TABLE public.hanami_custom_options (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  option_type text NOT NULL CHECK (option_type = ANY (ARRAY['activity_type'::text, 'status'::text, 'category'::text])),
  option_name text NOT NULL,
  option_value text NOT NULL,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_custom_options_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_custom_options_backup (
  id uuid,
  option_type text,
  option_name text,
  option_value text,
  sort_order integer,
  is_active boolean,
  created_by uuid,
  created_at timestamp with time zone,
  updated_at timestamp with time zone
);
CREATE TABLE public.hanami_development_abilities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  ability_name text NOT NULL,
  ability_description text,
  ability_icon text,
  ability_color text,
  max_level integer DEFAULT 5,
  created_at timestamp with time zone DEFAULT now(),
  category text,
  CONSTRAINT hanami_development_abilities_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_development_abilities_category_fkey FOREIGN KEY (category) REFERENCES public.hanami_ability_categories(category_name)
);
CREATE TABLE public.hanami_employee (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  teacher_nickname text NOT NULL,
  teacher_email text,
  teacher_password text,
  teacher_phone text,
  teacher_bankid text,
  teacher_hsalary numeric,
  teacher_address text,
  teacher_background text,
  teacher_dob timestamp without time zone,
  teacher_role text,
  teacher_status text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  teacher_fullname text,
  teacher_msalary numeric,
  course_roles jsonb,
  course_roles_note text,
  CONSTRAINT hanami_employee_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_file_resources (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  resource_id uuid NOT NULL,
  resource_type text NOT NULL CHECK (resource_type = ANY (ARRAY['activity'::text, 'template'::text, 'lesson_plan'::text])),
  file_name text NOT NULL,
  file_path text NOT NULL,
  file_size bigint,
  file_type text,
  mime_type text,
  storage_provider text DEFAULT 'supabase'::text CHECK (storage_provider = ANY (ARRAY['supabase'::text, 'google_drive'::text])),
  external_url text,
  is_public boolean DEFAULT false,
  download_count integer DEFAULT 0,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_file_resources_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_financial_expenses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  expense_date date NOT NULL,
  expense_category text NOT NULL,
  expense_description text NOT NULL,
  amount numeric NOT NULL,
  payment_method text,
  receipt_url text,
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_financial_expenses_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_group_chat (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT hanami_group_chat_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_growth_goals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tree_id uuid,
  goal_name text NOT NULL,
  goal_description text,
  goal_order integer NOT NULL,
  goal_icon text,
  is_achievable boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  progress_max integer DEFAULT 20,
  required_abilities ARRAY,
  related_activities ARRAY,
  is_completed boolean DEFAULT false,
  progress_contents ARRAY DEFAULT '{}'::text[],
  review_teachers ARRAY DEFAULT '{}'::text[],
  notes text,
  difficulty_level integer DEFAULT 1,
  course_type text,
  tree_color text DEFAULT '#FFD59A'::text,
  tree_icon text DEFAULT '🌳'::text,
  tree_level integer DEFAULT 1,
  tree_description text,
  tree_name text,
  course_type_id text,
  is_active boolean DEFAULT true,
  assessment_mode text DEFAULT 'progress'::text CHECK (assessment_mode = ANY (ARRAY['progress'::text, 'multi_select'::text])),
  multi_select_levels jsonb DEFAULT '[]'::jsonb,
  multi_select_descriptions jsonb DEFAULT '[]'::jsonb,
  version text DEFAULT '1.0'::text,
  deprecated_at timestamp with time zone,
  deprecated_reason text,
  CONSTRAINT hanami_growth_goals_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_growth_goals_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.hanami_growth_tree_versions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tree_id uuid NOT NULL,
  version text NOT NULL,
  version_name text,
  version_description text,
  goals_snapshot jsonb NOT NULL,
  changes_summary text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  CONSTRAINT hanami_growth_tree_versions_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_growth_tree_versions_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.hanami_growth_trees (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  course_type_id uuid,
  tree_name text NOT NULL,
  tree_description text,
  tree_level integer NOT NULL DEFAULT 1,
  tree_icon text,
  tree_color text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  review_teachers ARRAY,
  notes text,
  CONSTRAINT hanami_growth_trees_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_growth_trees_course_type_id_fkey FOREIGN KEY (course_type_id) REFERENCES public.Hanami_CourseTypes(id)
);
CREATE TABLE public.hanami_holidays (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  date date,
  title text,
  is_closed boolean,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT hanami_holidays_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_learning_nodes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  path_id uuid,
  node_type text NOT NULL CHECK (node_type = ANY (ARRAY['activity'::text, 'assessment'::text, 'milestone'::text, 'break'::text])),
  title text NOT NULL,
  description text,
  duration integer NOT NULL DEFAULT 0,
  difficulty integer NOT NULL DEFAULT 1 CHECK (difficulty >= 1 AND difficulty <= 5),
  prerequisites ARRAY DEFAULT '{}'::text[],
  rewards ARRAY DEFAULT '{}'::text[],
  position_x integer NOT NULL DEFAULT 0,
  position_y integer NOT NULL DEFAULT 0,
  connections ARRAY DEFAULT '{}'::text[],
  is_completed boolean DEFAULT false,
  is_locked boolean DEFAULT false,
  metadata jsonb DEFAULT '{}'::jsonb,
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_learning_nodes_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_learning_nodes_path_id_fkey FOREIGN KEY (path_id) REFERENCES public.hanami_learning_paths(id)
);
CREATE TABLE public.hanami_learning_path_nodes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  path_id uuid NOT NULL,
  node_order integer NOT NULL,
  node_type text NOT NULL,
  activity_id uuid,
  goal_id uuid,
  title text NOT NULL,
  description text,
  duration integer DEFAULT 30,
  difficulty integer DEFAULT 1,
  is_required boolean DEFAULT true,
  is_prerequisite boolean DEFAULT false,
  prerequisite_nodes ARRAY,
  reward_description text,
  metadata jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_learning_path_nodes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_learning_path_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_name text NOT NULL UNIQUE,
  template_description text,
  template_category text,
  difficulty_level integer DEFAULT 1 CHECK (difficulty_level >= 1 AND difficulty_level <= 5),
  estimated_duration integer DEFAULT 0,
  target_age_min integer,
  target_age_max integer,
  tags ARRAY DEFAULT '{}'::text[],
  template_data jsonb NOT NULL,
  is_public boolean DEFAULT false,
  created_by uuid,
  usage_count integer DEFAULT 0,
  rating numeric DEFAULT 0.00,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_learning_path_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_learning_paths (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  tree_id uuid,
  nodes jsonb NOT NULL DEFAULT '[]'::jsonb,
  start_node_id text NOT NULL,
  end_node_id text NOT NULL,
  total_duration integer NOT NULL DEFAULT 0,
  difficulty integer NOT NULL DEFAULT 1 CHECK (difficulty >= 1 AND difficulty <= 5),
  tags ARRAY DEFAULT '{}'::text[],
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_learning_paths_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_learning_paths_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.hanami_lesson_activity_log (
  lesson_id uuid NOT NULL,
  activity_name text,
  materials_used text,
  learning_focus text,
  teacher_reflection text,
  CONSTRAINT hanami_lesson_activity_log_pkey PRIMARY KEY (lesson_id),
  CONSTRAINT hanami_lesson_activity_log_lesson_id_fkey FOREIGN KEY (lesson_id) REFERENCES public.hanami_student_lesson(id)
);
CREATE TABLE public.hanami_lesson_plan (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lesson_date date NOT NULL,
  timeslot text NOT NULL,
  course_type text NOT NULL,
  teacher_ids_1 ARRAY DEFAULT '{}'::uuid[],
  topic text,
  objectives ARRAY,
  materials ARRAY,
  remarks text,
  created_at timestamp with time zone DEFAULT now(),
  teacher_ids_2 text DEFAULT '''{}''::uuid[]'::text,
  CONSTRAINT hanami_lesson_plan_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_lesson_plan_activities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lesson_date date NOT NULL,
  timeslot text NOT NULL,
  course_type text NOT NULL,
  activity_id uuid NOT NULL,
  activity_type text NOT NULL CHECK (activity_type = ANY (ARRAY['class_activity'::text, 'individual_activity'::text])),
  student_id uuid,
  assigned_by text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_lesson_plan_activities_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_lesson_plan_activities_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.hanami_tree_activities(id),
  CONSTRAINT hanami_lesson_plan_activities_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id)
);
CREATE TABLE public.hanami_media_quota_levels (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  level_name text NOT NULL UNIQUE,
  video_limit integer NOT NULL DEFAULT 5,
  photo_limit integer NOT NULL DEFAULT 10,
  storage_limit_mb integer NOT NULL DEFAULT 250,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  video_size_limit_mb integer NOT NULL DEFAULT 50,
  photo_size_limit_mb integer NOT NULL DEFAULT 10,
  CONSTRAINT hanami_media_quota_levels_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_node_completion_records (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  path_id uuid,
  node_id text NOT NULL,
  completion_date timestamp with time zone DEFAULT now(),
  time_spent integer DEFAULT 0,
  performance_rating integer CHECK (performance_rating >= 1 AND performance_rating <= 5),
  notes text,
  evidence_files ARRAY DEFAULT '{}'::text[],
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_node_completion_records_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_node_completion_records_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_node_completion_records_path_id_fkey FOREIGN KEY (path_id) REFERENCES public.hanami_learning_paths(id)
);
CREATE TABLE public.hanami_parent_student_links (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  parent_id uuid NOT NULL,
  student_id uuid NOT NULL,
  relationship_type text DEFAULT 'parent'::text CHECK (relationship_type = ANY (ARRAY['parent'::text, 'guardian'::text, 'emergency_contact'::text])),
  is_primary_contact boolean DEFAULT false,
  can_view_progress boolean DEFAULT true,
  can_receive_notifications boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_parent_student_links_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_parent_student_links_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.hanami_parents(id),
  CONSTRAINT hanami_parent_student_links_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id)
);
CREATE TABLE public.hanami_parent_student_relations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  parent_id uuid NOT NULL,
  student_id uuid NOT NULL,
  can_view_student_data boolean DEFAULT true,
  can_view_lessons boolean DEFAULT true,
  can_view_progress boolean DEFAULT true,
  can_view_financial_data boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_parent_student_relations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_parents (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  parent_email text NOT NULL UNIQUE,
  parent_name text NOT NULL,
  parent_phone text,
  parent_password text NOT NULL,
  parent_address text,
  parent_status text DEFAULT 'active'::text CHECK (parent_status = ANY (ARRAY['active'::text, 'inactive'::text, 'suspended'::text])),
  parent_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_parents_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_permission_applications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  applicant_email text NOT NULL,
  applicant_phone text,
  requested_role_id uuid NOT NULL,
  application_type text NOT NULL CHECK (application_type = ANY (ARRAY['new_user'::text, 'role_change'::text, 'permission_extension'::text])),
  current_role_id uuid,
  reason text NOT NULL,
  supporting_documents jsonb,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'under_review'::text, 'approved'::text, 'rejected'::text, 'cancelled'::text])),
  reviewed_by uuid,
  reviewed_at timestamp with time zone,
  review_notes text,
  approved_permissions jsonb,
  expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_permission_applications_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_permission_applications_requested_role_id_fkey FOREIGN KEY (requested_role_id) REFERENCES public.hanami_roles(id),
  CONSTRAINT hanami_permission_applications_current_role_id_fkey FOREIGN KEY (current_role_id) REFERENCES public.hanami_roles(id),
  CONSTRAINT hanami_permission_applications_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.hanami_admin(id)
);
CREATE TABLE public.hanami_permission_audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  admin_id uuid NOT NULL,
  target_user_email text NOT NULL,
  action_type text NOT NULL CHECK (action_type = ANY (ARRAY['grant'::text, 'revoke'::text, 'modify'::text, 'suspend'::text, 'activate'::text])),
  old_permissions jsonb,
  new_permissions jsonb NOT NULL,
  reason text,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_permission_audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_permission_audit_logs_admin_id_fkey FOREIGN KEY (admin_id) REFERENCES public.hanami_admin(id)
);
CREATE TABLE public.hanami_permission_cache (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_email text NOT NULL,
  cache_key text NOT NULL,
  cache_value jsonb NOT NULL,
  expires_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_permission_cache_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_permission_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  config_key text NOT NULL UNIQUE,
  config_value jsonb NOT NULL,
  description text,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_permission_configs_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_permission_configs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.hanami_admin(id)
);
CREATE TABLE public.hanami_permission_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_name text NOT NULL UNIQUE,
  description text,
  permissions jsonb NOT NULL,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_permission_templates_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_permission_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.hanami_admin(id)
);
CREATE TABLE public.hanami_permission_usage_stats (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_email text NOT NULL,
  resource_type text NOT NULL,
  resource_id text,
  operation text NOT NULL,
  success boolean NOT NULL,
  error_message text,
  response_time_ms integer,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_permission_usage_stats_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_resource_categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  category_name text NOT NULL UNIQUE,
  category_description text,
  parent_category_id uuid,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_resource_categories_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_resource_categories_parent_category_id_fkey FOREIGN KEY (parent_category_id) REFERENCES public.hanami_resource_categories(id)
);
CREATE TABLE public.hanami_resource_permissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  resource_id uuid NOT NULL,
  resource_type text NOT NULL CHECK (resource_type = ANY (ARRAY['activity'::text, 'template'::text, 'file'::text])),
  user_id uuid,
  role_id uuid,
  permission_type text NOT NULL CHECK (permission_type = ANY (ARRAY['view'::text, 'download'::text, 'edit'::text, 'admin'::text])),
  granted_by uuid,
  granted_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone,
  is_active boolean DEFAULT true,
  CONSTRAINT hanami_resource_permissions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_resource_tag_relations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  resource_id uuid NOT NULL,
  resource_type text NOT NULL,
  tag_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_resource_tag_relations_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_resource_tag_relations_tag_id_fkey FOREIGN KEY (tag_id) REFERENCES public.hanami_resource_tags(id)
);
CREATE TABLE public.hanami_resource_tags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tag_name text NOT NULL UNIQUE,
  tag_description text,
  tag_color text DEFAULT '#3B82F6'::text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_resource_tags_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_resource_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_name text NOT NULL UNIQUE,
  template_type text NOT NULL CHECK (template_type = ANY (ARRAY['lesson_plan'::text, 'storybook'::text, 'game'::text, 'training'::text, 'custom'::text, 'assessment'::text, 'worksheet'::text, 'presentation'::text])),
  template_description text,
  template_schema jsonb NOT NULL,
  template_icon text DEFAULT '📄'::text,
  template_color text DEFAULT '#3B82F6'::text,
  is_active boolean DEFAULT true,
  is_public boolean DEFAULT false,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_resource_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_resource_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  resource_id uuid NOT NULL,
  resource_type text NOT NULL,
  user_id uuid,
  action_type text NOT NULL CHECK (action_type = ANY (ARRAY['view'::text, 'download'::text, 'edit'::text, 'create'::text])),
  action_timestamp timestamp with time zone DEFAULT now(),
  ip_address inet,
  user_agent text,
  CONSTRAINT hanami_resource_usage_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_resource_versions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  resource_id uuid NOT NULL,
  resource_type text NOT NULL,
  version_number integer NOT NULL,
  version_data jsonb NOT NULL,
  version_notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_resource_versions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_rls_backup_20241219 (
  id integer NOT NULL DEFAULT nextval('hanami_rls_backup_20241219_id_seq'::regclass),
  table_name text NOT NULL,
  policy_name text NOT NULL,
  policy_definition text NOT NULL,
  rls_enabled boolean NOT NULL,
  backup_timestamp timestamp with time zone DEFAULT now(),
  notes text,
  CONSTRAINT hanami_rls_backup_20241219_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_rls_restore_script_20241219 (
  id integer NOT NULL DEFAULT nextval('hanami_rls_restore_script_20241219_id_seq'::regclass),
  script_order integer NOT NULL,
  script_command text NOT NULL,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_rls_restore_script_20241219_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  role_name text NOT NULL UNIQUE,
  display_name text NOT NULL,
  description text,
  is_system_role boolean DEFAULT false,
  permissions jsonb NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_roles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_schedule (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  weekday integer,
  timeslot time without time zone,
  max_students integer,
  assigned_teachers text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at time with time zone DEFAULT now(),
  course_type text,
  duration time without time zone,
  CONSTRAINT hanami_schedule_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_student_abilities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  ability_id uuid,
  current_level integer DEFAULT 1,
  progress_percentage numeric DEFAULT 0,
  last_assessment_date date,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  tree_id uuid,
  selected_levels ARRAY DEFAULT '{}'::text[],
  CONSTRAINT hanami_student_abilities_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_abilities_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_abilities_ability_id_fkey FOREIGN KEY (ability_id) REFERENCES public.hanami_development_abilities(id),
  CONSTRAINT hanami_student_abilities_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.hanami_student_activities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid NOT NULL,
  tree_id uuid,
  activity_id uuid,
  activity_type text NOT NULL DEFAULT 'ongoing'::text CHECK (activity_type = ANY (ARRAY['lesson'::text, 'ongoing'::text])),
  lesson_date date,
  timeslot text,
  completion_status text DEFAULT 'not_started'::text CHECK (completion_status = ANY (ARRAY['not_started'::text, 'in_progress'::text, 'completed'::text, 'skipped'::text])),
  assigned_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  time_spent integer DEFAULT 0,
  teacher_notes text,
  student_feedback text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  progress integer DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),
  CONSTRAINT hanami_student_activities_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_activities_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_activities_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id),
  CONSTRAINT hanami_student_activities_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.hanami_teaching_activities(id)
);
CREATE TABLE public.hanami_student_activity_plan (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  student_oid text,
  activity_id uuid NOT NULL,
  weekday smallint,
  valid_from date,
  valid_to date,
  order_index integer DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT hanami_student_activity_plan_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_activity_plan_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_activity_plan_student_oid_fkey FOREIGN KEY (student_oid) REFERENCES public.Hanami_Students(student_oid),
  CONSTRAINT hanami_student_activity_plan_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.hanami_teaching_activities(id)
);
CREATE TABLE public.hanami_student_learning_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  path_id uuid,
  current_node_id text,
  completed_nodes ARRAY DEFAULT '{}'::text[],
  progress_percentage numeric DEFAULT 0.00,
  start_date timestamp with time zone DEFAULT now(),
  completion_date timestamp with time zone,
  total_time_spent integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_student_learning_progress_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_learning_progress_path_id_fkey FOREIGN KEY (path_id) REFERENCES public.hanami_learning_paths(id),
  CONSTRAINT hanami_student_learning_progress_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id)
);
CREATE TABLE public.hanami_student_lesson (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  package_id uuid,
  lesson_date date NOT NULL,
  regular_timeslot time without time zone,
  actual_timeslot time without time zone,
  lesson_status text DEFAULT '未設定'::text,
  progress_notes text,
  video_url text,
  next_target text,
  remarks text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  status USER-DEFINED DEFAULT 'attended'::lesson_status_type,
  access_role text,
  course_type text,
  notes text,
  regular_weekday text,
  lesson_duration text,
  student_oid text,
  full_name text,
  lesson_teacher text,
  lesson_activities text,
  CONSTRAINT hanami_student_lesson_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_lesson_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_lesson_package_id_fkey FOREIGN KEY (package_id) REFERENCES public.Hanami_Student_Package(id),
  CONSTRAINT hanami_student_lesson_student_oid_fkey FOREIGN KEY (student_oid) REFERENCES public.Hanami_Students(student_oid)
);
CREATE TABLE public.hanami_student_lesson_activities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  lesson_id uuid NOT NULL,
  student_id uuid NOT NULL,
  tree_activity_id uuid NOT NULL,
  assigned_by text,
  assigned_at timestamp with time zone DEFAULT now(),
  completion_status text DEFAULT 'not_started'::text CHECK (completion_status = ANY (ARRAY['not_started'::text, 'in_progress'::text, 'completed'::text, 'skipped'::text])),
  performance_rating integer CHECK (performance_rating >= 1 AND performance_rating <= 5),
  student_notes text,
  teacher_notes text,
  time_spent integer DEFAULT 0,
  attempts_count integer DEFAULT 0,
  is_favorite boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_student_lesson_activities_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_lesson_activities_lesson_id_fkey FOREIGN KEY (lesson_id) REFERENCES public.hanami_student_lesson(id),
  CONSTRAINT hanami_student_lesson_activities_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_lesson_activities_tree_activity_id_fkey FOREIGN KEY (tree_activity_id) REFERENCES public.hanami_tree_activities(id)
);
CREATE TABLE public.hanami_student_media (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  media_type text NOT NULL CHECK (media_type = ANY (ARRAY['video'::text, 'photo'::text])),
  file_name text NOT NULL,
  file_path text NOT NULL,
  file_size bigint NOT NULL,
  file_duration integer,
  thumbnail_path text,
  title text,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_favorite boolean DEFAULT false,
  uploaded_by text,
  lesson_id uuid,
  CONSTRAINT hanami_student_media_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_media_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_media_lesson_id_fkey FOREIGN KEY (lesson_id) REFERENCES public.hanami_student_lesson(id)
);
CREATE TABLE public.hanami_student_media_quota (
  student_id uuid NOT NULL,
  plan_type text DEFAULT 'free'::text CHECK (plan_type = ANY (ARRAY['free'::text, 'free:create'::text, 'basic'::text, 'premium'::text, 'professional'::text])),
  video_limit integer DEFAULT 5,
  photo_limit integer DEFAULT 10,
  video_count integer DEFAULT 0,
  photo_count integer DEFAULT 0,
  total_used_space bigint DEFAULT 0,
  last_updated timestamp with time zone DEFAULT now(),
  storage_limit_bytes bigint DEFAULT 262144000,
  CONSTRAINT hanami_student_media_quota_pkey PRIMARY KEY (student_id)
);
CREATE TABLE public.hanami_student_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  lesson_id uuid,
  lesson_date date,
  duration_minutes integer,
  progress_notes text,
  next_goal text,
  video_url text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  lesson_type USER-DEFINED DEFAULT '正常課'::lesson_type_enum,
  ai_processed boolean DEFAULT false,
  is_sent boolean DEFAULT false,
  review_status text DEFAULT 'pending'::text,
  course_type text,
  CONSTRAINT hanami_student_progress_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_progress_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_progress_lesson_id_fkey FOREIGN KEY (lesson_id) REFERENCES public.hanami_student_lesson(id)
);
CREATE TABLE public.hanami_student_tree_activity_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid NOT NULL,
  tree_activity_id uuid NOT NULL,
  completion_status text DEFAULT 'not_started'::text CHECK (completion_status = ANY (ARRAY['not_started'::text, 'in_progress'::text, 'completed'::text, 'skipped'::text])),
  completion_date timestamp with time zone,
  performance_rating integer CHECK (performance_rating >= 1 AND performance_rating <= 5),
  student_notes text,
  teacher_notes text,
  evidence_files ARRAY,
  time_spent integer,
  attempts_count integer DEFAULT 0,
  is_favorite boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_student_tree_activity_progress_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_tree_activity_progress_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_tree_activity_progress_tree_activity_id_fkey FOREIGN KEY (tree_activity_id) REFERENCES public.hanami_tree_activities(id)
);
CREATE TABLE public.hanami_student_trees (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid,
  tree_id uuid,
  enrollment_date date DEFAULT CURRENT_DATE,
  completion_date date,
  current_goal_id uuid,
  tree_status text DEFAULT 'active'::text,
  teacher_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  start_date date DEFAULT CURRENT_DATE,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'completed'::text, 'paused'::text])),
  completed_goals ARRAY DEFAULT '{}'::text[],
  progress_notes text,
  CONSTRAINT hanami_student_trees_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_student_trees_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.Hanami_Students(id),
  CONSTRAINT hanami_student_trees_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id),
  CONSTRAINT hanami_student_trees_current_goal_id_fkey FOREIGN KEY (current_goal_id) REFERENCES public.hanami_growth_goals(id)
);
CREATE TABLE public.hanami_teacher_student_relations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  teacher_id uuid NOT NULL,
  student_id uuid NOT NULL,
  can_view_student_data boolean DEFAULT true,
  can_edit_student_data boolean DEFAULT false,
  can_view_lessons boolean DEFAULT true,
  can_edit_lessons boolean DEFAULT true,
  can_view_progress boolean DEFAULT true,
  can_edit_progress boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_teacher_student_relations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_teaching_activities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  activity_name text NOT NULL,
  activity_description text,
  activity_type text NOT NULL,
  difficulty_level integer DEFAULT 1,
  target_abilities ARRAY,
  materials_needed ARRAY,
  duration_minutes integer,
  age_range_min integer,
  age_range_max integer,
  notion_id text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  template_id uuid,
  custom_fields jsonb,
  tags ARRAY,
  category text,
  status text DEFAULT 'draft'::text,
  version integer DEFAULT 1,
  created_by uuid,
  updated_by uuid,
  estimated_duration integer DEFAULT 0,
  instructions text,
  notes text,
  CONSTRAINT hanami_teaching_activities_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_template_field_validations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL,
  field_name text NOT NULL,
  validation_type text NOT NULL,
  validation_config jsonb NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_template_field_validations_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_template_field_validations_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.hanami_resource_templates(id)
);
CREATE TABLE public.hanami_template_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_id uuid NOT NULL,
  user_id uuid,
  action_type text NOT NULL CHECK (action_type = ANY (ARRAY['view'::text, 'use'::text, 'edit'::text, 'delete'::text])),
  action_timestamp timestamp with time zone DEFAULT now(),
  ip_address inet,
  user_agent text,
  CONSTRAINT hanami_template_usage_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_template_usage_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.hanami_resource_templates(id)
);
CREATE TABLE public.hanami_tree_activities (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tree_id uuid,
  activity_id uuid,
  goal_id uuid,
  priority_order integer DEFAULT 1,
  is_required boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  activity_source text DEFAULT 'teaching'::text CHECK (activity_source = ANY (ARRAY['teaching'::text, 'custom'::text, 'template'::text])),
  custom_activity_name text,
  custom_activity_description text,
  activity_type text DEFAULT 'custom'::text CHECK (activity_type = ANY (ARRAY['custom'::text, 'teaching'::text, 'assessment'::text, 'practice'::text])),
  difficulty_level integer DEFAULT 1 CHECK (difficulty_level >= 1 AND difficulty_level <= 5),
  estimated_duration integer,
  materials_needed ARRAY DEFAULT '{}'::text[],
  instructions text,
  learning_objectives ARRAY DEFAULT '{}'::text[],
  target_abilities ARRAY DEFAULT '{}'::text[],
  prerequisites ARRAY DEFAULT '{}'::text[],
  activity_order integer DEFAULT 0,
  created_by text,
  updated_by text,
  updated_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  CONSTRAINT hanami_tree_activities_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_tree_activities_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id),
  CONSTRAINT hanami_tree_activities_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.hanami_teaching_activities(id),
  CONSTRAINT hanami_tree_activities_goal_id_fkey FOREIGN KEY (goal_id) REFERENCES public.hanami_growth_goals(id)
);
CREATE TABLE public.hanami_tree_activity_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  template_name text NOT NULL UNIQUE,
  template_description text,
  activity_type text NOT NULL DEFAULT 'custom'::text CHECK (activity_type = ANY (ARRAY['custom'::text, 'teaching'::text, 'assessment'::text, 'practice'::text])),
  difficulty_level integer DEFAULT 1 CHECK (difficulty_level >= 1 AND difficulty_level <= 5),
  estimated_duration integer,
  materials_needed ARRAY DEFAULT '{}'::text[],
  instructions text,
  learning_objectives ARRAY DEFAULT '{}'::text[],
  target_abilities ARRAY DEFAULT '{}'::text[],
  prerequisites ARRAY DEFAULT '{}'::text[],
  is_active boolean DEFAULT true,
  created_by text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_tree_activity_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_trial_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_id uuid DEFAULT gen_random_uuid(),
  prefer_time jsonb,
  notes text,
  status text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  phone_no text,
  full_name text,
  student_dob date,
  student_age integer,
  course_types jsonb,
  CONSTRAINT hanami_trial_queue_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_trial_student_media_quota (
  student_id uuid NOT NULL,
  plan_type text DEFAULT 'free:create'::text CHECK (plan_type = ANY (ARRAY['free:create'::text, 'basic'::text, 'premium'::text, 'professional'::text])),
  video_limit integer DEFAULT 5,
  photo_limit integer DEFAULT 10,
  video_count integer DEFAULT 0,
  photo_count integer DEFAULT 0,
  total_used_space bigint DEFAULT 0,
  last_updated timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_trial_student_media_quota_pkey PRIMARY KEY (student_id),
  CONSTRAINT hanami_trial_student_media_quota_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.hanami_trial_students(id)
);
CREATE TABLE public.hanami_trial_students (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  student_oid text DEFAULT generate_simple_id(),
  full_name text,
  student_dob date,
  lesson_date date,
  lesson_duration time without time zone,
  course_type text,
  contact_number text,
  parent_email text,
  trial_status text,
  trial_remarks text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  student_age integer,
  health_notes text,
  student_preference text,
  weekday text,
  address text,
  school text,
  student_email text,
  student_password text,
  gender text,
  student_type text DEFAULT '試堂'::text,
  student_teacher text,
  regular_weekday text,
  regular_timeslot text,
  access_role text,
  duration_months text,
  nick_name text,
  remaining_lessons integer,
  ongoing_lessons integer,
  upcoming_lessons integer,
  actual_timeslot time without time zone,
  CONSTRAINT hanami_trial_students_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_user_permissions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  user_type text NOT NULL CHECK (user_type = ANY (ARRAY['admin'::text, 'teacher'::text, 'parent'::text])),
  user_email text NOT NULL,
  permissions jsonb DEFAULT '{}'::jsonb,
  accessible_pages jsonb DEFAULT '[]'::jsonb,
  can_view_all_students boolean DEFAULT false,
  can_view_all_lessons boolean DEFAULT false,
  can_manage_teachers boolean DEFAULT false,
  can_manage_students boolean DEFAULT false,
  can_manage_lessons boolean DEFAULT false,
  can_view_financial_data boolean DEFAULT false,
  can_export_data boolean DEFAULT false,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_user_permissions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.hanami_user_permissions_backup (
  id uuid,
  user_id uuid,
  user_type text,
  user_email text,
  permissions jsonb,
  accessible_pages jsonb,
  can_view_all_students boolean,
  can_view_all_lessons boolean,
  can_manage_teachers boolean,
  can_manage_students boolean,
  can_manage_lessons boolean,
  can_view_financial_data boolean,
  can_export_data boolean,
  is_active boolean,
  created_at timestamp with time zone,
  updated_at timestamp with time zone
);
CREATE TABLE public.hanami_user_permissions_v2 (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_email text NOT NULL,
  user_phone text,
  role_id uuid NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'suspended'::text])),
  approved_by uuid,
  approved_at timestamp with time zone,
  custom_permissions jsonb,
  student_access_list ARRAY,
  page_access_list ARRAY,
  feature_access_list ARRAY,
  data_access_config jsonb,
  expires_at timestamp with time zone,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_user_permissions_v2_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_user_permissions_v2_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.hanami_roles(id),
  CONSTRAINT hanami_user_permissions_v2_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.hanami_admin(id)
);
CREATE TABLE public.hanami_version_change_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tree_id uuid NOT NULL,
  from_version text NOT NULL,
  to_version text NOT NULL,
  change_type text NOT NULL CHECK (change_type = ANY (ARRAY['goal_added'::text, 'goal_removed'::text, 'goal_modified'::text, 'goal_reordered'::text])),
  goal_id uuid,
  goal_name text,
  change_details jsonb,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT hanami_version_change_logs_pkey PRIMARY KEY (id),
  CONSTRAINT hanami_version_change_logs_tree_id_fkey FOREIGN KEY (tree_id) REFERENCES public.hanami_growth_trees(id)
);
CREATE TABLE public.inactive_student_list (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  original_id uuid,
  student_type text NOT NULL,
  full_name text,
  student_age integer,
  student_preference text,
  course_type text,
  remaining_lessons integer,
  regular_weekday integer,
  gender text,
  student_oid text,
  contact_number text,
  regular_timeslot text,
  health_notes text,
  lesson_date date,
  actual_timeslot text,
  inactive_date timestamp with time zone DEFAULT now(),
  inactive_reason text DEFAULT '管理員停用'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  student_dob date,
  parent_email text,
  address text,
  school text,
  started_date date,
  duration_months bigint,
  access_role text,
  student_email text,
  student_password text,
  ongoing_lessons integer,
  upcoming_lessons integer,
  student_teacher text,
  nick_name text,
  student_remarks text,
  CONSTRAINT inactive_student_list_pkey PRIMARY KEY (id)
);
CREATE TABLE public.incoming_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id text,
  user_id uuid,
  sender text NOT NULL,
  message text NOT NULL,
  source_channel text DEFAULT 'whatsapp'::text,
  timestamp timestamp with time zone DEFAULT now(),
  status text DEFAULT 'pending'::text,
  meta jsonb,
  ai_suggestion_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  message_summary text,
  CONSTRAINT incoming_messages_pkey PRIMARY KEY (id),
  CONSTRAINT incoming_messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT incoming_messages_ai_suggestion_id_fkey FOREIGN KEY (ai_suggestion_id) REFERENCES public.ai_suggestions(id)
);
CREATE TABLE public.model_status (
  model_name text NOT NULL,
  port integer,
  status text CHECK (status = ANY (ARRAY['idle'::text, 'busy'::text, 'error'::text, 'cooldown'::text])),
  assigned_task_id uuid,
  updated_at timestamp without time zone DEFAULT now(),
  CONSTRAINT model_status_pkey PRIMARY KEY (model_name),
  CONSTRAINT model_status_assigned_task_id_fkey FOREIGN KEY (assigned_task_id) REFERENCES public.ai_tasks(id)
);
CREATE TABLE public.outgoing_messages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  session_id text,
  user_id uuid,
  receiver text NOT NULL,
  reply_text text NOT NULL,
  source text DEFAULT 'manual'::text CHECK (source = ANY (ARRAY['ai'::text, 'manual'::text, 'device'::text])),
  related_ai_id uuid,
  sent_at timestamp with time zone DEFAULT now(),
  status text DEFAULT 'sent'::text CHECK (status = ANY (ARRAY['sent'::text, 'failed'::text, 'pending'::text, 'delivered'::text, 'read'::text, 'played'::text])),
  wa_message_id text UNIQUE,
  ack integer,
  media_url text,
  media_mime text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT outgoing_messages_pkey PRIMARY KEY (id),
  CONSTRAINT outgoing_messages_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT outgoing_messages_related_ai_id_fkey FOREIGN KEY (related_ai_id) REFERENCES public.ai_suggestions(id)
);
CREATE TABLE public.public_ai_tasks (
  id uuid NOT NULL,
  title text,
  role text,
  status text DEFAULT 'queued'::text,
  progress_note text,
  semantic_level integer,
  updated_at timestamp without time zone DEFAULT now(),
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT public_ai_tasks_pkey PRIMARY KEY (id)
);
CREATE TABLE public.registration_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  full_name text NOT NULL,
  phone text,
  role text NOT NULL CHECK (role = ANY (ARRAY['admin'::text, 'teacher'::text, 'parent'::text])),
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])),
  additional_info jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  reviewed_by uuid,
  reviewed_at timestamp with time zone,
  rejection_reason text,
  CONSTRAINT registration_requests_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_update_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  executed_at time with time zone DEFAULT now(),
  module text DEFAULT 'not null'::text,
  summary text,
  details jsonb,
  status text,
  source text DEFAULT '''github-action'''::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT system_update_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.teacher_attendance (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  teacher_id uuid NOT NULL,
  clock_date date NOT NULL,
  clock_in_time time without time zone,
  clock_out_time time without time zone,
  note text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT teacher_attendance_pkey PRIMARY KEY (id),
  CONSTRAINT teacher_attendance_teacher_id_fkey FOREIGN KEY (teacher_id) REFERENCES public.hanami_employee(id)
);
CREATE TABLE public.teacher_schedule (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  teacher_id uuid NOT NULL,
  scheduled_date date NOT NULL,
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  note text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT teacher_schedule_pkey PRIMARY KEY (id),
  CONSTRAINT teacher_schedule_teacher_id_fkey FOREIGN KEY (teacher_id) REFERENCES public.hanami_employee(id)
);
CREATE TABLE public.trial_reminder_log (
  trial_key text NOT NULL,
  sent_at timestamp with time zone NOT NULL,
  CONSTRAINT trial_reminder_log_pkey PRIMARY KEY (trial_key)
);
CREATE TABLE public.user_tags (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  tag text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_tags_pkey PRIMARY KEY (id),
  CONSTRAINT user_tags_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  phone text NOT NULL,
  name text,
  source_channel text DEFAULT 'whatsapp'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.whatsapp_group_whitelist (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  phone text NOT NULL,
  group_name text,
  remark text,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT timezone('Asia/Hong_Kong'::text, now()),
  CONSTRAINT whatsapp_group_whitelist_pkey PRIMARY KEY (id)
);