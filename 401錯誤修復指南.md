# 401錯誤修復指南

## 🔍 問題分析

從錯誤日誌可以看到兩個主要問題：

### 1. **權限問題 (401錯誤)**
```
Failed to load resource: the server responded with a status of 401 () (hanami_student_lesson, line 0)
```
這表示對 `hanami_student_lesson` 表的訪問被拒絕，可能是RLS (Row Level Security) 策略問題。

### 2. **資料庫函數問題**
```
relation "public.information_schema.tables" does not exist
Could not find the function public.scan_all_tables
```
這些是schema-scanner頁面的問題，不影響主要功能。

## 🔧 解決方案

### 步驟1：修復RLS權限問題

1. **在Supabase Dashboard中執行以下SQL腳本**：

```sql
-- 修復 hanami_student_lesson 表 RLS 權限問題

-- 1. 檢查當前狀態
SELECT 
  schemaname,
  tablename,
  rowsecurity as rls_enabled
FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename = 'hanami_student_lesson';

-- 2. 檢查現有策略
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies 
WHERE schemaname = 'public' 
  AND tablename = 'hanami_student_lesson';

-- 3. 如果RLS已啟用但沒有策略，先禁用RLS
ALTER TABLE hanami_student_lesson DISABLE ROW LEVEL SECURITY;

-- 4. 重新啟用RLS
ALTER TABLE hanami_student_lesson ENABLE ROW LEVEL SECURITY;

-- 5. 創建適當的RLS策略

-- 管理員可以查看所有課程
CREATE POLICY "Admins can view all lessons" ON hanami_student_lesson
FOR SELECT USING (auth.jwt() ->> 'role' = 'admin');

-- 管理員可以管理所有課程
CREATE POLICY "Admins can manage all lessons" ON hanami_student_lesson
FOR ALL USING (auth.jwt() ->> 'role' = 'admin');

-- 教師可以查看自己教授的課程
CREATE POLICY "Teachers can view own lessons" ON hanami_student_lesson
FOR SELECT USING (
  lesson_teacher = (
    SELECT teacher_nickname FROM hanami_employee WHERE id = auth.uid()
  ) OR 
  auth.jwt() ->> 'role' = 'admin'
);

-- 教師可以管理自己教授的課程
CREATE POLICY "Teachers can manage own lessons" ON hanami_student_lesson
FOR ALL USING (
  lesson_teacher = (
    SELECT teacher_nickname FROM hanami_employee WHERE id = auth.uid()
  ) OR 
  auth.jwt() ->> 'role' = 'admin'
);

-- 家長可以查看自己孩子的課程
CREATE POLICY "Parents can view own children lessons" ON hanami_student_lesson
FOR SELECT USING (
  student_id IN (
    SELECT student_id FROM hanami_parent_student_relations 
    WHERE parent_id = auth.uid()
  ) OR 
  auth.jwt() ->> 'role' = 'admin' OR
  auth.jwt() ->> 'role' = 'teacher'
);

-- 6. 設置表權限
GRANT ALL ON hanami_student_lesson TO authenticated;
GRANT ALL ON hanami_student_lesson TO service_role;

-- 7. 驗證修復結果
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies 
WHERE schemaname = 'public' 
  AND tablename = 'hanami_student_lesson'
ORDER BY policyname;
```

### 步驟2：測試修復結果

1. **重新載入學生資料頁面**
2. **檢查課堂資料是否正常顯示**
3. **如果仍有問題，檢查控制台錯誤訊息**

### 步驟3：創建測試資料（可選）

如果課堂資料為空，可以在schema-scanner頁面創建測試資料：

1. 前往 `/admin/schema-scanner`
2. 點擊「創建測試資料」按鈕
3. 檢查創建結果

## 🚨 常見問題

### Q: 執行SQL後仍有401錯誤？
A: 檢查以下幾點：
- 確認用戶角色設置正確
- 確認RLS策略已正確創建
- 檢查用戶是否有適當的權限

### Q: 如何檢查用戶角色？
A: 在Supabase Dashboard中檢查用戶的metadata：
```sql
SELECT 
  id,
  email,
  raw_user_meta_data
FROM auth.users
WHERE email = 'your-email@example.com';
```

### Q: 如何臨時禁用RLS進行測試？
A: 執行以下SQL（僅用於測試）：
```sql
ALTER TABLE hanami_student_lesson DISABLE ROW LEVEL SECURITY;
```

## 📞 聯繫支援

如果問題仍然存在，請提供：
1. 完整的錯誤日誌
2. 用戶角色信息
3. 資料庫表結構截圖

---

**注意**：修復後請重新測試所有相關功能，確保權限設置正確且不會影響其他用戶的訪問。 