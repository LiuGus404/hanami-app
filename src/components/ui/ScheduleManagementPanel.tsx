'use client'

import { useState, useEffect } from 'react'
import { supabase } from '@/lib/supabase'
import Image from 'next/image'
import { PopupSelect } from './PopupSelect'
import TimePicker from './TimePicker'

interface ScheduleSlot {
  id: string
  weekday: number | null
  timeslot: string | null
  max_students: number | null
  assigned_teachers: string | null
  created_at: string
  updated_at: string | null
  course_type: string | null
  duration: string | null
}

interface ClassType {
  id: string
  name: string | null
  status: boolean | null
  created_at: string
}

interface Teacher {
  id: string
  teacher_nickname: string | null
}

export default function ScheduleManagementPanel() {
  const [scheduleSlots, setScheduleSlots] = useState<ScheduleSlot[]>([])
  const [courseTypes, setCourseTypes] = useState<ClassType[]>([])
  const [teachers, setTeachers] = useState<Teacher[]>([])
  const [loading, setLoading] = useState(true)
  const [sortField, setSortField] = useState('weekday')
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('asc')
  const [selectedSlots, setSelectedSlots] = useState<string[]>([])
  const [selectAll, setSelectAll] = useState(false)

  // Êñ∞Â¢ûË™≤Â†ÇÊôÇÊÆµ
  const [showAddSlot, setShowAddSlot] = useState(false)
  const [newSlot, setNewSlot] = useState<Partial<ScheduleSlot>>({
    weekday: 1,
    timeslot: '09:00:00',
    max_students: 10,
    assigned_teachers: '',
    course_type: '',
    duration: '01:00:00'
  })

  // Á∑®ËºØË™≤Â†ÇÊôÇÊÆµ
  const [showEditSlot, setShowEditSlot] = useState(false)
  const [editSlot, setEditSlot] = useState<Partial<ScheduleSlot>>({})

  // ÈÅ∏ÊìáÂô®ÁãÄÊÖã
  const [showWeekdaySelect, setShowWeekdaySelect] = useState(false)
  const [showTeacherSelect, setShowTeacherSelect] = useState(false)
  const [showCourseTypeSelect, setShowCourseTypeSelect] = useState(false)
  const [showEditWeekdaySelect, setShowEditWeekdaySelect] = useState(false)
  const [showEditTeacherSelect, setShowEditTeacherSelect] = useState(false)
  const [showEditCourseTypeSelect, setShowEditCourseTypeSelect] = useState(false)

  const weekdays = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠']

  const handleSort = (field: string) => {
    if (sortField === field) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc')
    } else {
      setSortField(field)
      setSortDirection('asc')
    }
  }

  const getSortIcon = (field: string) => {
    if (sortField !== field) return null
    return sortDirection === 'asc' ? '‚Üë' : '‚Üì'
  }

  const sortScheduleSlots = (slots: ScheduleSlot[]) => {
    return [...slots].sort((a, b) => {
      let aVal: any = a[sortField as keyof ScheduleSlot]
      let bVal: any = b[sortField as keyof ScheduleSlot]

      if (sortField === 'weekday') {
        aVal = aVal || 0
        bVal = bVal || 0
      } else if (sortField === 'timeslot') {
        aVal = aVal || ''
        bVal = bVal || ''
      } else if (sortField === 'max_students') {
        aVal = aVal || 0
        bVal = bVal || 0
      } else {
        aVal = aVal || ''
        bVal = bVal || ''
      }

      if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1
      if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1
      return 0
    })
  }

  const fetchData = async () => {
    setLoading(true)
    try {
      // ÂèñÂæóË™≤Â†ÇÊôÇÊÆµ
      const { data: slotData, error: slotError } = await supabase
        .from('hanami_schedule')
        .select('*')
        .order('weekday')
        .order('timeslot')
      
      console.log('üîç Ë™≤Â†ÇÁ©∫Áº∫ÊÉÖÊ≥ÅË≥áÊñôÊü•Ë©¢ÁµêÊûú:', { slotData, slotError })
      
      if (slotError) throw slotError

      // ÂèñÂæóË™≤Á®ãË≥áÊñô
      const { data: classData, error: classError } = await supabase
        .from('Hanami_CourseTypes')
        .select('*')
        .order('name')
      
      if (classError) throw classError

      // ÂèñÂæóÊïôÂ∏´Ë≥áÊñô
      const { data: teacherData, error: teacherError } = await supabase
        .from('hanami_employee')
        .select('id, teacher_nickname')
        .order('teacher_nickname')
      
      if (teacherError) throw teacherError

      setScheduleSlots((slotData || []).map(slot => ({
        ...slot,
        created_at: slot.created_at || '',
        updated_at: slot.updated_at || ''
      })))
      setCourseTypes(classData || [])
      setTeachers(teacherData || [])

      console.log('‚úÖ Ë≥áÊñôËºâÂÖ•ÂÆåÊàê:', {
        Ë™≤Â†ÇÂ≠∏ÁîüÊï∏Èáè: slotData?.length || 0,
        Ë™≤Á®ãÈ°ûÂûã: classData?.length || 0,
        ÊïôÂ∏´Êï∏Èáè: teacherData?.length || 0
      })
    } catch (err: any) {
      console.error('‚ùå ËºâÂÖ•Ë≥áÊñôÂ§±Êïó:', err)
      alert('ËºâÂÖ•Ë≥áÊñôÂ§±ÊïóÔºö' + err.message)
    } finally {
      setLoading(false)
    }
  }

  const handleAddSlot = async () => {
    try {
      const { error } = await supabase
        .from('hanami_schedule')
        .insert([{ 
          ...newSlot,
          weekday: newSlot.weekday ?? 1,
          timeslot: newSlot.timeslot || '09:00:00',
          max_students: newSlot.max_students ?? 10,
          assigned_teachers: newSlot.assigned_teachers || null,
          course_type: newSlot.course_type || null,
          duration: newSlot.duration || null
        }])
      
      if (error) throw error
      
      setShowAddSlot(false)
      setNewSlot({
        weekday: 1,
        timeslot: '09:00:00',
        max_students: 10,
        assigned_teachers: '',
        course_type: '',
        duration: '01:00:00'
      })
      await fetchData()
      alert('Ë™≤Â†ÇÊôÇÊÆµÊñ∞Â¢ûÊàêÂäüÔºÅ')
    } catch (err: any) {
      alert('Êñ∞Â¢ûÂ§±ÊïóÔºö' + err.message)
    }
  }

  const handleDeleteSlot = async (id: string) => {
    if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë™≤Â†ÇÂóéÔºü')) return
    
    try {
      const { error } = await supabase
        .from('hanami_schedule')
        .delete()
        .eq('id', id)
      
      if (error) throw error
      
      await fetchData()
      alert('Ë™≤Â†ÇÊôÇÊÆµÂà™Èô§ÊàêÂäüÔºÅ')
    } catch (err: any) {
      alert('Âà™Èô§Â§±ÊïóÔºö' + err.message)
    }
  }

  const handleEditSlot = (slot: ScheduleSlot) => {
    setEditSlot(slot)
    setShowEditSlot(true)
  }

  const handleCloseEditSlot = () => {
    setEditSlot({})
    setShowEditSlot(false)
  }

  const handleUpdateSlot = async () => {
    try {
      const { error } = await supabase
        .from('hanami_schedule')
        .update({
          ...editSlot,
          weekday: editSlot.weekday ?? 1,
          timeslot: editSlot.timeslot || '09:00:00',
          max_students: editSlot.max_students ?? 10,
          assigned_teachers: editSlot.assigned_teachers || null,
          course_type: editSlot.course_type || null,
          duration: editSlot.duration || null
        })
        .eq('id', editSlot.id!)
      
      if (error) throw error
      
      setEditSlot({})
      setShowEditSlot(false)
      await fetchData()
      alert('Ë™≤Â†ÇÊôÇÊÆµÊõ¥Êñ∞ÊàêÂäüÔºÅ')
    } catch (err: any) {
      alert('Êõ¥Êñ∞Â§±ÊïóÔºö' + err.message)
    }
  }

  const handleCopySlot = (slot: ScheduleSlot) => {
    const { id, created_at, updated_at, ...copyData } = slot
    setNewSlot(copyData)
    setShowAddSlot(true)
  }

  const handleSelectSlot = (id: string) => {
    setSelectedSlots(prev => 
      prev.includes(id) 
        ? prev.filter(slotId => slotId !== id)
        : [...prev, id]
    )
  }

  const handleSelectAll = () => {
    if (selectAll) {
      setSelectedSlots([])
      setSelectAll(false)
    } else {
      setSelectedSlots(scheduleSlots.map(slot => slot.id))
      setSelectAll(true)
    }
  }

  const handleBatchDelete = async () => {
    if (selectedSlots.length === 0) {
      alert('Ë´ãÈÅ∏ÊìáË¶ÅÂà™Èô§ÁöÑË™≤Â†ÇÊôÇÊÆµ')
      return
    }
    
    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÅ∏‰∏≠ÁöÑ ${selectedSlots.length} ÂÄãË™≤Â†ÇÊôÇÊÆµÊ≥ÅÂóéÔºü`)) return
    
    try {
      const { error } = await supabase
        .from('hanami_schedule')
        .delete()
        .in('id', selectedSlots)
      
      if (error) throw error
      
      setSelectedSlots([])
      setSelectAll(false)
      await fetchData()
      alert('ÊâπÈáèÂà™Èô§Ë™≤Â†ÇÊôÇÊÆµÊàêÂäüÔºÅ')
    } catch (err: any) {
      alert('ÊâπÈáèÂà™Èô§Ë™≤Â†ÇÊôÇÊÆµÂ§±ÊïóÔºö' + err.message)
    }
  }

  useEffect(() => {
    fetchData()
  }, [])

  const sortedScheduleSlots = sortScheduleSlots(scheduleSlots)

  const [showCourseList, setShowCourseList] = useState(false)
  const [courses, setCourses] = useState<ClassType[]>([])
  const [newCourseName, setNewCourseName] = useState('')
  const [editingCourseId, setEditingCourseId] = useState<string | null>(null)
  const [editingCourseName, setEditingCourseName] = useState('')

  const fetchCourses = async () => {
    const { data, error } = await supabase
      .from('Hanami_CourseTypes')
      .select('*')
      .order('created_at')
    if (!error) setCourses(data || [])
  }

  useEffect(() => { fetchCourses() }, [])

  const handleAddCourse = async () => {
    if (!newCourseName.trim()) return
    const { error } = await supabase
      .from('Hanami_CourseTypes')
      .insert({ name: newCourseName.trim(), status: true })
    if (!error) {
      setNewCourseName('')
      fetchCourses()
    }
  }

  const handleEditCourse = (id: string, name: string) => {
    setEditingCourseId(id)
    setEditingCourseName(name)
  }

  const handleUpdateCourse = async () => {
    if (!editingCourseId || !editingCourseName.trim()) return
    const { error } = await supabase
      .from('Hanami_CourseTypes')
      .update({ name: editingCourseName.trim() })
      .eq('id', editingCourseId)
    if (!error) {
      setEditingCourseId(null)
      setEditingCourseName('')
      fetchCourses()
    }
  }

  const handleDeleteCourse = async (id: string) => {
    if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë™≤Á®ãÔºü')) return
    const { error } = await supabase
      .from('Hanami_CourseTypes')
      .delete()
      .eq('id', id)
    if (!error) fetchCourses()
  }

  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-[400px]">
        <div className="text-[#4B4036]">ËºâÂÖ•‰∏≠...</div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Ë™≤Á®ãÁÆ°ÁêÜÂçÄÂ°ä */}
      <div className="bg-[#FFFDF7] border border-[#EADBC8] rounded-xl p-4 mb-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-bold text-[#4B4036] flex items-center gap-2">
            <Image src="/icons/book-elephant.PNG" alt="Ë™≤Á®ã" width={24} height={24} />
            Ë™≤Á®ãÁÆ°ÁêÜ
          </h3>
          <button
            onClick={() => setShowCourseList(v => !v)}
            className="bg-[#A68A64] hover:bg-[#8f7350] text-white px-4 py-2 rounded-full text-sm transition-colors"
          >
            {showCourseList ? 'Êî∂Ëµ∑Ë™≤Á®ã' : 'Â±ïÈñãË™≤Á®ã'}
          </button>
        </div>
        {showCourseList && (
          <div className="space-y-2">
            {courses.map(course => (
              <div key={course.id} className="flex items-center gap-2 border-b border-[#EADBC8] py-2">
                {editingCourseId === course.id ? (
                  <>
                    <input
                      className="w-full p-2 border border-[#EADBC8] rounded bg-white text-[#4B4036] focus:ring-2 focus:ring-[#A68A64] focus:border-[#A68A64]"
                      value={editingCourseName}
                      onChange={e => setEditingCourseName(e.target.value)}
                    />
                    <button onClick={handleUpdateCourse} className="px-4 py-2 bg-[#A68A64] hover:bg-[#8f7350] text-white rounded">ÂÑ≤Â≠ò</button>
                    <button onClick={() => setEditingCourseId(null)} className="px-4 py-2 text-[#4B4036] border border-[#EADBC8] rounded">ÂèñÊ∂à</button>
                  </>
                ) : (
                  <>
                    <span className="flex-1 text-[#4B4036]">{course.name}</span>
                    <button onClick={() => handleEditCourse(course.id, course.name || '')} className="text-blue-500 hover:text-blue-700 text-sm">Á∑®ËºØ</button>
                    <button onClick={() => handleDeleteCourse(course.id)} className="text-red-500 hover:text-red-700 text-sm">Âà™Èô§</button>
                  </>
                )}
              </div>
            ))}
            <div className="flex items-center gap-2 mt-2">
              <input
                className="w-full p-2 border border-[#EADBC8] rounded bg-white text-[#4B4036] focus:ring-2 focus:ring-[#A68A64] focus:border-[#A68A64]"
                placeholder="Êñ∞Â¢ûË™≤Á®ãÂêçÁ®±"
                value={newCourseName}
                onChange={e => setNewCourseName(e.target.value)}
              />
              <button onClick={handleAddCourse} className="px-4 py-2 bg-[#A68A64] hover:bg-[#8f7350] text-white rounded">Êñ∞Â¢û</button>
            </div>
          </div>
        )}
      </div>
      {/* Ë™≤Â†ÇÁ©∫Áº∫ÊÉÖÊ≥ÅÁÆ°ÁêÜ */}
      <div className="bg-[#FFFDF7] border border-[#EADBC8] rounded-xl p-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-bold text-[#4B4036] flex items-center gap-2">
            <Image src="/icons/clock.PNG" alt="time" width={24} height={24} />
            Ë™≤Â†ÇÁÆ°ÁêÜ
          </h3>
          <div className="flex items-center gap-2">
            {selectedSlots.length > 0 && (
              <button
                onClick={handleBatchDelete}
                className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors"
              >
                ÊâπÈáèÂà™Èô§ ({selectedSlots.length})
              </button>
            )}
            <button
              onClick={() => setShowAddSlot(true)}
              className="bg-[#A68A64] hover:bg-[#8f7350] text-white px-4 py-2 rounded-full text-sm transition-colors"
            >
              Êñ∞Â¢ûË™≤Â†ÇÊôÇÊÆµ
            </button>
          </div>
        </div>
        
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="border-b border-[#EADBC8]">
                <th className="text-left p-2">
                  <input
                    type="checkbox"
                    checked={selectAll}
                    onChange={handleSelectAll}
                    className="w-4 h-4 text-[#4B4036] accent-[#CBBFA4]"
                  />
                </th>
                <th className="text-left p-2 cursor-pointer" onClick={() => handleSort('weekday')}>
                  <div className="flex items-center gap-1">
                    ÊòüÊúü
                    {getSortIcon('weekday')}
                  </div>
                </th>
                <th className="text-left p-2 cursor-pointer" onClick={() => handleSort('timeslot')}>
                  <div className="flex items-center gap-1">
                    Ë™≤Â†ÇÊôÇÊÆµ
                    {getSortIcon('timeslot')}
                  </div>
                </th>
                <th className="text-left p-2 cursor-pointer" onClick={() => handleSort('max_students')}>
                  <div className="flex items-center gap-1">
                    ÊúÄÂ§ßÂ≠∏ÁîüÊï∏
                    {getSortIcon('max_students')}
                  </div>
                </th>
                <th className="text-left p-2 cursor-pointer" onClick={() => handleSort('assigned_teachers')}>
                  <div className="flex items-center gap-1">
                    ÊåáÊ¥æËÄÅÂ∏´
                    {getSortIcon('assigned_teachers')}
                  </div>
                </th>
                <th className="text-left p-2 cursor-pointer" onClick={() => handleSort('course_type')}>
                  <div className="flex items-center gap-1">
                    Ë™≤Á®ãÈ°ûÂûã
                    {getSortIcon('course_type')}
                  </div>
                </th>
                <th className="text-left p-2 cursor-pointer" onClick={() => handleSort('duration')}>
                  <div className="flex items-center gap-1">
                    ÊôÇÈï∑
                    {getSortIcon('duration')}
                  </div>
                </th>
                <th className="text-left p-2">Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody>
              {sortedScheduleSlots.map((slot) => (
                <tr key={slot.id} className="border-b border-[#EADBC8]">
                  <td className="p-2">
                    <input
                      type="checkbox"
                      checked={selectedSlots.includes(slot.id)}
                      onChange={() => handleSelectSlot(slot.id)}
                      className="w-4 h-4 text-[#4B4036] accent-[#CBBFA4]"
                    />
                  </td>
                  <td className="p-2">{weekdays[slot.weekday || 0]}</td>
                  <td className="p-2">{slot.timeslot?.slice(0, 5)}</td>
                  <td className="p-2">{slot.max_students}</td>
                  <td className="p-2">{slot.assigned_teachers || '-'}</td>
                  <td className="px-4 py-2 text-center">
                    {courseTypes.find(type => type.id === slot.course_type)?.name || slot.course_type || '-'}
                  </td>
                  <td className="p-2">{slot.duration?.slice(0, 5) || '-'}</td>
                  <td className="p-2">
                    <div className="flex items-center gap-1">
                      <button
                        onClick={() => handleCopySlot(slot)}
                        className="text-green-500 hover:text-green-700 text-sm"
                        title="Ë§áË£ΩÊ≠§Ë™≤Â†ÇÁ©∫Áº∫ÊÉÖÊ≥Å"
                      >
                        Ë§áË£Ω
                      </button>
                      <button
                        onClick={() => handleEditSlot(slot)}
                        className="text-blue-500 hover:text-blue-700 text-sm"
                      >
                        Á∑®ËºØ
                      </button>
                      <button
                        onClick={() => handleDeleteSlot(slot.id)}
                        className="text-red-500 hover:text-red-700 text-sm"
                      >
                        Âà™Èô§
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Êñ∞Â¢ûË™≤Â†ÇÊôÇÊÆµÂΩàÁ™ó */}
      {showAddSlot && (
        <div className="fixed inset-0 flex items-center justify-center z-50" style={{background: 'rgba(255,255,255,0.7)'}}>
          <div className="bg-white p-6 rounded-xl w-96 max-h-[80vh] overflow-y-auto shadow-xl border border-[#EADBC8]">
            <h3 className="text-lg font-bold mb-4">Êñ∞Â¢ûË™≤Â†ÇÊôÇÊÆµ</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">ÊòüÊúü</label>
                <button
                  onClick={() => setShowWeekdaySelect(true)}
                  className="w-full text-left border border-[#E4D5BC] bg-[#FFFCF5] rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#A68A64]"
                >
                  {newSlot.weekday === 1 ? 'ÊòüÊúü‰∏Ä' :
                   newSlot.weekday === 2 ? 'ÊòüÊúü‰∫å' :
                   newSlot.weekday === 3 ? 'ÊòüÊúü‰∏â' :
                   newSlot.weekday === 4 ? 'ÊòüÊúüÂõõ' :
                   newSlot.weekday === 5 ? 'ÊòüÊúü‰∫î' :
                   newSlot.weekday === 6 ? 'ÊòüÊúüÂÖ≠' :
                   newSlot.weekday === 0 ? 'ÊòüÊúüÊó•' : 'Ë´ãÈÅ∏ÊìáÊòüÊúü'}
                </button>
                {showWeekdaySelect && (
                  <PopupSelect
                    title="ÈÅ∏ÊìáÊòüÊúü"
                    options={[
                      { label: 'ÊòüÊúü‰∏Ä', value: '1' },
                      { label: 'ÊòüÊúü‰∫å', value: '2' },
                      { label: 'ÊòüÊúü‰∏â', value: '3' },
                      { label: 'ÊòüÊúüÂõõ', value: '4' },
                      { label: 'ÊòüÊúü‰∫î', value: '5' },
                      { label: 'ÊòüÊúüÂÖ≠', value: '6' },
                      { label: 'ÊòüÊúüÊó•', value: '0' }
                    ]}
                    selected={newSlot.weekday?.toString() || '1'}
                    onChange={(value) => setNewSlot({...newSlot, weekday: parseInt(value as string)})}
                    onConfirm={() => setShowWeekdaySelect(false)}
                    onCancel={() => setShowWeekdaySelect(false)}
                    mode="single"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Ë™≤Â†ÇÊôÇÊÆµ</label>
                <TimePicker
                  value={newSlot.timeslot?.slice(0, 5) || '09:00'}
                  onChange={(time) => setNewSlot({...newSlot, timeslot: time + ':00'})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">ÊúÄÂ§ßÂ≠∏ÁîüÊï∏</label>
                <input 
                  type="number" 
                  value={newSlot.max_students ?? 10} 
                  onChange={e => setNewSlot({...newSlot, max_students: parseInt(e.target.value)})} 
                  className="w-full p-2 border border-[#EADBC8] rounded bg-white text-[#4B4036] focus:ring-2 focus:ring-[#A68A64] focus:border-[#A68A64]" 
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">ÊåáÊ¥æËÄÅÂ∏´</label>
                <button
                  onClick={() => setShowTeacherSelect(true)}
                  className="w-full text-left border border-[#E4D5BC] bg-[#FFFCF5] rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#A68A64]"
                >
                  {newSlot.assigned_teachers || 'Ë´ãÈÅ∏ÊìáËÄÅÂ∏´'}
                </button>
                {showTeacherSelect && (
                  <PopupSelect
                    title="ÈÅ∏ÊìáËÄÅÂ∏´"
                    options={teachers.map(teacher => ({ label: teacher.teacher_nickname || '', value: teacher.teacher_nickname || '' }))}
                    selected={newSlot.assigned_teachers || ''}
                    onChange={(value) => setNewSlot({...newSlot, assigned_teachers: value as string})}
                    onConfirm={() => setShowTeacherSelect(false)}
                    onCancel={() => setShowTeacherSelect(false)}
                    mode="single"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Ë™≤Á®ãÈ°ûÂûã</label>
                <button
                  onClick={() => setShowCourseTypeSelect(true)}
                  className="w-full text-left border border-[#E4D5BC] bg-[#FFFCF5] rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#A68A64]"
                >
                  {courseTypes.find(type => type.id === newSlot.course_type)?.name || 'Ë´ãÈÅ∏ÊìáË™≤Á®ãÈ°ûÂûã'}
                </button>
                {showCourseTypeSelect && (
                  <PopupSelect
                    title="ÈÅ∏ÊìáË™≤Á®ãÈ°ûÂûã"
                    options={courseTypes.map(type => ({ label: type.name || '', value: type.id }))}
                    selected={newSlot.course_type || ''}
                    onChange={(value) => setNewSlot({...newSlot, course_type: value as string})}
                    onConfirm={() => setShowCourseTypeSelect(false)}
                    onCancel={() => setShowCourseTypeSelect(false)}
                    mode="single"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">ÊôÇÈï∑</label>
                <TimePicker
                  value={newSlot.duration?.slice(0, 5) || '01:00'}
                  onChange={(time) => setNewSlot({...newSlot, duration: time + ':00'})}
                />
              </div>
            </div>
            <div className="flex gap-2 justify-end mt-6">
              <button onClick={() => setShowAddSlot(false)} className="px-4 py-2 text-[#4B4036] border border-[#EADBC8] rounded">ÂèñÊ∂à</button>
              <button onClick={handleAddSlot} className="px-4 py-2 bg-[#A68A64] hover:bg-[#8f7350] text-white rounded">Êñ∞Â¢û</button>
            </div>
          </div>
        </div>
      )}

      {/* Á∑®ËºØË™≤Â†ÇÁ©∫Áº∫ÊÉÖÊ≥ÅÂΩàÁ™ó */}
      {showEditSlot && (
        <div className="fixed inset-0 flex items-center justify-center z-50" style={{background: 'rgba(255,255,255,0.7)'}}>
          <div className="bg-white p-6 rounded-xl w-96 max-h-[80vh] overflow-y-auto shadow-xl border border-[#EADBC8]">
            <h3 className="text-lg font-bold mb-4">Á∑®ËºØË™≤Â†ÇÊôÇÊÆµ</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">ÊòüÊúü</label>
                <button
                  onClick={() => setShowEditWeekdaySelect(true)}
                  className="w-full text-left border border-[#E4D5BC] bg-[#FFFCF5] rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#A68A64]"
                >
                  {editSlot.weekday === 1 ? 'ÊòüÊúü‰∏Ä' :
                   editSlot.weekday === 2 ? 'ÊòüÊúü‰∫å' :
                   editSlot.weekday === 3 ? 'ÊòüÊúü‰∏â' :
                   editSlot.weekday === 4 ? 'ÊòüÊúüÂõõ' :
                   editSlot.weekday === 5 ? 'ÊòüÊúü‰∫î' :
                   editSlot.weekday === 6 ? 'ÊòüÊúüÂÖ≠' :
                   editSlot.weekday === 0 ? 'ÊòüÊúüÊó•' : 'Ë´ãÈÅ∏ÊìáÊòüÊúü'}
                </button>
                {showEditWeekdaySelect && (
                  <PopupSelect
                    title="ÈÅ∏ÊìáÊòüÊúü"
                    options={[
                      { label: 'ÊòüÊúü‰∏Ä', value: '1' },
                      { label: 'ÊòüÊúü‰∫å', value: '2' },
                      { label: 'ÊòüÊúü‰∏â', value: '3' },
                      { label: 'ÊòüÊúüÂõõ', value: '4' },
                      { label: 'ÊòüÊúü‰∫î', value: '5' },
                      { label: 'ÊòüÊúüÂÖ≠', value: '6' },
                      { label: 'ÊòüÊúüÊó•', value: '0' }
                    ]}
                    selected={editSlot.weekday?.toString() || '1'}
                    onChange={(value) => setEditSlot({...editSlot, weekday: parseInt(value as string)})}
                    onConfirm={() => setShowEditWeekdaySelect(false)}
                    onCancel={() => setShowEditWeekdaySelect(false)}
                    mode="single"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Ë™≤Â†ÇÊÉÖÊ≥Å</label>
                <TimePicker
                  value={editSlot.timeslot?.slice(0, 5) || '09:00'}
                  onChange={(time) => setEditSlot({...editSlot, timeslot: time + ':00'})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">ÊúÄÂ§ßÂ≠∏ÁîüÊï∏</label>
                <input 
                  type="number" 
                  value={editSlot.max_students ?? 10} 
                  onChange={e => setEditSlot({...editSlot, max_students: parseInt(e.target.value)})} 
                  className="w-full p-2 border border-[#EADBC8] rounded bg-white text-[#4B4036] focus:ring-2 focus:ring-[#A68A64] focus:border-[#A68A64]" 
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">ÊåáÊ¥æËÄÅÂ∏´</label>
                <button
                  onClick={() => setShowEditTeacherSelect(true)}
                  className="w-full text-left border border-[#E4D5BC] bg-[#FFFCF5] rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#A68A64]"
                >
                  {editSlot.assigned_teachers || 'Ë´ãÈÅ∏ÊìáËÄÅÂ∏´'}
                </button>
                {showEditTeacherSelect && (
                  <PopupSelect
                    title="ÈÅ∏ÊìáËÄÅÂ∏´"
                    options={teachers.map(teacher => ({ label: teacher.teacher_nickname || '', value: teacher.teacher_nickname || '' }))}
                    selected={editSlot.assigned_teachers || ''}
                    onChange={(value) => setEditSlot({...editSlot, assigned_teachers: value as string})}
                    onConfirm={() => setShowEditTeacherSelect(false)}
                    onCancel={() => setShowEditTeacherSelect(false)}
                    mode="single"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Ë™≤Á®ãÈ°ûÂûã</label>
                <button
                  onClick={() => setShowEditCourseTypeSelect(true)}
                  className="w-full text-left border border-[#E4D5BC] bg-[#FFFCF5] rounded-lg px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#A68A64]"
                >
                  {courseTypes.find(type => type.id === editSlot.course_type)?.name || 'Ë´ãÈÅ∏ÊìáË™≤Á®ãÈ°ûÂûã'}
                </button>
                {showEditCourseTypeSelect && (
                  <PopupSelect
                    title="ÈÅ∏ÊìáË™≤Á®ãÈ°ûÂûã"
                    options={courseTypes.map(type => ({ label: type.name || '', value: type.id }))}
                    selected={editSlot.course_type || ''}
                    onChange={(value) => setEditSlot({...editSlot, course_type: value as string})}
                    onConfirm={() => setShowEditCourseTypeSelect(false)}
                    onCancel={() => setShowEditCourseTypeSelect(false)}
                    mode="single"
                  />
                )}
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">ÊôÇÈï∑</label>
                <TimePicker
                  value={editSlot.duration?.slice(0, 5) || '01:00'}
                  onChange={(time) => setEditSlot({...editSlot, duration: time + ':00'})}
                />
              </div>
            </div>
            <div className="flex gap-2 justify-end mt-6">
              <button onClick={handleCloseEditSlot} className="px-4 py-2 text-[#4B4036] border border-[#EADBC8] rounded">ÂèñÊ∂à</button>
              <button onClick={handleUpdateSlot} className="px-4 py-2 bg-[#A68A64] hover:bg-[#8f7350] text-white rounded">Êõ¥Êñ∞</button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
} 