// app/aihome/parent/student-simple/[id]/page.tsx
'use client';

import { useParams, useRouter, useSearchParams } from 'next/navigation';
import { useEffect, useState, useRef, useCallback } from 'react';

import BackButton from '@/components/ui/BackButton';
import LessonEditorModal from '@/components/ui/LessonEditorModal';
import { PopupSelect } from '@/components/ui/PopupSelect';
import StudentBasicInfo from '@/components/ui/StudentBasicInfo';
import StudentLessonPanel from '@/components/ui/StudentLessonPanel';
import EnhancedStudentAvatarTab from '@/components/ui/EnhancedStudentAvatarTab';
import StudentMediaTimeline from '@/components/ui/StudentMediaTimeline';
import { BindingStatusIndicator } from '@/components/ui/StudentBindingButton';
import { getSupabaseClient } from '@/lib/supabase';
import { useSaasAuth } from '@/hooks/saas/useSaasAuthSimple';
import { useParentId } from '@/hooks/useParentId';
import { Lesson } from '@/types';
import { motion, AnimatePresence } from 'framer-motion';
import { User, BookOpen, UserCircle, Sparkles, Camera, Menu, X, Home, User as UserIcon, Settings, Calendar, LogOut, Building } from 'lucide-react';
import AppSidebar from '@/components/AppSidebar';

export default function SimpleStudentDetailPage() {
  const { id } = useParams();
  const router = useRouter();
  const searchParams = useSearchParams();
  const institution = searchParams.get('institution') || 'Hanami Music';
  const { user, loading, logout } = useSaasAuth();
  const parentId = useParentId();
  const [student, setStudent] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);
  const [pageLoading, setPageLoading] = useState(true);
  const [showPopup, setShowPopup] = useState(false);
  const [statusPopupOpen, setStatusPopupOpen] = useState<string | null>(null);
  const [showCategoryPopup, setShowCategoryPopup] = useState(false);
  const [categoryFilter, setCategoryFilter] = useState<string[]>(['all']);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingLesson, setEditingLesson] = useState<any>(null);
  const [tempCategoryFilter, setTempCategoryFilter] = useState<string[]>(['all']);
  const [categorySelectOpen, setCategorySelectOpen] = useState(false);
  const [isInactiveStudent, setIsInactiveStudent] = useState(false);
  const [isRestoring, setIsRestoring] = useState(false);
  const [courseUpdateTrigger, setCourseUpdateTrigger] = useState(0);
  const [activeTab, setActiveTab] = useState<'basic' | 'lessons' | 'avatar' | 'media'>('basic');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [isStudentBound, setIsStudentBound] = useState(false);
  
  // Ê∑ªÂä†Èò≤ÊäñÊ©üÂà∂
  const dataFetchedRef = useRef(false);
  const currentIdRef = useRef<string | null>(null);
  const loadingRef = useRef(false);
  
  // Ë™≤Á®ãÊõ¥Êñ∞ÂõûË™øÂáΩÊï∏
  const handleCourseUpdate = useCallback(() => {
    // Ëß∏ÁôºË™≤Á®ãÊõ¥Êñ∞
    setCourseUpdateTrigger(prev => prev + 1);
  }, []);

  // Êõ¥Êñ∞ÊôÇÈñì
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  // ÁôªÂá∫ËôïÁêÜ
  const handleLogout = async () => {
    try {
      await logout();
      router.push('/aihome/auth/login');
    } catch (error) {
      console.error('ÁôªÂá∫Â§±Êïó:', error);
    }
  };

  // ÂÅ¥ÈÇäÊ¨ÑÈÅ∏ÂñÆÈ†ÖÁõÆ
  const sidebarMenuItems = [
    { icon: Home, label: 'È¶ñÈ†Å', href: '/aihome', description: 'ËøîÂõû‰∏ªÈ†Å' },
    { icon: Calendar, label: 'Ë™≤Á®ãÊ¥ªÂãï', href: '/aihome/course-activities', description: 'Êü•ÁúãÊâÄÊúâÂ†±ËÆÄÁöÑÊ©üÊßãÂíåË™≤Á®ãÊ¥ªÂãï' },
    { icon: UserIcon, label: 'ÂÄã‰∫∫Ë≥áÊñô', href: '/aihome/profile', description: 'Êü•ÁúãÂíåÁ∑®ËºØÂÄã‰∫∫Ë≥áÊñô' },
    { icon: Settings, label: 'Ë®≠ÁΩÆ', href: '/aihome/settings', description: 'Á≥ªÁµ±Ë®≠ÁΩÆÂíåÂÅèÂ•Ω' }
  ];

  // ËôïÁêÜËøîÂõûÊåâÈàï
  const handleBack = () => {
    router.push('/aihome/parent/bound-students');
  };

  useEffect(() => {
    // Â¶ÇÊûúÊ≠£Âú®ËºâÂÖ•ÊàñÊ≤íÊúâÁî®Êà∂Ôºå‰∏çÂü∑Ë°å
    if (loading || !user) return;
    
    // Â¶ÇÊûú ID Ê≤íÊúâËÆäÂåñ‰∏îÂ∑≤Á∂ìËºâÂÖ•ÈÅéÔºå‰∏çÈáçË§áËºâÂÖ•
    if (currentIdRef.current === id && dataFetchedRef.current) return;
    
    // Èò≤Ê≠¢ÈáçË§áËºâÂÖ•
    if (loadingRef.current) return;
    loadingRef.current = true;
    
    // Êõ¥Êñ∞Áï∂Ââç ID
    currentIdRef.current = id as string;
    
    setPageLoading(true);
    setStudent(null);
    setError(null);
    setIsInactiveStudent(false);

    const checkAuth = async () => {
      try {
        const supabase = getSupabaseClient();
        
        // ÂÖàÊ™¢Êü•ÊòØÂê¶ÁÇ∫ÂÅúÁî®Â≠∏Áîü
        const { data: inactiveData, error: inactiveError } = await supabase
          .from('inactive_student_list')
          .select('*')
          .eq('id', id as string)
          .single();

        if (inactiveData) {
          console.log('ÊâæÂà∞ÂÅúÁî®Â≠∏Áîü:', inactiveData);

          // Â∞áÂÅúÁî®Â≠∏ÁîüË≥áÊñôËΩâÊèõÁÇ∫Ê®ôÊ∫ñÊ†ºÂºè
          const convertedStudent = {
            ...inactiveData,
            id: inactiveData.original_id,
            original_id: inactiveData.original_id,
            student_type: inactiveData.student_type === 'regular' ? 'Â∏∏Ë¶è' : 'Ë©¶Â†Ç',
            is_inactive: true,
            inactive_date: inactiveData.inactive_date,
            inactive_reason: inactiveData.inactive_reason,
            institution: inactiveData.institution
          };
          setStudent(convertedStudent);
          setIsInactiveStudent(true);
          setPageLoading(false);
          dataFetchedRef.current = true;
          loadingRef.current = false;
          
          // Ë®òÈåÑË®™ÂïèÊó•Ë™å
          await logAccess(convertedStudent.id, institution, 'view');
          
          // Ê™¢Êü•Ë™≤Â†ÇË≥áÊñô
          await checkLessonData(convertedStudent.id);
          return;
        }

        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Ë©¶Â†ÇÂ≠∏Áîü
        const { data: trialData, error: trialError } = await supabase
          .from('hanami_trial_students')
          .select('*')
          .eq('id', id as string)
          .single();

        if (trialData) {
          console.log('ÊâæÂà∞Ë©¶Â†ÇÂ≠∏Áîü:', trialData);

          setStudent(trialData);
          setPageLoading(false);
          dataFetchedRef.current = true;
          loadingRef.current = false;
          
          // Ë®òÈåÑË®™ÂïèÊó•Ë™å
          await logAccess(trialData.id, institution, 'view');
          
          // Ê™¢Êü•Ë™≤Â†ÇË≥áÊñô
          await checkLessonData(trialData.id);
          return;
        }

        // Â¶ÇÊûú‰∏çÊòØË©¶Â†ÇÂ≠∏ÁîüÔºåÂâáÂæûÂ∏∏Ë¶èÂ≠∏ÁîüË°®‰∏≠Áç≤ÂèñÊï∏Êìö
        const { data: studentData, error: studentError } = await supabase
          .from('Hanami_Students')
          .select('*')
          .eq('id', id as string)
          .single();

        if (studentError) {
          console.error('Error fetching student:', studentError);
          setError('ÁÑ°Ê≥ïÁç≤ÂèñÂ≠∏ÁîüË≥áÊñôÔºåË´ãÊ™¢Êü•Â≠∏Áîü ID ÊàñËÅØÁπ´Ê©üÊßãÁç≤ÂèñÊ≠£Á¢∫ ID');
          setPageLoading(false);
          loadingRef.current = false;
          return;
        }

        if (!studentData) {
          setError('Êâæ‰∏çÂà∞Â≠∏ÁîüË≥áÊñôÔºåË´ãÊ™¢Êü•Â≠∏Áîü ID ÊàñËÅØÁπ´Ê©üÊßãÁç≤ÂèñÊ≠£Á¢∫ ID');
          setPageLoading(false);
          loadingRef.current = false;
          return;
        }

        setStudent(studentData);
        setPageLoading(false);
        dataFetchedRef.current = true;
        loadingRef.current = false;
        
        // Ë®òÈåÑË®™ÂïèÊó•Ë™å
        await logAccess(studentData.id, institution, 'view');
        
        // Ê™¢Êü•Á∂ÅÂÆöÁãÄÊÖã
        await checkBindingStatus(studentData.id);
        
        // Ê™¢Êü•Ë™≤Â†ÇË≥áÊñô
        await checkLessonData(studentData.id);
      } catch (err) {
        console.error('Error:', err);
        setError('ÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶');
        setPageLoading(false);
        loadingRef.current = false;
      }
    };

    // Ê™¢Êü•Ë™≤Â†ÇË≥áÊñôÁöÑËºîÂä©ÂáΩÊï∏
    const checkLessonData = async (studentId: string) => {
      try {
        console.log('üîç Ê™¢Êü•Ë™≤Â†ÇË≥áÊñôË°®...');
        
        const supabase = getSupabaseClient();
        
        // Ê™¢Êü•Ë°®ÊòØÂê¶Â≠òÂú®Ë≥áÊñô
        const { data: allLessons, error: allError } = await supabase
          .from('hanami_student_lesson')
          .select('*')
          .limit(5);
        
        console.log('üìä Ë™≤Â†ÇË≥áÊñôË°®Ê™¢Êü•:', { 
          hasData: allLessons && allLessons.length > 0,
          totalRecords: allLessons?.length || 0,
          sampleData: allLessons?.slice(0, 2).map(l => ({ id: l.id, student_id: l.student_id, lesson_date: l.lesson_date })),
          error: allError?.message || 'ÁÑ°ÈåØË™§',
        });
        
        // Ê™¢Êü•ÁâπÂÆöÂ≠∏ÁîüÁöÑË™≤Â†ÇË≥áÊñô
        const { data: studentLessons, error: studentError } = await supabase
          .from('hanami_student_lesson')
          .select('id, lesson_date, course_type, student_id')
          .eq('student_id', studentId)
          .limit(5);
        
        console.log('üìã Â≠∏ÁîüË™≤Â†ÇË≥áÊñôÊ™¢Êü•:', {
          studentId,
          lessonCount: studentLessons?.length || 0,
          lessons: studentLessons?.map(l => ({ id: l.id, date: l.lesson_date, type: l.course_type, student_id: l.student_id })),
          error: studentError?.message || 'ÁÑ°ÈåØË™§',
        });
        
      } catch (err) {
        console.error('‚ùå Ê™¢Êü•Ë™≤Â†ÇË≥áÊñôÂ§±Êïó:', err);
      }
    };

    checkAuth();
  }, [user, loading, id, institution]);

  // Áï∂ ID ËÆäÂåñÊôÇÈáçÁΩÆÈò≤ÊäñÁãÄÊÖã
  useEffect(() => {
    if (currentIdRef.current !== id) {
      dataFetchedRef.current = false;
      loadingRef.current = false;
    }
  }, [id]);

  // Ë®òÈåÑË®™ÂïèÊó•Ë™å
  const logAccess = async (studentId: string, institution: string, action: string) => {
    try {
      console.log('Ë®™ÂïèÊó•Ë™å:', {
        timestamp: new Date().toISOString(),
        userId: user?.id,
        studentId,
        institution,
        action,
        userAgent: navigator.userAgent,
        ip: 'client-side'
      });
    } catch (err) {
      console.error('Ë®òÈåÑË®™ÂïèÊó•Ë™åÂ§±Êïó:', err);
    }
  };

  // Ê™¢Êü•Â≠©Â≠êÁ∂ÅÂÆöÁãÄÊÖã
  const checkBindingStatus = async (studentId: string) => {
    if (!parentId) return;
    
    try {
      const response = await fetch(`/api/parent/bind-student?parentId=${parentId}`);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.success && data.bindings) {
        const isBound = data.bindings.some((binding: any) => binding.student_id === studentId);
        setIsStudentBound(isBound);
      }
    } catch (error) {
      console.error('Ê™¢Êü•Á∂ÅÂÆöÁãÄÊÖãÈåØË™§:', error);
    }
  };

  if (pageLoading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-[#FFF9F2] to-[#FFD59A] flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#4B4036] mx-auto mb-4"></div>
          <p className="text-[#4B4036]">ËºâÂÖ•‰∏≠...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-[#FFF9F2] to-[#FFD59A] flex items-center justify-center">
        <div className="max-w-2xl mx-auto px-4">
          <div className="bg-white rounded-2xl p-8 shadow-lg border border-[#EADBC8] text-center">
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
              </svg>
            </div>
            <h2 className="text-2xl font-bold text-[#4B4036] mb-4">ÁÑ°Ê≥ïËºâÂÖ•Â≠∏ÁîüË≥áÊñô</h2>
            <p className="text-[#2B3A3B] mb-6">{error}</p>
            <div className="space-y-3">
              <motion.button
                onClick={handleBack}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="w-full inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-[#FFD59A] to-[#EBC9A4] text-[#4B4036] rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200"
              >
                ËøîÂõûÂÆ∂Èï∑ÈÄ£Áµê
              </motion.button>
              <motion.button
                onClick={() => router.push('/aihome')}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="w-full inline-flex items-center justify-center px-6 py-3 bg-white border border-[#EADBC8] text-[#4B4036] rounded-xl font-semibold hover:bg-[#FFD59A]/10 transition-all duration-200"
              >
                ËøîÂõûÈ¶ñÈ†Å
              </motion.button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (!student) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-[#FFF9F2] to-[#FFD59A] flex items-center justify-center">
        <div className="text-center">
          <p className="text-[#4B4036]">Êâæ‰∏çÂà∞Â≠∏ÁîüË≥áÊñô</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#FFF9F2] via-[#FFFDF8] to-[#FFD59A]">
      <div className="flex">
        {/* ÂÅ¥ÈÇäÊ¨ÑÈÅ∏ÂñÆ */}
        <AppSidebar 
          isOpen={sidebarOpen} 
          onClose={() => setSidebarOpen(false)}
          currentPath="/aihome/parent/student-simple/[id]"
        />

        {/* ‰∏ªÂÖßÂÆπÂçÄÂüü */}
        <div className="flex-1 flex flex-col bg-gradient-to-br from-[#FFF9F2] via-[#FFFDF8] to-[#FFD59A] min-h-full">
          {/* È†ÇÈÉ®Â∞éËà™Ê¨Ñ */}
          <nav className="bg-white/80 backdrop-blur-sm border-b border-[#EADBC8] sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-14 sm:h-16">
            <div className="flex items-center space-x-2 sm:space-x-4">
              {/* ÈÅ∏ÂñÆÊåâÈàï */}
              <motion.button
                onClick={() => setSidebarOpen(!sidebarOpen)}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="p-1.5 sm:p-2 rounded-lg hover:bg-[#FFD59A]/20 transition-colors"
                title="ÈñãÂïüÈÅ∏ÂñÆ"
              >
                <Menu className="w-5 h-5 sm:w-6 sm:h-6 text-[#4B4036]" />
              </motion.button>
              
              <div className="w-8 h-8 sm:w-10 sm:h-10 relative">
                <img 
                  src="/@hanami.png" 
                  alt="HanamiEcho Logo" 
                  className="w-full h-full object-contain"
                />
              </div>
              <div>
                <h1 className="text-lg sm:text-xl font-bold text-[#4B4036]">HanamiEcho</h1>
                <p className="text-xs sm:text-sm text-[#2B3A3B]">ÂÆ∂Èï∑Êü•Áúã</p>
              </div>
            </div>
            
            <div className="flex items-center space-x-2 sm:space-x-4">
              {/* Ê°åÈù¢ÁâàÔºöÈ°ØÁ§∫ÊôÇÈñì */}
              <div className="hidden sm:block text-sm text-[#2B3A3B]">
                {currentTime.toLocaleTimeString('zh-TW', { 
                  hour: '2-digit', 
                  minute: '2-digit' 
                })}
              </div>
              <div className="w-7 h-7 sm:w-8 sm:h-8 bg-gradient-to-br from-[#FFD59A] to-[#EBC9A4] rounded-full flex items-center justify-center">
                <span className="text-xs sm:text-sm font-medium text-[#4B4036]">
                  {user?.full_name?.charAt(0).toUpperCase() || 'U'}
                </span>
              </div>
              {/* Ê°åÈù¢ÁâàÔºöÂÆåÊï¥ÁôªÂá∫ÊåâÈàï */}
              <motion.button
                onClick={handleLogout}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="hidden sm:flex items-center space-x-2 px-3 py-2 text-sm text-[#2B3A3B] hover:text-[#4B4036] hover:bg-[#FFD59A]/20 rounded-lg transition-all duration-200"
                title="ÁôªÂá∫"
              >
                <LogOut className="w-4 h-4" />
                <span>ÁôªÂá∫</span>
              </motion.button>
              {/* ÁßªÂãïÁâàÔºöÂè™È°ØÁ§∫ÁôªÂá∫ÂúñÊ®ô */}
              <motion.button
                onClick={handleLogout}
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="sm:hidden flex items-center justify-center w-8 h-8 text-[#2B3A3B] hover:text-[#4B4036] hover:bg-[#FFD59A]/20 rounded-lg transition-all duration-200"
                title="ÁôªÂá∫"
              >
                <LogOut className="w-4 h-4" />
              </motion.button>
            </div>
          </div>
        </div>
      </nav>


      <div className="max-w-4xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8">
        {/* ËøîÂõûÊåâÈàïÂíåÊ©üÊßã‰ø°ÊÅØ */}
        <div className="mb-4 sm:mb-6">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4 mb-4">
            <motion.button
              onClick={handleBack}
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className="flex items-center gap-2 px-3 py-2 sm:px-4 bg-[#FFD59A] text-[#2B3A3B] rounded-lg hover:bg-[#EBC9A4] transition-colors text-sm sm:text-base"
            >
              <span>‚Üê</span>
              <span className="hidden sm:inline">ËøîÂõûÂÆ∂Èï∑ÈÄ£Áµê</span>
              <span className="sm:hidden">ËøîÂõû</span>
            </motion.button>
            
            <div className="flex items-center justify-between sm:justify-end space-x-2 sm:space-x-4">
              {/* Á∂ÅÂÆöÁãÄÊÖãÊåáÁ§∫Âô® */}
              <BindingStatusIndicator isBound={isStudentBound} />
              
              <div className="flex items-center space-x-2 px-2 py-1.5 sm:px-3 sm:py-2 bg-white/60 backdrop-blur-sm rounded-lg border border-[#EADBC8]">
                <Building className="w-3 h-3 sm:w-4 sm:h-4 text-[#4B4036]" />
                <span className="text-xs sm:text-sm font-medium text-[#4B4036]">{institution}</span>
              </div>
            </div>
          </div>
          
        </div>

        {/* ÂÅúÁî®Â≠∏ÁîüË≠¶Âëä */}
        {isInactiveStudent && (
          <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div className="flex items-center">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path clipRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" fillRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <h3 className="text-sm font-medium text-yellow-800">
                  Ê≠§Â≠∏ÁîüÂ∑≤ÂÅúÁî®
                </h3>
                <div className="mt-2 text-sm text-yellow-700">
                  <p>ÂÅúÁî®Êó•ÊúüÔºö{new Date(student.inactive_date).toLocaleDateString('zh-HK')}</p>
                  <p>ÂÅúÁî®ÂéüÂõ†Ôºö{student.inactive_reason}</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ÂàÜÈ†ÅÂ∞éËà™ */}
        <div className="mb-4 sm:mb-6">
          <div className="flex space-x-1 bg-[#EADBC8]/30 rounded-xl p-1 overflow-x-auto">
            {[
              { key: 'basic', label: 'Âü∫Êú¨Ë≥áÊñô', icon: UserCircle, description: 'Â≠∏ÁîüÂü∫Êú¨Ë≥áË®äÁÆ°ÁêÜ', shortLabel: 'Âü∫Êú¨' },
              { key: 'lessons', label: 'Ë™≤Á®ãË®òÈåÑ', icon: BookOpen, description: 'Ë™≤Á®ãËàáÂ≠∏ÁøíË®òÈåÑ', shortLabel: 'Ë™≤Á®ã' },
              { key: 'avatar', label: '‰∫íÂãïËßíËâ≤', icon: Sparkles, description: '3DËßíËâ≤ËàáÂ≠∏ÁøíÈÄ≤Â∫¶', shortLabel: 'ËßíËâ≤' },
              { key: 'media', label: 'Â™íÈ´îÂ∫´', icon: Camera, description: 'Ë™≤Â†ÇÂΩ±ÁâáËàáÁõ∏Áâá', shortLabel: 'Â™íÈ´î' }
            ].map(({ key, label, icon: Icon, description, shortLabel }) => (
              <motion.button
                key={key}
                onClick={() => setActiveTab(key as any)}
                className={`
                  flex items-center px-2 py-2 sm:px-4 sm:py-3 rounded-lg text-xs sm:text-sm font-medium transition-colors whitespace-nowrap flex-shrink-0
                  ${activeTab === key
                    ? 'bg-[#FFD59A] text-[#2B3A3B] shadow-sm'
                    : 'text-[#2B3A3B]/70 hover:text-[#2B3A3B] hover:bg-white/50'
                  }
                `}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
                title={description}
              >
                <Icon className="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2" />
                <span className="hidden sm:inline">{label}</span>
                <span className="sm:hidden">{shortLabel}</span>
              </motion.button>
            ))}
          </div>
        </div>

        {/* ÂàÜÈ†ÅÂÖßÂÆπ */}
        <motion.div
          key={activeTab}
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          exit={{ opacity: 0, y: -20 }}
          transition={{ duration: 0.3 }}
        >
          {/* Âü∫Êú¨Ë≥áÊñôÂàÜÈ†Å */}
          {activeTab === 'basic' && (
            <StudentBasicInfo 
              isInactive={isInactiveStudent} 
              student={student}
              onUpdate={(newData) => {
                setStudent(newData);
                // Â¶ÇÊûúÊòØË©¶Â†ÇÂ≠∏Áîü‰∏îË™≤Á®ãÊúâÊõ¥Êñ∞ÔºåËß∏ÁôºË™≤Â†ÇË≥áÊñôÈáçÊñ∞ËºâÂÖ•
                if (newData.student_type === 'Ë©¶Â†Ç' && newData.course_type !== student.course_type) {
                  setCourseUpdateTrigger(prev => prev + 1);
                }
              }}
            />
          )}

          {/* Ë™≤Á®ãË®òÈåÑÂàÜÈ†Å */}
          {activeTab === 'lessons' && student && (
            <div className="mt-2 sm:mt-4">
              {(() => {
                const lessonStudentId = isInactiveStudent ? student.original_id || student.id : student.id;
                console.log('üéØ Ê∫ñÂÇôËºâÂÖ•Ë™≤Â†ÇË≥áÊñô:', {
                  lessonStudentId,
                  isInactiveStudent,
                  studentOriginalId: student.original_id,
                  currentStudentId: student.id,
                  studentType: student.student_type,
                });
                return (
                  <StudentLessonPanel 
                    contactNumber={student.contact_number} 
                    studentId={lessonStudentId}
                    studentName={student.full_name}
                    studentType={student.student_type}
                    onCourseUpdate={handleCourseUpdate}
                    studentData={student}
                  />
                );
              })()}
            </div>
          )}

          {/* ‰∫íÂãïËßíËâ≤ÂàÜÈ†Å */}
          {activeTab === 'avatar' && student && (
            <EnhancedStudentAvatarTab 
              student={student}
              className="mt-2 sm:mt-4"
            />
          )}

          {/* Â™íÈ´îÂ∫´ÂàÜÈ†Å */}
          {activeTab === 'media' && student && (
            <>
              {console.log('üéØ ÂÇ≥ÈÅûÁµ¶ StudentMediaTimeline ÁöÑÂèÉÊï∏:', { 
                studentId: student.id, 
                studentName: student.full_name,
                studentObject: student 
              })}
              <StudentMediaTimeline 
                studentId={student.id}
                studentName={student.full_name}
                className="mt-2 sm:mt-4"
              />
            </>
          )}
        </motion.div>
        <LessonEditorModal
          lesson={editingLesson}
          mode={editingLesson ? 'edit' : 'add'}
          open={isModalOpen}
          studentId={student.id}
          onClose={() => {
            setIsModalOpen(false);
            setEditingLesson(null);
          }}
          onSaved={() => {
            setIsModalOpen(false);
            setEditingLesson(null);
          }}
        />
          </div>
        </div>
      </div>
    </div>
  );
}